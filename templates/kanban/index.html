<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban - ACB Usinagem CNC</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.1/Sortable.min.js"></script>
    <link rel="stylesheet" href="/static/css/kanban-sortable.css">
    <style>
        body {
            background-color: #f0f2f5;
        }
        .kanban-container {
            display: flex;
            overflow-x: auto;
            padding: 1rem 0;
            min-height: calc(100vh - 150px);
        }
        .kanban-column {
            min-width: 280px;
            max-width: 280px;
            margin-right: 1rem;
            background-color: #ebecf0;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }
        .kanban-column-header {
            padding: 0.75rem;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-column-body {
            padding: 0.75rem;
            flex-grow: 1;
            overflow-y: auto;
            max-height: calc(100vh - 220px);
        }
        .kanban-card {
            background-color: white;
            border-radius: 0.25rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            cursor: default;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            /* Prevenir seleção de texto durante o arrasto */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            position: relative;
        }
        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .kanban-card-header {
            font-weight: bold;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }
        .kanban-card-body {
            font-size: 0.875rem;
        }
        .kanban-card-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #6c757d;
        }
        .column-counter {
            background-color: #6c757d;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }
        .column-stats {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 5px;
        }
        .column-time {
            background-color: #17a2b8;
            color: white;
            padding: 2px 5px;
        }
        
        /* Estilos para o timer de apontamento */
        .apontamento-timer {
            font-weight: bold;
            font-size: 1em;
            color: #fff;
            background-color: #28a745;
            padding: 2px 6px;
            border-radius: 4px;
            display: none;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        /* Exibir o timer quando o status estiver ativo */
        .status-setup .status-apontamento .apontamento-timer,
        .status-producao .status-apontamento .apontamento-timer,
        .status-pausado .status-apontamento .apontamento-timer {
            display: inline-block;
        }
        
        /* Cores diferentes para cada tipo de status */
        .status-setup .apontamento-timer {
            background-color: #007bff;
        }
        
        .status-pausado .apontamento-timer {
            background-color: #ffc107;
            color: #212529;
        }
        
        /* Estilo para o campo de status */
        .status-apontamento {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        
        .status-apontamento small {
            margin-right: 5px;
        }
        
        /* Remover o indicador de status do cabeçalho */
        .status-indicador {
            display: none;
            border-radius: 3px;
            margin-right: 5px;
        }
        .column-quantity {
            background-color: #28a745;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
        }
        .item-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 0.25rem;
            margin-bottom: 0.25rem;
            background-color: #e9ecef;
            color: #495057;
        }
        .modal-xl {
            max-width: 90%;
        }
        .card-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        .card-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        .item-quantity {
            font-weight: bold;
            color: #0d6efd;
        }
        .drag-handle {
            cursor: grab;
            color: #adb5bd;
            padding: 2px 5px;
            border-radius: 3px;
            margin-right: 5px;
        }
        .drag-handle:hover {
            background-color: #f0f0f0;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        /* Estilos para o Sortable.js */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #c8ebfb;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .sortable-chosen {
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: scale(1.02);
            z-index: 100;
        }
        .sortable-drag {
            opacity: 0.8;
            transform: rotate(1deg);
        }
        .tempo-total {
            font-weight: bold;
            color: #17a2b8;
            margin-top: 5px;
            font-size: 0.8rem;
        }
        .dropdown-menu {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">ACB Usinagem CNC</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home"></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/kanban"><i class="fas fa-columns"></i> Kanban</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/apontamento/dashboard"><i class="fas fa-chart-bar"></i> Dashboard Apontamento</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/listas"><i class="fas fa-cog"></i> Listas Kanban</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/registros-mensais"><i class="fas fa-archive"></i> Registros Mensais</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-3">
        <h1 class="mb-4">Kanban ACB</h1>
        
        <div class="kanban-container">
            {% for lista in listas %}
            <div class="kanban-column" id="column-{{ lista|lower|replace(' ', '-') }}">
                <div class="kanban-column-header">
                    <span>{{ lista }}</span>
                    <span class="column-counter">{{ ordens[lista]|length }}</span>
                </div>
                <div class="column-stats">
                    {% set horas = (tempos_listas[lista] // 3600) %}
                    {% set minutos = ((tempos_listas[lista] % 3600) // 60) %}
                    {% set segundos = (tempos_listas[lista] % 60) %}
                    <span class="column-time"><i class="fas fa-clock"></i> 
                        {% if horas > 0 %}
                            {{ horas }}h {{ minutos }}:{{ segundos }}
                        {% else %}
                            {{ minutos }}:{{ segundos }}
                        {% endif %}
                    </span>
                    <span class="column-quantity"><i class="fas fa-cubes"></i> {{ quantidades_listas[lista] }}</span>
                </div>
                <div class="kanban-column-body" data-lista="{{ lista }}">
                    {% for ordem in ordens[lista] %}
                    <div class="kanban-card" data-ordem-id="{{ ordem.id }}">
                        <div class="kanban-card-header">
                            <div class="drag-handle" onclick="event.stopPropagation()">
                                <i class="fas fa-grip-lines"></i>
                            </div>
                            {% if ordem.pedidos and ordem.pedidos[0].pedido.item and ordem.pedidos[0].pedido.item.imagem_path %}
                                <img src="{{ ordem.pedidos[0].pedido.item.imagem_path }}" width="32" height="32" class="rounded me-2" alt="Imagem do item">
                            {% endif %}
                            <span class="card-title" data-ordem-id="{{ ordem.id }}">{{ ordem.numero }}</span>
                            <div class="d-flex">
                                {% if lista != 'Expedição' %}
                                    <div class="dropdown me-2">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                            id="dropdownMenuButton{{ ordem.id }}" data-bs-toggle="dropdown" 
                                            aria-expanded="false" onclick="event.stopPropagation()">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton{{ ordem.id }}">
                                        {% for lista_destino in listas %}
                                            {% if lista_destino != lista and lista_destino not in ['Entrada','Expedição'] %}
                                                <li><a class="dropdown-item btn-mover" href="#" data-ordem-id="{{ ordem.id }}" data-lista-destino="{{ lista_destino }}">Mover para {{ lista_destino }}</a></li>
                                            {% endif %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="kanban-card-body">
                            {% if ordem.pedidos %}
                                {% set total_items = 0 %}
                                {% set total_qty = 0 %}
                                {% set grouped_items = {} %}
                                {% set tem_desenho = false %}
                                {% set tem_programas = false %}
                                {% set pedido_primeiro = None %}
                                
                                {% for pedido_os in ordem.pedidos %}
                                    {% if loop.index == 1 %}
                                        {% set pedido_primeiro = pedido_os %}
                                    {% endif %}
                                    
                                    {% set item_key = pedido_os.pedido.item_id if pedido_os.pedido.item_id else pedido_os.pedido.nome_item %}
                                    {% set item_name = pedido_os.pedido.item.codigo_acb ~ ' - ' ~ pedido_os.pedido.item.nome if pedido_os.pedido.item_id else pedido_os.pedido.nome_item %}
                                    
                                    {% if pedido_os.pedido.item and pedido_os.pedido.item.desenho_path %}
                                        {% set tem_desenho = true %}
                                    {% endif %}
                                    
                                    {% if pedido_os.pedido.item and pedido_os.pedido.item.arquivos_cnc %}
                                        {% set tem_programas = true %}
                                    {% endif %}
                                    
                                    {% if item_key in grouped_items %}
                                        {% set _ = grouped_items[item_key].update({
                                            'total_qty': grouped_items[item_key].total_qty 
                                                          + pedido_os.pedido.quantidade
                                        }) %}
                                    {% else %}
                                        {% set _ = grouped_items.update({
                                            item_key: {
                                                'name': item_name,
                                                'total_qty': pedido_os.pedido.quantidade,
                                                'item': pedido_os.pedido.item if pedido_os.pedido.item_id else None
                                            }
                                        }) %}
                                    {% endif %}
                                    {% set total_items = total_items + 1 %}
                                    {% set total_qty   = total_qty   + pedido_os.pedido.quantidade %}
                                {% endfor %}
                        
                                <div class="mb-2">
                                    <span class="item-badge bg-info text-white">
                                        <i class="fas fa-cubes"></i> {{ total_items }} itens
                                    </span>
                                    <span class="item-badge bg-success text-white">
                                        <i class="fas fa-hashtag"></i> {{ total_qty }} peças
                                    </span>
                                </div>
                        
                                {% for item_key, item_data in grouped_items.items() %}
                                    {% if loop.index <= 2 %}
                                        <div class="text-truncate">
                                            <small>
                                                {{ item_data.name }}
                                                <span class="item-quantity">
                                                    ({{ item_data.total_qty }})
                                                </span>
                                            </small>
                                        </div>
                                    {% elif grouped_items|length > 2 and loop.index == 3 %}
                                        <div class="text-muted">
                                            <small>+ {{ grouped_items|length - 2 }} mais itens...</small>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                        
                                <div class="tempo-total">
                                    <i class="fas fa-clock"></i>
                                    Tempo total: {{ ordem.tempo_total_producao }}
                                </div>
                                
                                <!-- Ícones de documentos disponíveis -->
                                <div class="document-icons mt-2">
                                    {% if tem_desenho %}
                                    <span class="document-icon pdf-icon toggle-pdf" data-container-id="pdf-container-{{ ordem.id }}">
                                        <i class="fas fa-file-pdf"></i>
                                        <small class="ms-1">Desenho</small>
                                    </span>
                                    {% endif %}
                                    
                                    {% if tem_programas %}
                                    <span class="document-icon cnc-icon toggle-cnc" data-container-id="cnc-container-{{ ordem.id }}">
                                        <i class="fas fa-file-code"></i>
                                        <small class="ms-1">Programas</small>
                                    </span>
                                    {% endif %}
                                </div>
                                
                                <!-- Container de desenho (oculto por padrão) -->
                                {% if tem_desenho and pedido_primeiro and pedido_primeiro.pedido.item.desenho_path %}
                                <div id="pdf-container-{{ ordem.id }}" class="document-container pdf-container">
                                    <div class="mb-2">
                                        <strong>Desenho do Item:</strong>
                                    </div>
                                    <a href="{{ pedido_primeiro.pedido.item.desenho_path }}" class="file-link" target="_blank">
                                        <i class="fas fa-file-pdf pdf-icon"></i>
                                        Visualizar PDF
                                    </a>
                                </div>
                                {% endif %}
                                
                                <!-- Container de programas CNC (oculto por padrão) -->
                                {% if tem_programas %}
                                <div id="cnc-container-{{ ordem.id }}" class="document-container cnc-container">
                                    <div class="mb-2">
                                        <strong>Programas CNC:</strong>
                                    </div>
                                    {% for item_key, item_data in grouped_items.items() %}
                                        {% if item_data.item and item_data.item.arquivos_cnc %}
                                            {% for arquivo in item_data.item.arquivos_cnc %}
                                                <a href="/arquivos/cnc/{{ arquivo.arquivo_path }}" class="file-link" download>
                                                    <i class="fas fa-file-code cnc-icon"></i>
                                                    {{ arquivo.nome_original }}
                                                </a>
                                            {% endfor %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                        
                            {% else %}
                                <div class="text-muted"><small>Sem pedidos</small></div>
                            {% endif %}
                            
                            <!-- Botões de Apontamento -->
                            {% if acesso_kanban and lista not in ['Entrada', 'Expedição'] %}
                            <div class="apontamento-buttons mt-2 pt-2 border-top">
                                <div class="row g-1">
                                    <div class="col-6">
                                        <button class="btn btn-outline-primary btn-sm w-100" 
                                                onclick="iniciarApontamentoSetup({{ ordem.id }});"
                                                title="Iniciar Setup">
                                            <i class="fas fa-play"></i> Setup
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-outline-success btn-sm w-100" 
                                                onclick="iniciarApontamentoProducao({{ ordem.id }});"
                                                title="Iniciar Produção">
                                            <i class="fas fa-cogs"></i> Prod
                                        </button>
                                    </div>
                                    <div class="col-4">
                                        <button class="btn btn-outline-warning btn-sm w-100" 
                                                onclick="pausarApontamento({{ ordem.id }});"
                                                title="Pausar">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                    </div>
                                    <div class="col-4">
                                        <button class="btn btn-outline-info btn-sm w-100" 
                                                onclick="finalizarSetup({{ ordem.id }});"
                                                title="Finalizar Setup">
                                            <i class="fas fa-stop"></i>
                                        </button>
                                    </div>
                                    <div class="col-4">
                                        <button class="btn btn-outline-danger btn-sm w-100" 
                                                onclick="finalizarProducao({{ ordem.id }});"
                                                title="Finalizar Produção">
                                            <i class="fas fa-flag-checkered"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Status atual do apontamento -->
                                <div class="status-apontamento mt-1" id="status-{{ ordem.id }}">
                                    <small class="text-muted">Aguardando apontamento</small>
                                    <!-- Timer de apontamento será inserido aqui -->
                                    <span class="apontamento-timer" id="timer-{{ ordem.id }}">00:00:00</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

    <!-- Modal para detalhes do card -->
    <div class="modal fade" id="cardDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes da Ordem de Serviço</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts do Bootstrap e JavaScript customizado -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/kanban-sortable.js"></script>
    <script>
        function moverOrdem(ordemId, listaDestino) {
            fetch('/kanban/mover', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `ordem_id=${ordemId}&nova_lista=${listaDestino}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar mensagem de sucesso
                    alert(data.message);
                    // Recarregar a página para atualizar
                    window.location.reload();
                }
            });
        }
        
        function openCardDetails(ordemId) {
            const modal = new bootstrap.Modal(document.getElementById('cardDetailsModal'));
            modal.show();
            
            // Carregar os detalhes do card via AJAX
            fetch(`/kanban/detalhes/${ordemId}`)
                .then(response => response.text())
                .then(html => {
                    document.querySelector('#cardDetailsModal .modal-body').innerHTML = html;
                    
                    // Inicializar os elementos do formulário dentro do modal
                    document.querySelectorAll('#cardDetailsModal .btn-salvar-tempo').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const form = this.closest('form');
                            const formData = new FormData(form);
                            
                            fetch('/kanban/atualizar-tempo-real', {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Atualizar apenas a parte relevante do modal
                                    openCardDetails(ordemId);
                                }
                            });
                        });
                    });
                    
                    // Carregar logs de apontamento automaticamente após o modal ser carregado
                    console.log(`Carregando logs automaticamente para OS ${ordemId} após abertura do modal`);
                    
                    // Usar setTimeout para garantir que o DOM está completamente carregado
                    setTimeout(function() {
                        // Tentar carregar logs usando a função global
                        if (typeof carregarLogsManualmente === 'function') {
                            console.log(`Chamando carregarLogsManualmente para OS ${ordemId}`);
                            carregarLogsManualmente(ordemId);
                        } else {
                            console.error('Função carregarLogsManualmente não encontrada!');
                            
                            // Carregar logs diretamente via fetch se a função global não estiver disponível
                            const logsContainer = document.getElementById(`logs-apontamento-container-${ordemId}`);
                            if (logsContainer) {
                                fetch(`/apontamento/os/${ordemId}/logs`)
                                    .then(response => response.json())
                                    .then(data => {
                                        console.log(`Dados recebidos diretamente para OS ${ordemId}:`, data);
                                        
                                        if (data.logs && data.logs.length > 0) {
                                            let html = `<h5>Encontrados ${data.logs.length} registros</h5>`;
                                            html += '<ul class="list-group">';
                                            
                                            data.logs.forEach(log => {
                                                const dataHora = new Date(log.data_hora).toLocaleString();
                                                html += `<li class="list-group-item">${dataHora} - ${log.tipo_acao} - ${log.operador_nome || 'N/A'}</li>`;
                                            });
                                            
                                            html += '</ul>';
                                            logsContainer.innerHTML = html;
                                        } else {
                                            logsContainer.innerHTML = '<div class="alert alert-info">Nenhum registro encontrado.</div>';
                                        }
                                    })
                                    .catch(error => {
                                        console.error(`Erro ao carregar logs diretamente para OS ${ordemId}:`, error);
                                        logsContainer.innerHTML = `<div class="alert alert-danger">Erro ao carregar: ${error.message}</div>`;
                                    });
                            } else {
                                console.error(`Container de logs não encontrado para OS ${ordemId}`);
                            }
                        }
                    }, 500);
                });
        }
        
        function finalizarOS(ordemId) {
            if (confirm('Deseja finalizar esta Ordem de Serviço? Ela será movida para o registro mensal.')) {
                fetch('/kanban/finalizar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `ordem_id=${ordemId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Fechar o modal e recarregar a página
                        bootstrap.Modal.getInstance(document.getElementById('cardDetailsModal')).hide();
                        window.location.reload();
                    }
                });
            }
        }
        
        // Função para mostrar/ocultar contêiner de documentos (PDF/CNC)
        function toggleDocContainer(element, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Verificar se está visível ou oculto com getComputedStyle
            const computedStyle = window.getComputedStyle(container);
            const isHidden = computedStyle.display === 'none';
            
            // Alternar visibilidade
            if (isHidden) {
                // Mostrar o container
                container.style.cssText = 'display: block !important';
                element.classList.add('active');
            } else {
                // Esconder o container
                container.style.cssText = 'display: none !important';
                element.classList.remove('active');
            }
            
            // Prevenir propagação de eventos
            event.stopPropagation();
            return false;
        }
        
        // Função para inicializar todos os eventos nos cartões
        function initializeKanbanEvents() {
            console.log('Inicializando eventos do Kanban');
            
            // Eventos para abrir detalhes do card
            document.querySelectorAll('.card-title').forEach(function(element) {
                element.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const ordemId = this.dataset.ordemId;
                    openCardDetails(ordemId);
                });
            });
            
            // Eventos para toggle de documentos PDF e CNC
            document.querySelectorAll('.toggle-pdf, .toggle-cnc').forEach(function(element) {
                element.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const containerId = this.dataset.containerId;
                    console.log('Toggle container:', containerId);
                    toggleDocContainer(this, containerId);
                });
            });
            
            // Eventos para mover ordens entre listas
            document.querySelectorAll('.btn-mover').forEach(function(element) {
                element.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const ordemId = this.dataset.ordemId;
                    const listaDestino = this.dataset.listaDestino;
                    moverOrdem(ordemId, listaDestino);
                });
            });
            
            // Marcar os cartões como inicializados
            document.querySelectorAll('.kanban-card').forEach(function(card) {
                card.classList.add('events-initialized');
            });
        }
        
        // Inicializar eventos após o carregamento do documento
        document.addEventListener('DOMContentLoaded', function() {
            initializeKanbanEvents();
            
            // Também inicializar novamente quando o Sortable terminar uma operação de arrasto
            document.addEventListener('sortable-drop-complete', function() {
                setTimeout(initializeKanbanEvents, 100);
            });
        });
    </script>

    <!-- Modal de Apontamento -->
    <div class="modal fade" id="modalApontamento" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalApontamentoTitle">Apontamento de Produção</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formApontamento">
                        <input type="hidden" id="ordemServicoId">
                        <input type="hidden" id="tipoAcao">
                        
                        <!-- Código do Operador -->
                        <div class="mb-3">
                            <label for="codigoOperador" class="form-label">Código do Operador *</label>
                            <input type="text" class="form-control" id="codigoOperador" maxlength="4" pattern="[0-9]{4}" placeholder="0000" required>
                            <div class="form-text">Digite seu código de 4 dígitos</div>
                            <div id="operadorInfo" class="mt-1"></div>
                        </div>
                        
                        <!-- Seleção de Item -->
                        <div class="mb-3" id="divItemSelecao">
                            <label for="itemSelecao" class="form-label">Item *</label>
                            <select class="form-select" id="itemSelecao" required>
                                <option value="">Selecione o item</option>
                            </select>
                            <div class="form-text">Selecione o item específico para apontamento</div>
                        </div>
                        
                        <!-- Tipo de Trabalho -->
                        <div class="mb-3" id="divTipoTrabalho">
                            <label for="tipoTrabalho" class="form-label">Tipo de Trabalho *</label>
                            <select class="form-select" id="tipoTrabalho" required>
                                <option value="">Selecione o tipo de trabalho</option>
                            </select>
                            <div class="form-text">Tipos de trabalho do item selecionado</div>
                        </div>
                        
                        <!-- Quantidade (para início produção e pausas) -->
                        <div class="mb-3" id="divQuantidade" style="display: none;">
                            <label for="quantidade" class="form-label">Quantidade de Peças</label>
                            <input type="number" class="form-control" id="quantidade" min="0" placeholder="0">
                            <div class="form-text">Quantidade atual de peças produzidas</div>
                        </div>
                        
                        <!-- Motivo da Parada (apenas para pausas) -->
                        <div class="mb-3" id="divMotivoParada" style="display: none;">
                            <label for="motivoParada" class="form-label">Motivo da Parada *</label>
                            <select class="form-select" id="motivoParada">
                                <option value="">Selecione o motivo</option>
                                <option value="Parada para café">Parada para café</option>
                                <option value="Sem desenho">Sem desenho</option>
                                <option value="Sem ferramenta">Sem ferramenta</option>
                                <option value="Troca de ferramenta">Troca de ferramenta</option>
                                <option value="Sem material">Sem material</option>
                                <option value="Falha na operação">Falha na operação</option>
                                <option value="Manutenção não programada">Manutenção não programada</option>
                                <option value="Banheiro">Banheiro</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        
                        <!-- Observações -->
                        <div class="mb-3">
                            <label for="observacoes" class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoes" rows="2" placeholder="Observações adicionais (opcional)"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarApontamento()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts de Apontamento -->
    <script src="/static/js/apontamento-persistence.js"></script>
    <script src="/static/js/apontamento-logs.js"></script>
    
    <!-- Função global para carregar logs manualmente -->
    <script>
        // Função global para carregar logs manualmente (para debug)
        function carregarLogsManualmente(ordemId) {
            console.log(`Carregando logs manualmente para OS ${ordemId}`);
            const logsContainer = document.getElementById(`logs-apontamento-container-${ordemId}`);
            
            if (!logsContainer) {
                alert('Container de logs não encontrado!');
                return;
            }
            
            // Mostrar mensagem de carregamento
            logsContainer.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Carregando histórico via botão manual...</p>
                </div>
            `;
            
            // Fazer a requisição diretamente
            fetch(`/apontamento/os/${ordemId}/logs`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Dados recebidos:', data);
                    
                    if (data.logs && data.logs.length > 0) {
                        // Construir HTML simples para exibição dos logs
                        let html = `<h5>Encontrados ${data.logs.length} registros</h5>`;
                        html += '<ul class="list-group">';
                        
                        data.logs.forEach(log => {
                            const data = new Date(log.data_hora).toLocaleString();
                            html += `<li class="list-group-item">${data} - ${log.tipo_acao} - ${log.operador_nome || 'N/A'}</li>`;
                        });
                        
                        html += '</ul>';
                        logsContainer.innerHTML = html;
                    } else {
                        logsContainer.innerHTML = '<div class="alert alert-info">Nenhum registro encontrado.</div>';
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    logsContainer.innerHTML = `<div class="alert alert-danger">Erro ao carregar: ${error.message}</div>`;
                });
        }
    </script>
    
    <!-- Script para Apontamentos -->
    <script>
    let ordemAtualId = null;
    let tipoAcaoAtual = null;
    
    function abrirModalApontamento(tipoAcao, ordemId) {
        // Verificar se é uma ação de início (setup ou produção)
        const isInicioAcao = tipoAcao === 'inicio_setup' || tipoAcao === 'inicio_producao';
        
        // Se for uma ação de início, verificar se já existe algum apontamento ativo
        if (isInicioAcao) {
            // Verificar se há apontamentos ativos
            fetch('/apontamento/status-ativos')
                .then(response => response.json())
                .then(data => {
                    if (data.status_ativos && data.status_ativos.length > 0) {
                        // Verificar se algum dos apontamentos ativos é para esta OS
                        const apontamentoAtivo = data.status_ativos.find(status => 
                            status.ordem_servico_id === ordemId || status.ordem_id === ordemId);
                            
                        if (apontamentoAtivo) {
                            // Já existe um apontamento ativo para esta OS, continuar normalmente
                            prosseguirAbrirModal(tipoAcao, ordemId);
                        } else {
                            // Existe um apontamento ativo para outra OS
                            const osAtiva = data.status_ativos[0];
                            const mensagem = `
                                <div class="alert alert-warning">
                                    <h5><i class="fas fa-exclamation-triangle"></i> Atenção!</h5>
                                    <p>Já existe um apontamento ativo para outra Ordem de Serviço:</p>
                                    <ul>
                                        <li><strong>OS:</strong> ${osAtiva.ordem_servico_id}</li>
                                        <li><strong>Status:</strong> ${osAtiva.status_atual}</li>
                                        <li><strong>Operador:</strong> ${osAtiva.operador_nome || 'Não informado'}</li>
                                    </ul>
                                    <p>Você precisa finalizar ou pausar o apontamento ativo antes de iniciar um novo.</p>
                                </div>
                            `;
                            
                            // Exibir modal de alerta
                            const alertModal = document.getElementById('alertModal') || criarModalAlerta();
                            const alertModalBody = alertModal.querySelector('.modal-body');
                            alertModalBody.innerHTML = mensagem;
                            
                            // Exibir o modal de alerta
                            new bootstrap.Modal(alertModal).show();
                        }
                    } else {
                        // Não há apontamentos ativos, prosseguir normalmente
                        prosseguirAbrirModal(tipoAcao, ordemId);
                    }
                })
                .catch(error => {
                    console.error('Erro ao verificar apontamentos ativos:', error);
                    // Em caso de erro, permitir prosseguir
                    prosseguirAbrirModal(tipoAcao, ordemId);
                });
        } else {
            // Não é uma ação de início, prosseguir normalmente
            prosseguirAbrirModal(tipoAcao, ordemId);
        }
    }
    
    // Função auxiliar para criar um modal de alerta caso não exista
    function criarModalAlerta() {
        const modalHtml = `
            <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title" id="alertModalLabel">Aviso</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Conteúdo dinâmico aqui -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Adicionar o modal ao corpo do documento
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer.firstElementChild);
        
        return document.getElementById('alertModal');
    }
    
    // Função para prosseguir com a abertura do modal de apontamento
    function prosseguirAbrirModal(tipoAcao, ordemId) {
        ordemAtualId = ordemId;
        tipoAcaoAtual = tipoAcao;
        
        // Configurar o modal baseado no tipo de ação
        configurarModalPorTipo(tipoAcao);
        
        // Limpar formulário
        document.getElementById('formApontamento').reset();
        document.getElementById('ordemServicoId').value = ordemId;
        document.getElementById('tipoAcao').value = tipoAcao;
        document.getElementById('operadorInfo').innerHTML = '';
        
        // Carregar itens da OS primeiro
        carregarItensOS(ordemId);
        
        // Abrir modal
        new bootstrap.Modal(document.getElementById('modalApontamento')).show();
    }
    
    function configurarModalPorTipo(tipoAcao) {
        const title = document.getElementById('modalApontamentoTitle');
        const divQuantidade = document.getElementById('divQuantidade');
        const divMotivoParada = document.getElementById('divMotivoParada');
        const quantidade = document.getElementById('quantidade');
        const motivoParada = document.getElementById('motivoParada');
        
        // Reset
        divQuantidade.style.display = 'none';
        divMotivoParada.style.display = 'none';
        quantidade.required = false;
        motivoParada.required = false;
        
        switch(tipoAcao) {
            case 'inicio_setup':
                title.textContent = 'Iniciar Setup';
                break;
            case 'fim_setup':
                title.textContent = 'Finalizar Setup';
                break;
            case 'inicio_producao':
                title.textContent = 'Iniciar Produção';
                divQuantidade.style.display = 'block';
                quantidade.placeholder = 'Quantidade inicial (opcional)';
                break;
            case 'pausa':
                title.textContent = 'Pausar Produção';
                divQuantidade.style.display = 'block';
                divMotivoParada.style.display = 'block';
                quantidade.required = true;
                motivoParada.required = true;
                quantidade.placeholder = 'Quantidade atual de peças';
                break;
            case 'fim_producao':
                title.textContent = 'Finalizar Produção';
                divQuantidade.style.display = 'block';
                quantidade.required = true;
                quantidade.placeholder = 'Quantidade final produzida';
                break;
        }
    }
    
    function carregarItensOS(ordemId) {
        fetch(`/apontamento/os/${ordemId}/itens`)
            .then(response => response.json())
            .then(data => {
                const selectItem = document.getElementById('itemSelecao');
                const selectTipo = document.getElementById('tipoTrabalho');
                
                // Limpar dropdowns
                selectItem.innerHTML = '<option value="">Selecione o item</option>';
                selectTipo.innerHTML = '<option value="">Selecione o tipo de trabalho</option>';
                
                if (data.success && data.itens && data.itens.length > 0) {
                    data.itens.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = `${item.codigo_acb} - ${item.nome}`;
                        selectItem.appendChild(option);
                    });
                    
                    // Se há apenas um item, selecionar automaticamente
                    if (data.itens.length === 1) {
                        selectItem.value = data.itens[0].id;
                        carregarTiposTrabalhoItem(data.itens[0].id);
                    }
                } else {
                    mostrarAlerta('Erro: Nenhum item encontrado para esta OS', 'error');
                }
            })
            .catch(error => {
                console.error('Erro ao carregar itens:', error);
                mostrarAlerta('Erro ao carregar itens da OS', 'error');
            });
    }
    
    function carregarTiposTrabalhoItem(itemId) {
        if (!itemId) {
            const select = document.getElementById('tipoTrabalho');
            select.innerHTML = '<option value="">Selecione o tipo de trabalho</option>';
            return;
        }
        
        fetch(`/apontamento/item/${itemId}/tipos-trabalho`)
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('tipoTrabalho');
                select.innerHTML = '<option value="">Selecione o tipo de trabalho</option>';
                
                if (data.success) {
                    data.tipos_trabalho.forEach(tipo => {
                        const option = document.createElement('option');
                        option.value = tipo.id;
                        option.textContent = tipo.nome;
                        if (tipo.descricao) {
                            option.title = tipo.descricao;
                        }
                        select.appendChild(option);
                    });
                } else {
                    mostrarAlerta('Erro: ' + data.message, 'warning');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                mostrarAlerta('Erro ao carregar tipos de trabalho', 'error');
            });
    }
    
    // Event listener para quando o item for selecionado
    document.getElementById('itemSelecao').addEventListener('change', function(e) {
        const itemId = e.target.value;
        carregarTiposTrabalhoItem(itemId);
    });
    
    // Validação do código do operador em tempo real
    document.getElementById('codigoOperador').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Apenas dígitos
        if (value.length > 4) value = value.substr(0, 4);
        e.target.value = value;
        
        if (value.length === 4) {
            validarOperador(value);
        } else {
            document.getElementById('operadorInfo').innerHTML = '';
        }
    });
    
    function validarOperador(codigo) {
        fetch('/apontamento/validar-codigo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ codigo: codigo })
        })
        .then(response => response.json())
        .then(data => {
            const infoDiv = document.getElementById('operadorInfo');
            if (data.valid) {
                infoDiv.innerHTML = `<small class="text-success"><i class="fas fa-check"></i> ${data.message}</small>`;
            } else {
                infoDiv.innerHTML = `<small class="text-danger"><i class="fas fa-times"></i> ${data.message}</small>`;
            }
        })
        .catch(error => {
            console.error('Erro:', error);
        });
    }
    
    function salvarApontamento() {
        const form = document.getElementById('formApontamento');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Validar se item foi selecionado
        const itemId = document.getElementById('itemSelecao').value;
        if (!itemId) {
            mostrarAlerta('Por favor, selecione um item antes de continuar', 'error');
            return;
        }
        
        const dados = {
            ordem_servico_id: document.getElementById('ordemServicoId').value,
            item_id: itemId,
            tipo_acao: document.getElementById('tipoAcao').value,
            codigo_operador: document.getElementById('codigoOperador').value,
            trabalho_id: document.getElementById('tipoTrabalho').value,
            quantidade: document.getElementById('quantidade').value || null,
            motivo_parada: document.getElementById('motivoParada').value || null,
            observacoes: document.getElementById('observacoes').value || null
        };
        
        fetch('/apontamento/registrar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(dados)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAlerta(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalApontamento')).hide();
                // Atualizar status do cartão
                atualizarStatusCartao(ordemAtualId, data.status);
            } else {
                mostrarAlerta(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            mostrarAlerta('Erro ao registrar apontamento', 'error');
        });
    }
    
    function atualizarStatusCartao(ordemId, status) {
        // Atualizar status no card miniatura (kanban-card)
        const card = document.querySelector(`.kanban-card[data-ordem-id="${ordemId}"]`);
        if (!card) return;
        
        // Remover classes de status anteriores
        card.classList.remove('status-setup', 'status-producao', 'status-pausado', 'status-finalizado', 'status-setup-concluido');
        
        // Adicionar classe de status atual
        let statusClass = '';
        let isActiveStatus = false;
        let bgClass = '';
        let statusText = status;
        
        switch(status) {
            case 'Setup em andamento':
                statusClass = 'status-setup';
                bgClass = 'bg-primary';
                statusText = 'Setup em andamento';
                isActiveStatus = true;
                break;
            case 'Produção em andamento':
                statusClass = 'status-producao';
                bgClass = 'bg-success';
                statusText = 'Produção em andamento';
                isActiveStatus = true;
                break;
            case 'Pausado':
                statusClass = 'status-pausado';
                bgClass = 'bg-warning';
                statusText = 'Pausado';
                isActiveStatus = true;
                break;
            case 'Setup concluído':
                statusClass = 'status-setup-concluido';
                bgClass = 'bg-info';
                statusText = 'Setup concluído';
                break;
            case 'Finalizado':
                statusClass = 'status-finalizado';
                bgClass = 'bg-secondary';
                statusText = 'Finalizado';
                break;
            default:
                bgClass = 'bg-light';
                statusText = 'Aguardando apontamento';
                break;
        }
        
        // Adicionar classe de status ao card
        if (statusClass) card.classList.add(statusClass);
        
        // Atualizar o campo de status no rodapé do card
        const statusElement = card.querySelector('.status-apontamento');
        if (statusElement) {
            const statusSmall = statusElement.querySelector('small');
            if (statusSmall) {
                statusSmall.className = '';
                statusSmall.classList.add(bgClass, 'text-white', 'p-1', 'rounded');
                statusSmall.textContent = statusText;
            }
            
            // Atualizar ou criar o timer de apontamento
            let timerElement = statusElement.querySelector('.apontamento-timer');
            if (!timerElement) {
                timerElement = document.createElement('span');
                timerElement.className = 'apontamento-timer';
                timerElement.id = `timer-${ordemId}`;
                statusElement.appendChild(timerElement);
            }
            
            // Se o status for ativo, garantir que o timer seja visível
            if (isActiveStatus) {
                timerElement.style.display = 'inline-block';
                
                // Se não houver timer ativo, iniciar um novo
                if (!window.timers || !window.timers[ordemId]) {
                    // Verificar se a função iniciarTimerApontamento existe
                    if (typeof iniciarTimerApontamento === 'function') {
                        iniciarTimerApontamento(ordemId, statusClass);
                    }
                }
            } else {
                // Se não for um status ativo, parar o timer e ocultar o elemento
                if (typeof pararTimerApontamento === 'function') {
                    pararTimerApontamento(ordemId);
                }
                timerElement.style.display = 'none';
            }
        }
        
        // Atualizar também o status no modal de detalhes, se estiver aberto
        const modalStatusElement = document.getElementById(`status-modal-${ordemId}`);
        if (modalStatusElement) {
            modalStatusElement.innerHTML = `<small class="${bgClass} text-white p-1 rounded">${statusText}</small>`;
        }
        
        // Salvar o status atual no localStorage para persistência local
        try {
            const statusData = JSON.parse(localStorage.getItem('apontamento_status') || '{}');
            statusData[ordemId] = {
                status: status,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('apontamento_status', JSON.stringify(statusData));
        } catch (e) {
            console.error('Erro ao salvar status no localStorage:', e);
        }
    }
    
    function mostrarAlerta(mensagem, tipo) {
        const alertClass = tipo === 'success' ? 'alert-success' : 'alert-danger';
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        const container = document.querySelector('.container-fluid');
        container.insertAdjacentHTML('afterbegin', alertHtml);
        
        // Auto-remover após 5 segundos
        setTimeout(() => {
            const alert = container.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    }
    
    // Funções intermediárias para evitar problemas de sintaxe
    function iniciarApontamentoSetup(ordemId) {
        abrirModalApontamento('inicio_setup', ordemId);
    }
    
    function iniciarApontamentoProducao(ordemId) {
        abrirModalApontamento('inicio_producao', ordemId);
    }
    
    function pausarApontamento(ordemId) {
        abrirModalApontamento('pausa', ordemId);
    }
    
    function finalizarSetup(ordemId) {
        abrirModalApontamento('fim_setup', ordemId);
    }
    
    function finalizarProducao(ordemId) {
        abrirModalApontamento('fim_producao', ordemId);
    }
    </script>

</body>
</html>
