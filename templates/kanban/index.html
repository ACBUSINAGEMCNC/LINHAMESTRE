<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban - ACB Usinagem CNC</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.1/Sortable.min.js"></script>
    <link rel="stylesheet" href="/static/css/kanban-sortable.css">
    <style>
        body {
            background-color: #f0f2f5;
        }
        .kanban-container {
            display: flex;
            overflow-x: auto;
            padding: 1rem 0;
            min-height: calc(100vh - 150px);
        }
        .kanban-column {
            min-width: 280px;
            max-width: 280px;
            margin-right: 1rem;
            background-color: #ebecf0;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }
        .kanban-column-header {
            padding: 0.75rem;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-column-body {
            padding: 0.75rem;
            flex-grow: 1;
            overflow-y: auto;
            max-height: calc(100vh - 220px);
        }
        .kanban-card {
            background-color: white;
            border-radius: 0.25rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            cursor: default;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            /* Prevenir seleção de texto durante o arrasto */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            position: relative;
        }
        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .kanban-card-header {
            font-weight: bold;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }
        .kanban-card-body {
            font-size: 0.875rem;
        }
        .kanban-card-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #6c757d;
        }
        .column-counter {
            background-color: #6c757d;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }
        .column-stats {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 5px;
        }
        .column-time {
            background-color: #17a2b8;
            color: white;
            padding: 2px 5px;
        }
        
        /* Estilos para o timer de apontamento */
        .apontamento-timer {
            font-weight: bold;
            font-size: 1em;
            color: #fff;
            background-color: #28a745;
            padding: 2px 6px;
            border-radius: 4px;
            display: none;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        /* Exibir o timer quando o status estiver ativo */
        .status-setup .status-apontamento .apontamento-timer,
        .status-producao .status-apontamento .apontamento-timer,
        .status-pausado .status-apontamento .apontamento-timer {
            display: inline-block;
        }
        
        /* Cores diferentes para cada tipo de status */
        .status-setup .apontamento-timer {
            background-color: #007bff;
        }
        
        .status-pausado .apontamento-timer {
            background-color: #ffc107;
            color: #212529;
        }
        
        /* Estilo para o campo de status */
        .status-apontamento {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        
        .status-apontamento small {
            margin-right: 5px;
        }
        /* Chips por trabalho (tipo + timer) */
        .apontamento-chip {
            display: inline-block;
            background-color: #e9ecef;
            color: #212529;
            padding: 6px 8px;
            border-radius: 6px;
            margin-right: 6px;
            margin-top: 4px;
            line-height: 1.15;
        }
        .apontamento-chip .chip-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .apontamento-chip .chip-col {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 120px;
        }
        .apontamento-chip .chip-title { font-weight: 600; }
        .apontamento-chip .chip-op { opacity: 0.9; }
        .apontamento-chip .chip-motivo { display: block; margin-top: 2px; opacity: 0.95; }
        .apontamento-chip .apontamento-timer { margin-left: auto; padding: 2px 6px; border-radius: 4px; font-weight: 700; }
        /* Cores por tipo de status no chip */
        .apontamento-chip.chip-setup {
            background-color: #0d6efd; /* azul bootstrap */
            color: #fff;
        }
        .apontamento-chip.chip-setup .apontamento-timer { background-color: rgba(255,255,255,0.2); }
        .apontamento-chip.chip-producao {
            background-color: #198754; /* verde bootstrap */
            color: #fff;
        }
        .apontamento-chip.chip-producao .apontamento-timer { background-color: rgba(255,255,255,0.2); }
        .apontamento-chip.chip-pausa {
            background-color: #ffc107; /* amarelo */
            color: #212529;
        }
        .apontamento-chip.chip-pausa .apontamento-timer { background-color: rgba(0,0,0,0.1); }
        
        /* Remover o indicador de status do cabeçalho */
        .status-indicador {
            display: none;
            border-radius: 3px;
            margin-right: 5px;
        }
        .column-quantity {
            background-color: #28a745;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
        }
        /* .item-badge (DEPRECATED) substituída por .metric-badge em .card-metrics */
        .modal-xl {
            max-width: 90%;
        }
        .card-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        .card-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        .item-quantity {
            font-weight: bold;
            color: #0d6efd;
        }
        .drag-handle {
            cursor: grab;
            color: #adb5bd;
            padding: 2px 5px;
            border-radius: 3px;
            margin-right: 5px;
        }
        .drag-handle:hover {
            background-color: #f0f0f0;
        }
        .drag-handle:active {
            cursor: grabbing;
        }
        /* Estilos para o Sortable.js */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #c8ebfb;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .sortable-chosen {
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: scale(1.02);
            z-index: 100;
        }
        .sortable-drag {
            opacity: 0.8;
            transform: rotate(1deg);
        }
        /* .tempo-total (DEPRECATED) consolidado em .metric-badge.metric-tempo */
        /* Métricas compactas do card (itens, peças, tempo) */
        .card-metrics {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            margin-bottom: 6px;
        }
        .metric-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
        }
        .metric-badge i { font-size: 0.9em; opacity: 0.85; }
        .metric-items { background-color: #0dcaf0; color: #0b2239; }
        .metric-pecas { background-color: #198754; color: #fff; }
        .metric-tempo { background-color: #f1f3f5; color: #0d6efd; border: 1px solid #dee2e6; }
        .dropdown-menu {
            max-height: 300px;
            overflow-y: auto;
        }
        /* Quantidades por trabalho (QPT) */
        .qpt-list { margin: 4px 0 0; padding: 0; }
        .qpt-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 4px 8px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
            margin-bottom: 4px;
        }
        .qpt-item:hover { background: #f1f3f5; }
        .qpt-label { font-size: 0.80rem; color: #495057; }
        .qpt-itemcode { color: #6c757d; font-weight: 500; }
        .qpt-qty { font-size: 0.75rem; background: #e2e3e5 !important; color: #343a40; }
        /* Itens da OS (nome + quantidade) */
        .os-item-list { margin: 4px 0 0; padding: 0; }
        .os-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 4px 8px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #ffffff;
            margin-bottom: 4px;
        }
        .os-item:hover { background: #f8f9fa; }
        .os-item-name { font-size: 0.85rem; color: #212529; font-weight: 500; }
        .os-item-qty { font-size: 0.75rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">ACB Usinagem CNC</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home"></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/kanban"><i class="fas fa-columns"></i> Kanban</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/apontamento/dashboard"><i class="fas fa-chart-bar"></i> Dashboard Apontamento</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/listas"><i class="fas fa-cog"></i> Listas Kanban</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/registros-mensais"><i class="fas fa-archive"></i> Registros Mensais</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-3">
        <h1 class="mb-4">Kanban ACB</h1>
        
        <div class="kanban-container">
            {% for lista in listas %}
            <div class="kanban-column" id="column-{{ lista|lower|replace(' ', '-') }}">
                <div class="kanban-column-header">
                    <span>{{ lista }}</span>
                    <span class="column-counter">{{ ordens[lista]|length }}</span>
                </div>
                <div class="column-stats">
                    {% set horas = (tempos_listas[lista] // 3600) %}
                    {% set minutos = ((tempos_listas[lista] % 3600) // 60) %}
                    {% set segundos = (tempos_listas[lista] % 60) %}
                    <span class="column-time"><i class="fas fa-clock"></i> 
                        {% if horas > 0 %}
                            {{ horas }}h {{ minutos }}:{{ segundos }}
                        {% else %}
                            {{ minutos }}:{{ segundos }}
                        {% endif %}
                    </span>
                    <span class="column-quantity"><i class="fas fa-cubes"></i> {{ quantidades_listas[lista] }}</span>
                </div>
                <div class="kanban-column-body" data-lista="{{ lista }}">
                    {% for ordem in ordens[lista] %}
                    <div class="kanban-card" data-ordem-id="{{ ordem.id }}">
                        <div class="kanban-card-header">
                            <div class="drag-handle" onclick="event.stopPropagation()">
                                <i class="fas fa-grip-lines"></i>
                            </div>
                            {% if ordem.pedidos and ordem.pedidos[0].pedido.item and ordem.pedidos[0].pedido.item.imagem_path %}
                                <img src="{{ ordem.pedidos[0].pedido.item.imagem_path }}" width="32" height="32" class="rounded me-2" alt="Imagem do item">
                            {% endif %}
                            <span class="card-title" data-ordem-id="{{ ordem.id }}">{{ ordem.numero }}</span>
                            <div class="d-flex">
                                {% if lista != 'Expedição' %}
                                    <div class="dropdown me-2">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                            id="dropdownMenuButton{{ ordem.id }}" data-bs-toggle="dropdown" 
                                            aria-expanded="false" onclick="event.stopPropagation()">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton{{ ordem.id }}">
                                        {% for lista_destino in listas %}
                                            {% if lista_destino != lista and lista_destino not in ['Entrada','Expedição'] %}
                                                <li><a class="dropdown-item btn-mover" href="#" data-ordem-id="{{ ordem.id }}" data-lista-destino="{{ lista_destino }}">Mover para {{ lista_destino }}</a></li>
                                            {% endif %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="kanban-card-body">
                            {% if ordem.pedidos %}
                                {% set total_items = 0 %}
                                {% set total_qty = 0 %}
                                {% set grouped_items = {} %}
                                {% set tem_desenho = false %}
                                {% set tem_programas = false %}
                                {% set pedido_primeiro = None %}
                                
                                {% for pedido_os in ordem.pedidos %}
                                    {% if loop.index == 1 %}
                                        {% set pedido_primeiro = pedido_os %}
                                    {% endif %}
                                    
                                    {% set item_key = pedido_os.pedido.item_id if pedido_os.pedido.item_id else pedido_os.pedido.nome_item %}
                                    {% set item_name = pedido_os.pedido.item.codigo_acb ~ ' - ' ~ pedido_os.pedido.item.nome if pedido_os.pedido.item_id else pedido_os.pedido.nome_item %}
                                    
                                    {% if pedido_os.pedido.item and pedido_os.pedido.item.desenho_path %}
                                        {% set tem_desenho = true %}
                                    {% endif %}
                                    
                                    {% if pedido_os.pedido.item and pedido_os.pedido.item.arquivos_cnc %}
                                        {% set tem_programas = true %}
                                    {% endif %}
                                    
                                    {% if item_key in grouped_items %}
                                        {% set _ = grouped_items[item_key].update({
                                            'total_qty': grouped_items[item_key].total_qty 
                                                          + pedido_os.pedido.quantidade
                                        }) %}
                                    {% else %}
                                        {% set _ = grouped_items.update({
                                            item_key: {
                                                'name': item_name,
                                                'total_qty': pedido_os.pedido.quantidade,
                                                'item': pedido_os.pedido.item if pedido_os.pedido.item_id else None
                                            }
                                        }) %}
                                    {% endif %}
                                {% endfor %}

                                <div class="document-icons">
                                    {% if tem_desenho %}
                                    <span class="document-icon pdf-icon toggle-pdf" data-container-id="pdf-container-{{ ordem.id }}">
                                        <i class="fas fa-file-pdf"></i>
                                        <small class="ms-1">Desenho</small>
                                    </span>
                                    {% endif %}
                                    {% if tem_programas %}
                                    <span class="document-icon cnc-icon toggle-cnc" data-container-id="cnc-container-{{ ordem.id }}">
                                        <i class="fas fa-file-code"></i>
                                        <small class="ms-1">Programas</small>
                                    </span>
                                    {% endif %}
                                </div>
                                
                                <!-- Container de desenho (oculto por padrão) -->
                                {% if tem_desenho and pedido_primeiro and pedido_primeiro.pedido.item.desenho_path %}
                                <div id="pdf-container-{{ ordem.id }}" class="document-container pdf-container">
                                    <div class="mb-2">
                                        <strong>Desenho do Item:</strong>
                                    </div>
                                    <a href="{{ pedido_primeiro.pedido.item.desenho_path }}" class="file-link" target="_blank">
                                        <i class="fas fa-file-pdf pdf-icon"></i>
                                        Visualizar PDF
                                    </a>
                                </div>
                                {% endif %}
                                
                                <!-- Container de programas CNC (oculto por padrão) -->
                                {% if tem_programas %}
                                <div id="cnc-container-{{ ordem.id }}" class="document-container cnc-container">
                                    <div class="mb-2">
                                        <strong>Programas CNC:</strong>
                                    </div>
                                    {% for item_key, item_data in grouped_items.items() %}
                                        {% if item_data.item and item_data.item.arquivos_cnc %}
                                            {% for arquivo in item_data.item.arquivos_cnc %}
                                                <a href="/arquivos/cnc/{{ arquivo.arquivo_path }}" class="file-link" download>
                                                    <i class="fas fa-file-code cnc-icon"></i>
                                                    {{ arquivo.nome_original }}
                                                </a>
                                            {% endfor %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                        
                            {% else %}
                                <div class="text-muted"><small>Sem pedidos</small></div>
                             {% endif %}
                             
                            <!-- Itens da OS: nome do item + quantidade -->
                            {% if grouped_items and grouped_items|length > 0 %}
                            <div class="os-items mt-1">
                                <div class="small text-muted">Itens da OS</div>
                                <ul class="os-item-list list-unstyled mb-1">
                                    {% for item_key, item_data in grouped_items.items() %}
                                    <li class="os-item">
                                        <span class="os-item-name">{{ item_data.name }}</span>
                                        <span class="badge rounded-pill bg-primary os-item-qty" title="Quantidade do item">{{ item_data.total_qty }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                            <!-- Quantidades por trabalho (sempre visível) -->
                            <div class="qtd-por-trabalho mt-1" id="qtd-por-trabalho-{{ ordem.id }}">
                                <div class="small text-muted">Quantidades por trabalho</div>
                                <ul class="qpt-list list-unstyled mb-1">
                                    <li class="qpt-item">
                                        <span class="qpt-label">-</span>
                                        <span class="badge rounded-pill bg-secondary qpt-qty" title="Último apontamento">-</span>
                                    </li>
                                </ul>
                            </div>

                            <!-- Botões de Apontamento -->
                            {% if acesso_kanban and lista not in ['Entrada', 'Expedição'] %}
                            <div class="apontamento-buttons mt-2 pt-2 border-top">
                                <div class="row g-1">
                                    <!-- Grupo Setup -->
                                    <div class="col-6">
                                        <button class="btn btn-outline-primary btn-sm w-100 apontamento-btn" 
                                                data-acao="inicio_setup"
                                                data-ordem-id="{{ ordem.id }}"
                                                onclick="iniciarApontamentoSetup(this.dataset.ordemId);"
                                                title="Iniciar Setup">
                                            <i class="fas fa-play"></i> Setup
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-outline-info btn-sm w-100 apontamento-btn" 
                                                data-acao="fim_setup"
                                                data-ordem-id="{{ ordem.id }}"
                                                onclick="finalizarSetup(this.dataset.ordemId);"
                                                title="Finalizar Setup">
                                            <i class="fas fa-stop"></i> Fim Setup
                                        </button>
                                    </div>

                                    <!-- Grupo Produção -->
                                    <div class="col-6">
                                        <button class="btn btn-outline-success btn-sm w-100 apontamento-btn" 
                                                data-acao="inicio_producao"
                                                data-ordem-id="{{ ordem.id }}"
                                                onclick="iniciarApontamentoProducao(this.dataset.ordemId);"
                                                title="Iniciar Produção">
                                            <i class="fas fa-cogs"></i> Produção
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-outline-warning btn-sm w-100 apontamento-btn" 
                                                data-acao="pausa"
                                                data-ordem-id="{{ ordem.id }}"
                                                onclick="pausarApontamento(this.dataset.ordemId);"
                                                title="Pausar produção">
                                            <i class="fas fa-pause"></i> Pausa
                                        </button>
                                    </div>
                                    <div class="col-12">
                                        <button class="btn btn-outline-danger btn-sm w-100 apontamento-btn" 
                                                data-acao="stop"
                                                data-ordem-id="{{ ordem.id }}"
                                                onclick="pararApontamento(this.dataset.ordemId);"
                                                title="Stop (fim de turno / parada entre turnos)">
                                            <i class="fas fa-stop"></i> Stop
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Status atual do apontamento -->
                                <div class="status-apontamento mt-1" id="status-{{ ordem.id }}">
                                    <small class="text-muted">Aguardando apontamento</small>
                                    <!-- Timer de apontamento será inserido aqui -->
                                    <span class="apontamento-timer" id="timer-{{ ordem.id }}">00:00:00</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

    <!-- Modal para detalhes do card -->
    <div class="modal fade" id="cardDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes da Ordem de Serviço</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts do Bootstrap e JavaScript customizado -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/kanban-sortable.js"></script>
    <script>
        function moverOrdem(ordemId, listaDestino) {
            fetch('/kanban/mover', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `ordem_id=${ordemId}&nova_lista=${listaDestino}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar mensagem de sucesso
                    alert(data.message);
                    // Recarregar a página para atualizar
                    window.location.reload();
                }
            });
        }
        
        function openCardDetails(ordemId) {
            const modal = new bootstrap.Modal(document.getElementById('cardDetailsModal'));
            modal.show();
            
            // Carregar os detalhes do card via AJAX
            fetch(`/kanban/detalhes/${ordemId}`)
                .then(response => response.text())
                .then(html => {
                    document.querySelector('#cardDetailsModal .modal-body').innerHTML = html;
                    
                    // Inicializar os elementos do formulário dentro do modal
                    document.querySelectorAll('#cardDetailsModal .btn-salvar-tempo').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const form = this.closest('form');
                            const formData = new FormData(form);
                            
                            fetch('/kanban/atualizar-tempo-real', {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Atualizar apenas a parte relevante do modal
                                    openCardDetails(ordemId);
                                }
                            });
                        });
                    });
                    
                    // Carregar logs de apontamento automaticamente após o modal ser carregado
                    console.log(`Carregando logs automaticamente para OS ${ordemId} após abertura do modal`);
                    
                    // Usar setTimeout para garantir que o DOM está completamente carregado
                    setTimeout(function() {
                        // Tentar carregar logs usando a função global
                        if (typeof carregarLogsManualmente === 'function') {
                            console.log(`Chamando carregarLogsManualmente para OS ${ordemId}`);
                            carregarLogsManualmente(ordemId);
                        } else {
                            console.error('Função carregarLogsManualmente não encontrada!');
                            
                            // Carregar logs diretamente via fetch se a função global não estiver disponível
                            const logsContainer = document.getElementById(`logs-apontamento-container-${ordemId}`);
                            if (logsContainer) {
                                fetch(`/apontamento/os/${ordemId}/logs`)
                                    .then(response => response.json())
                                    .then(data => {
                                        console.log(`Dados recebidos diretamente para OS ${ordemId}:`, data);
                                        
                                        if (data.logs && data.logs.length > 0) {
                                            let html = `<h5>Encontrados ${data.logs.length} registros</h5>`;
                                            html += '<ul class="list-group">';
                                            
                                            data.logs.forEach(log => {
                                                const dataHora = new Date(log.data_hora).toLocaleString();
                                                html += `<li class="list-group-item">${dataHora} - ${log.tipo_acao} - ${log.operador_nome || 'N/A'}</li>`;
                                            });
                                            
                                            html += '</ul>';
                                            logsContainer.innerHTML = html;
                                        } else {
                                            logsContainer.innerHTML = '<div class="alert alert-info">Nenhum registro encontrado.</div>';
                                        }
                                    })
                                    .catch(error => {
                                        console.error(`Erro ao carregar logs diretamente para OS ${ordemId}:`, error);
                                        logsContainer.innerHTML = `<div class="alert alert-danger">Erro ao carregar: ${error.message}</div>`;
                                    });
                            } else {
                                console.error(`Container de logs não encontrado para OS ${ordemId}`);
                            }
                        }
                    }, 500);
                });
        }
        
        function finalizarOS(ordemId) {
            if (confirm('Deseja finalizar esta Ordem de Serviço? Ela será movida para o registro mensal.')) {
                fetch('/kanban/finalizar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `ordem_id=${ordemId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Fechar o modal e recarregar a página
                        bootstrap.Modal.getInstance(document.getElementById('cardDetailsModal')).hide();
                        window.location.reload();
                    }
                });
            }
        }
        
        // Função para mostrar/ocultar contêiner de documentos (PDF/CNC)
        function toggleDocContainer(element, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Verificar se está visível ou oculto com getComputedStyle
            const computedStyle = window.getComputedStyle(container);
            const isHidden = computedStyle.display === 'none';
            
            // Alternar visibilidade
            if (isHidden) {
                // Mostrar o container
                container.style.cssText = 'display: block !important';
                element.classList.add('active');
            } else {
                // Esconder o container
                container.style.cssText = 'display: none !important';
                element.classList.remove('active');
            }
            
            // Prevenir propagação de eventos
            event.stopPropagation();
            return false;
        }
        
        // Função para inicializar todos os eventos nos cartões
        function initializeKanbanEvents() {
            console.log('Inicializando eventos do Kanban');
            
            // Eventos para abrir detalhes do card
            document.querySelectorAll('.card-title').forEach(function(element) {
                element.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const ordemId = this.dataset.ordemId;
                    openCardDetails(ordemId);
                });
            });
            
            // Eventos para toggle de documentos PDF e CNC
            document.querySelectorAll('.toggle-pdf, .toggle-cnc').forEach(function(element) {
                element.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const containerId = this.dataset.containerId;
                    console.log('Toggle container:', containerId);
                    toggleDocContainer(this, containerId);
                });
            });
            
            // Eventos para mover ordens entre listas
            document.querySelectorAll('.btn-mover').forEach(function(element) {
                element.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const ordemId = this.dataset.ordemId;
                    const listaDestino = this.dataset.listaDestino;
                    moverOrdem(ordemId, listaDestino);
                });
            });
            
            // Marcar os cartões como inicializados
            document.querySelectorAll('.kanban-card').forEach(function(card) {
                card.classList.add('events-initialized');
            });
        }
        
        // Inicializar eventos após o carregamento do documento
        document.addEventListener('DOMContentLoaded', function() {
            initializeKanbanEvents();
            
            // Também inicializar novamente quando o Sortable terminar uma operação de arrasto
            document.addEventListener('sortable-drop-complete', function() {
                setTimeout(initializeKanbanEvents, 100);
            });
        });
    </script>

    <!-- Modal de Apontamento -->
    <div class="modal fade" id="modalApontamento" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalApontamentoTitle">Apontamento de Produção</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formApontamento">
                        <input type="hidden" id="ordemServicoId">
                        <input type="hidden" id="tipoAcao">
                        
                        <!-- Código do Operador -->
                        <div class="mb-3">
                            <label for="codigoOperador" class="form-label">Código do Operador *</label>
                            <input type="text" class="form-control" id="codigoOperador" maxlength="4" pattern="[0-9]{4}" placeholder="0000" required>
                            <div class="form-text">Digite seu código de 4 dígitos</div>
                            <div id="operadorInfo" class="mt-1"></div>
                        </div>
                        
                        <!-- Seleção de Item -->
                        <div class="mb-3" id="divItemSelecao">
                            <label for="itemSelecao" class="form-label">Item *</label>
                            <select class="form-select" id="itemSelecao" required>
                                <option value="">Selecione o item</option>
                            </select>
                            <div class="form-text">Selecione o item específico para apontamento</div>
                        </div>
                        
                        <!-- Tipo de Trabalho -->
                        <div class="mb-3" id="divTipoTrabalho">
                            <label for="tipoTrabalho" class="form-label">Tipo de Trabalho *</label>
                            <select class="form-select" id="tipoTrabalho" required>
                                <option value="">Selecione o tipo de trabalho</option>
                            </select>
                            <div class="form-text">Tipos de trabalho do item selecionado</div>
                        </div>
                        
                        <!-- Quantidade (para início produção e pausas) -->
                        <div class="mb-3" id="divQuantidade" style="display: none;">
                            <label for="quantidade" class="form-label">Quantidade de Peças</label>
                            <input type="number" class="form-control" id="quantidade" min="0" placeholder="0">
                            <div class="form-text">Quantidade atual de peças produzidas</div>
                            <div class="form-text" id="ultimaQuantidadeInfo"></div>
                        </div>
                        
                        <!-- Motivo da Parada (apenas para pausas) -->
                        <div class="mb-3" id="divMotivoParada" style="display: none;">
                            <label for="motivoParada" class="form-label">Motivo da Parada *</label>
                            <select class="form-select" id="motivoParada">
                                <option value="">Selecione o motivo</option>
                                <option value="Parada para café">Parada para café</option>
                                <option value="Sem desenho">Sem desenho</option>
                                <option value="Sem ferramenta">Sem ferramenta</option>
                                <option value="Troca de ferramenta">Troca de ferramenta</option>
                                <option value="Sem material">Sem material</option>
                                <option value="Falha na operação">Falha na operação</option>
                                <option value="Manutenção não programada">Manutenção não programada</option>
                                <option value="Banheiro">Banheiro</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        
                        <!-- Observações -->
                        <div class="mb-3">
                            <label for="observacoes" class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoes" rows="2" placeholder="Observações adicionais (opcional)"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarApontamento()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts de Apontamento -->
    <script src="/static/js/apontamento-persistence.js"></script>
    <script src="/static/js/apontamento-logs.js"></script>
    
    <!-- Função global para carregar logs manualmente -->
    <script>
        // Função global para carregar logs manualmente (para debug)
        function carregarLogsManualmente(ordemId) {
            console.log(`Carregando logs manualmente para OS ${ordemId}`);
            const logsContainer = document.getElementById(`logs-apontamento-container-${ordemId}`);
            
            if (!logsContainer) {
                alert('Container de logs não encontrado!');
                return;
            }
            
            // Mostrar mensagem de carregamento
            logsContainer.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Carregando histórico via botão manual...</p>
                </div>
            `;
            
            // Fazer a requisição diretamente
            fetch(`/apontamento/os/${ordemId}/logs`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Dados recebidos:', data);
                    
                    if (data.logs && data.logs.length > 0) {
                        // Construir HTML simples para exibição dos logs
                        let html = `<h5>Encontrados ${data.logs.length} registros</h5>`;
                        html += '<ul class="list-group">';
                        
                        data.logs.forEach(log => {
                            const data = new Date(log.data_hora).toLocaleString();
                            html += `<li class="list-group-item">${data} - ${log.tipo_acao} - ${log.operador_nome || 'N/A'}</li>`;
                        });
                        
                        html += '</ul>';
                        logsContainer.innerHTML = html;
                    } else {
                        logsContainer.innerHTML = '<div class="alert alert-info">Nenhum registro encontrado.</div>';
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    logsContainer.innerHTML = `<div class="alert alert-danger">Erro ao carregar: ${error.message}</div>`;
                });
        }
    </script>
    
    <!-- Script para Apontamentos -->
    <script>
    let ordemAtualId = null;
    let tipoAcaoAtual = null;
    
    function abrirModalApontamento(tipoAcao, ordemId) {
        // Removido o bloqueio por apontamento ativo em outra OS.
        // Agora sempre permitimos abrir o modal e iniciar um novo apontamento,
        // deixando as validações a cargo do backend apenas dentro da própria OS.
        prosseguirAbrirModal(tipoAcao, ordemId);
    }
    
    // Função auxiliar para criar um modal de alerta caso não exista
    function criarModalAlerta() {
        const modalHtml = `
            <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title" id="alertModalLabel">Aviso</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Conteúdo dinâmico aqui -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Adicionar o modal ao corpo do documento
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer.firstElementChild);
        
        return document.getElementById('alertModal');
    }
    
    // Função para prosseguir com a abertura do modal de apontamento
    function prosseguirAbrirModal(tipoAcao, ordemId) {
        ordemAtualId = ordemId;
        tipoAcaoAtual = tipoAcao;
        
        // Configurar o modal baseado no tipo de ação
        configurarModalPorTipo(tipoAcao);
        
        // Limpar formulário
        document.getElementById('formApontamento').reset();
        document.getElementById('ordemServicoId').value = ordemId;
        document.getElementById('tipoAcao').value = tipoAcao;
        document.getElementById('operadorInfo').innerHTML = '';
        
        // Carregar itens da OS primeiro
        carregarItensOS(ordemId);
        
        // Abrir modal
        new bootstrap.Modal(document.getElementById('modalApontamento')).show();
    }
    
    function configurarModalPorTipo(tipoAcao) {
        const title = document.getElementById('modalApontamentoTitle');
        const divQuantidade = document.getElementById('divQuantidade');
        const divMotivoParada = document.getElementById('divMotivoParada');
        const quantidade = document.getElementById('quantidade');
        const motivoParada = document.getElementById('motivoParada');
        
        // Reset
        divQuantidade.style.display = 'none';
        divMotivoParada.style.display = 'none';
        quantidade.required = false;
        motivoParada.required = false;
        
        switch(tipoAcao) {
            case 'inicio_setup':
                title.textContent = 'Iniciar Setup';
                break;
            case 'fim_setup':
                title.textContent = 'Finalizar Setup';
                break;
            case 'inicio_producao':
                title.textContent = 'Iniciar Produção';
                divQuantidade.style.display = 'block';
                quantidade.placeholder = 'Quantidade inicial (opcional)';
                break;
            case 'pausa':
                title.textContent = 'Pausar Produção';
                divQuantidade.style.display = 'block';
                divMotivoParada.style.display = 'block';
                // Quantidade e motivo são opcionais na pausa
                quantidade.required = false;
                motivoParada.required = false;
                quantidade.placeholder = 'Quantidade atual de peças (opcional)';
                break;
            case 'stop':
                title.textContent = 'Stop (Fim de turno / Parada entre turnos)';
                // No STOP não deve exibir motivo de parada e nada é obrigatório
                divQuantidade.style.display = 'block';
                divMotivoParada.style.display = 'none';
                quantidade.required = false;
                motivoParada.required = false;
                quantidade.placeholder = 'Quantidade final no turno (opcional)';
                break;
            case 'fim_producao':
                title.textContent = 'Finalizar Produção';
                divQuantidade.style.display = 'block';
                quantidade.required = true;
                quantidade.placeholder = 'Quantidade final produzida';
                break;
        }
    }
    
    function carregarItensOS(ordemId) {
        fetch(`/apontamento/os/${ordemId}/itens`)
            .then(response => response.json())
            .then(data => {
                const selectItem = document.getElementById('itemSelecao');
                const selectTipo = document.getElementById('tipoTrabalho');
                
                // Limpar dropdowns
                selectItem.innerHTML = '<option value="">Selecione o item</option>';
                selectTipo.innerHTML = '<option value="">Selecione o tipo de trabalho</option>';
                
                if (data.success && data.itens && data.itens.length > 0) {
                    data.itens.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = `${item.codigo_acb} - ${item.nome}`;
                        selectItem.appendChild(option);
                    });
                    
                    // Se há apenas um item, selecionar automaticamente
                    if (data.itens.length === 1) {
                        selectItem.value = data.itens[0].id;
                        carregarTiposTrabalhoItem(data.itens[0].id);
                    }
                } else {
                    mostrarAlerta('Erro: Nenhum item encontrado para esta OS', 'error');
                }
            })
            .catch(error => {
                console.error('Erro ao carregar itens:', error);
                mostrarAlerta('Erro ao carregar itens da OS', 'error');
            });
    }
    
    function carregarTiposTrabalhoItem(itemId) {
        if (!itemId) {
            const select = document.getElementById('tipoTrabalho');
            select.innerHTML = '<option value="">Selecione o tipo de trabalho</option>';
            return;
        }
        
        fetch(`/apontamento/item/${itemId}/tipos-trabalho`)
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('tipoTrabalho');
                select.innerHTML = '<option value="">Selecione o tipo de trabalho</option>';
                
                if (data.success) {
                    data.tipos_trabalho.forEach(tipo => {
                        const option = document.createElement('option');
                        option.value = tipo.id;
                        option.textContent = tipo.nome;
                        if (tipo.descricao) {
                            option.title = tipo.descricao;
                        }
                        select.appendChild(option);
                    });
                } else {
                    mostrarAlerta('Erro: ' + data.message, 'warning');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                mostrarAlerta('Erro ao carregar tipos de trabalho', 'error');
            });
    }
    
    // Event listener para quando o item for selecionado
    document.getElementById('itemSelecao').addEventListener('change', function(e) {
        const itemId = e.target.value;
        carregarTiposTrabalhoItem(itemId);
        // Limpar informação de última quantidade até que o tipo de trabalho seja selecionado
        const info = document.getElementById('ultimaQuantidadeInfo');
        if (info) info.textContent = '';
    });

    // Quando o tipo de trabalho for selecionado, calcular/mostrar última quantidade
    document.getElementById('tipoTrabalho').addEventListener('change', function(e) {
        atualizarUltimaQuantidadeCampo();
    });

    // Cache simples em memória para última quantidade por OS/Item/Trabalho
    const cacheUltimaQuantidade = new Map();

    function chaveUltimaQuantidade(ordemId, itemId, trabalhoId) {
        return `${ordemId}-${itemId}-${trabalhoId}`;
    }

    async function obterUltimaQuantidade(ordemId, itemId, trabalhoId) {
        const chave = chaveUltimaQuantidade(ordemId, itemId, trabalhoId);
        if (cacheUltimaQuantidade.has(chave)) {
            return cacheUltimaQuantidade.get(chave);
        }

        // 1) Tentar via /apontamento/status-ativos (se houver status para esta OS)
        try {
            const resp = await fetch('/apontamento/status-ativos');
            if (resp.ok) {
                const data = await resp.json();
                if (data.status_ativos && Array.isArray(data.status_ativos)) {
                    const st = data.status_ativos.find(s => s.ordem_servico_id === ordemId && s.item_id === itemId && s.trabalho_id === trabalhoId);
                    if (st && typeof st.ultima_quantidade !== 'undefined' && st.ultima_quantidade !== null) {
                        cacheUltimaQuantidade.set(chave, parseInt(st.ultima_quantidade, 10));
                        return cacheUltimaQuantidade.get(chave);
                    }
                }
            }
        } catch (e) {
            console.warn('Falha ao consultar status-ativos para última quantidade:', e);
        }

        // 2) Consultar logs da OS e pegar a última quantidade para o item/trabalho
        try {
            const resp2 = await fetch(`/apontamento/os/${ordemId}/logs`);
            if (resp2.ok) {
                const data2 = await resp2.json();
                if (data2.logs && Array.isArray(data2.logs)) {
                    // logs já vêm ordenados desc por data_hora
                    const log = data2.logs.find(l => l.item_id === itemId && l.trabalho_id === trabalhoId && l.quantidade !== null && typeof l.quantidade !== 'undefined');
                    if (log) {
                        cacheUltimaQuantidade.set(chave, parseInt(log.quantidade, 10));
                        return cacheUltimaQuantidade.get(chave);
                    }
                }
            }
        } catch (e) {
            console.warn('Falha ao consultar logs para última quantidade:', e);
        }

        // 3) Fallback: 0
        cacheUltimaQuantidade.set(chave, 0);
        return 0;
    }

    async function atualizarUltimaQuantidadeCampo() {
        const ordemId = parseInt(document.getElementById('ordemServicoId').value, 10);
        const itemId = parseInt(document.getElementById('itemSelecao').value, 10);
        const trabalhoId = parseInt(document.getElementById('tipoTrabalho').value, 10);
        const info = document.getElementById('ultimaQuantidadeInfo');
        const qtdInput = document.getElementById('quantidade');
        if (!ordemId || !itemId || !trabalhoId) {
            if (info) info.textContent = '';
            return;
        }
        try {
            const ultimaQ = await obterUltimaQuantidade(ordemId, itemId, trabalhoId);
            if (info) info.textContent = `Última quantidade apontada para este item/trabalho: ${ultimaQ}`;
            if (qtdInput) {
                qtdInput.min = Math.max(0, ultimaQ);
                if (!qtdInput.placeholder || qtdInput.placeholder === '0' || qtdInput.placeholder === 'Quantidade final produzida' || qtdInput.placeholder === 'Quantidade atual de peças') {
                    qtdInput.placeholder = `>= ${ultimaQ}`;
                }
            }
        } catch (e) {
            console.warn('Não foi possível atualizar última quantidade no campo:', e);
        }
    }
    
    // Validação do código do operador em tempo real
    document.getElementById('codigoOperador').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Apenas dígitos
        if (value.length > 4) value = value.substr(0, 4);
        e.target.value = value;
        
        if (value.length === 4) {
            validarOperador(value);
        } else {
            document.getElementById('operadorInfo').innerHTML = '';
        }
    });
    
    function validarOperador(codigo) {
        fetch('/apontamento/validar-codigo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ codigo: codigo })
        })
        .then(response => response.json())
        .then(data => {
            const infoDiv = document.getElementById('operadorInfo');
            if (data.valid) {
                infoDiv.innerHTML = `<small class="text-success"><i class="fas fa-check"></i> ${data.message}</small>`;
            } else {
                infoDiv.innerHTML = `<small class="text-danger"><i class="fas fa-times"></i> ${data.message}</small>`;
            }
        })
        .catch(error => {
            console.error('Erro:', error);
        });
    }
    
    async function salvarApontamento() {
        const form = document.getElementById('formApontamento');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Validar se item foi selecionado
        const itemId = document.getElementById('itemSelecao').value;
        if (!itemId) {
            mostrarAlerta('Por favor, selecione um item antes de continuar', 'error');
            return;
        }
        
        // Validar quantidade mínima no frontend em relação à última quantidade
        const ordemId = document.getElementById('ordemServicoId').value;
        const trabalhoId = document.getElementById('tipoTrabalho').value;
        const tipoAcao = document.getElementById('tipoAcao').value;
        const qtdStr = document.getElementById('quantidade').value;
        if (qtdStr !== '' && qtdStr !== null) {
            const qtdInformada = parseInt(qtdStr, 10);
            if (!Number.isNaN(qtdInformada)) {
                try {
                    const ultimaQ = await obterUltimaQuantidade(parseInt(ordemId, 10), parseInt(itemId, 10), parseInt(trabalhoId, 10));
                    if (typeof ultimaQ === 'number' && qtdInformada < ultimaQ) {
                        mostrarAlerta(`Quantidade informada (${qtdInformada}) menor que a última apontada (${ultimaQ}). Informe um valor maior ou igual.`, 'error');
                        return;
                    }
                } catch (e) {
                    console.warn('Falha ao obter última quantidade para validação frontend:', e);
                    // Em caso de falha, seguimos e deixamos o backend validar
                }
            }
        }

        const dados = {
            ordem_servico_id: document.getElementById('ordemServicoId').value,
            item_id: itemId,
            tipo_acao: document.getElementById('tipoAcao').value,
            codigo_operador: document.getElementById('codigoOperador').value,
            trabalho_id: document.getElementById('tipoTrabalho').value,
            quantidade: document.getElementById('quantidade').value || null,
            motivo_parada: document.getElementById('motivoParada').value || null,
            observacoes: document.getElementById('observacoes').value || null
        };
        
        fetch('/apontamento/registrar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(dados)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAlerta(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalApontamento')).hide();
                // Atualizar visual conforme a ação
                if (tipoAcao === 'stop') {
                    // No STOP, remover qualquer status visual
                    limparStatusCartao(ordemAtualId);
                    // Broadcast STOP para outras abas
                    try {
                        const osIdNum = parseInt(ordemAtualId, 10);
                        if (!Number.isNaN(osIdNum)) {
                            localStorage.setItem('apontamento_broadcast', JSON.stringify({ type: 'stop', osId: osIdNum, ts: Date.now() }));
                        }
                    } catch {}
                } else {
                    // Para demais ações, atualizar status normalmente
                    atualizarStatusCartao(ordemAtualId, data.status);
                }
                // Atualizar última quantidade exibida, se fornecida pelo backend
                if (typeof window.atualizarUltimaQuantidadeNoCard === 'function' && 'ultima_quantidade' in data) {
                    window.atualizarUltimaQuantidadeNoCard(ordemAtualId, data.ultima_quantidade);
                }
                // Semear/atualizar cache da QPT imediatamente
                try {
                    const osId = ordemAtualId;
                    const trabSelect = document.getElementById('tipoTrabalho');
                    const itemSelect = document.getElementById('itemSelecao');
                    const qtdInput = document.getElementById('quantidade');
                    const trabalhoId = trabSelect ? trabSelect.value : null;
                    const trabalhoNome = trabSelect && trabSelect.selectedOptions[0] ? trabSelect.selectedOptions[0].textContent : null;
                    const itemCod = itemSelect && itemSelect.selectedOptions[0] ? itemSelect.selectedOptions[0].textContent : null;
                    const qtdResp = (data && 'ultima_quantidade' in data) ? data.ultima_quantidade : (qtdInput ? qtdInput.value : null);
                    if (window.atualizarQPTCacheEntrada && osId && trabalhoId) {
                        window.atualizarQPTCacheEntrada(osId, trabalhoId, trabalhoNome, itemCod, qtdResp);
                    }
                    // Forçar render imediato apenas quando houver quantidade numérica (evita sobrescrever cache com '-')
                    try {
                        const osIdNum = parseInt(osId, 10);
                        const qtdNum = Number.isFinite(Number(qtdResp)) ? Number(qtdResp) : NaN;
                        if (!Number.isNaN(osIdNum) && Number.isFinite(qtdNum) && window.atualizarQuantidadesPorTrabalho) {
                            // Normaliza o item como no seed: apenas o código base antes do traço
                            const itemLabel = (itemCod || '').toString().replace(/[()]/g, '').trim();
                            const itemCodigoBase = itemLabel.replace(/\s*[-–—]\s*.*$/, '').trim();
                            const entrada = [{
                                trabalho_id: parseInt(trabalhoId, 10),
                                trabalho_nome: trabalhoNome,
                                item_codigo: itemCodigoBase,
                                ultima_quantidade: qtdNum
                            }];
                            // Limpar assinatura para garantir render
                            try {
                                const c = document.getElementById(`qtd-por-trabalho-${osIdNum}`);
                                if (c && c.dataset) delete c.dataset.qptSig;
                            } catch {}
                            window.atualizarQuantidadesPorTrabalho(osIdNum, entrada);
                            try { console.debug('[QPT] render imediato pós-salvar', { osIdNum, entrada }); } catch {}
                            try { if (window.markQptTouch) window.markQptTouch(osIdNum); } catch {}
                        }
                    } catch (eForce) { console.warn('Falha ao forçar render imediato da QPT:', eForce); }
                    // Sempre recarregar estado dos apontamentos no mesmo aba (chips/botões/status)
                    try { if (window.recarregarEstadoApontamentos) window.recarregarEstadoApontamentos(); } catch {}
                    // Sempre publicar broadcast para outras abas/janelas do Kanban
                    try {
                        const osIdNum = parseInt(ordemAtualId, 10);
                        if (!Number.isNaN(osIdNum)) {
                            // Normaliza item base
                            const itemLabel = (itemCod || '').toString().replace(/[()]/g, '').trim();
                            const itemCodigoBase = itemLabel.replace(/\s*[-–—]\s*.*$/, '').trim();
                            const qtdBroadcast = Number.isFinite(Number(qtdResp)) ? Number(qtdResp) : null;
                            const payload = {
                                osId: osIdNum,
                                trabalhoId: trabalhoId ? parseInt(trabalhoId, 10) : null,
                                trabalhoNome: trabalhoNome || null,
                                itemCodigoBase,
                                quantidade: qtdBroadcast,
                                ts: Date.now()
                            };
                            localStorage.setItem('apontamento_event', JSON.stringify(payload));
                        }
                    } catch {}
                } catch (eSeed) { console.warn('Falha ao semear QPT via sucesso do apontamento:', eSeed); }
                // Forçar atualização imediata da QPT no card, usando o cache atual
                try {
                    const osIdNum = parseInt(ordemAtualId, 10);
                    if (!Number.isNaN(osIdNum)) {
                        try {
                            const c = document.getElementById(`qtd-por-trabalho-${osIdNum}`);
                            if (c && c.dataset) delete c.dataset.qptSig;
                        } catch {}
                        if (window.atualizarQuantidadesPorTrabalho) {
                            window.atualizarQuantidadesPorTrabalho(osIdNum, []);
                        }
                        try { if (window.markQptTouch) window.markQptTouch(osIdNum); } catch {}
                        // Broadcast QPT update para outras abas
                        try { localStorage.setItem('apontamento_broadcast', JSON.stringify({ type: 'qpt_update', osId: osIdNum, ts: Date.now() })); } catch {}
                }
                } catch (eQptNow) { console.warn('Falha ao forçar refresh imediato da QPT:', eQptNow); }
                // Evitar recarregar estado aqui para não duplicar QPT; já fizemos seed + refresh imediato
            } else {
                mostrarAlerta(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            mostrarAlerta('Erro ao registrar apontamento', 'error');
        });
    }
    
    function atualizarStatusCartao(ordemId, status) {
        // Atualizar status no card miniatura (kanban-card)
        const card = document.querySelector(`.kanban-card[data-ordem-id="${ordemId}"]`);
        if (!card) return;
        
        // Remover classes de status anteriores
        card.classList.remove('status-setup', 'status-producao', 'status-pausado', 'status-finalizado', 'status-setup-concluido');
        
        // Adicionar classe de status atual
        let statusClass = '';
        let isActiveStatus = false;
        let bgClass = '';
        let statusText = status;
        
        switch(status) {
            case 'Setup em andamento':
                statusClass = 'status-setup';
                bgClass = 'bg-primary';
                statusText = 'Setup em andamento';
                isActiveStatus = true;
                break;
            case 'Produção em andamento':
                statusClass = 'status-producao';
                bgClass = 'bg-success';
                statusText = 'Produção em andamento';
                isActiveStatus = true;
                break;
            case 'Pausado':
                statusClass = 'status-pausado';
                bgClass = 'bg-warning';
                statusText = 'Pausado';
                isActiveStatus = false; // Pausado não mantém timer ativo
                break;
            case 'Setup concluído':
                statusClass = 'status-setup-concluido';
                bgClass = 'bg-info';
                statusText = 'Setup concluído';
                break;
            case 'Finalizado':
                statusClass = 'status-finalizado';
                bgClass = 'bg-secondary';
                statusText = 'Finalizado';
                break;
            default:
                bgClass = 'bg-light';
                statusText = 'Aguardando apontamento';
                break;
        }
        
        // Adicionar classe de status ao card
        if (statusClass) card.classList.add(statusClass);
        
        // Atualizar o campo de status no rodapé do card
        const statusElement = card.querySelector('.status-apontamento');
        if (statusElement) {
            const statusSmall = statusElement.querySelector('small');
            if (statusSmall) {
                statusSmall.className = '';
                statusSmall.classList.add(bgClass, 'text-white', 'p-1', 'rounded');
                statusSmall.textContent = statusText;
            }
            // A partir de agora, os timers ficam nos chips por trabalho (renderizarChipsStatus)
        }
        
        // Atualizar também o status no modal de detalhes, se estiver aberto
        const modalStatusElement = document.getElementById(`status-modal-${ordemId}`);
        if (modalStatusElement) {
            modalStatusElement.innerHTML = `<small class="${bgClass} text-white p-1 rounded">${statusText}</small>`;
        }
        
        // Salvar o status atual no localStorage para persistência local
        try {
            const statusData = JSON.parse(localStorage.getItem('apontamento_status') || '{}');
            statusData[ordemId] = {
                status: status,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('apontamento_status', JSON.stringify(statusData));
        } catch (e) {
            console.error('Erro ao salvar status no localStorage:', e);
        }
    }

    // Remover completamente o status visual do card
    function limparStatusCartao(ordemId) {
        const card = document.querySelector(`.kanban-card[data-ordem-id="${ordemId}"]`);
        if (!card) return;
        // Antes de qualquer limpeza, semear cache QPT a partir do DOM atual (se ainda não persistido)
        try {
            const qptBox = card.querySelector(`#qtd-por-trabalho-${ordemId}`);
            if (qptBox) {
                const lis = qptBox.querySelectorAll('.qpt-list .qpt-item');
                lis.forEach(li => {
                    const labelEl = li.querySelector('.qpt-label');
                    const codeEl = li.querySelector('.qpt-itemcode');
                    const qtyEl = li.querySelector('.qpt-qty');
                    // Priorizar data-attributes adicionados pela renderização da QPT
                    const trabNomeData = li.getAttribute('data-trab-nome');
                    const itemCodData = li.getAttribute('data-item-cod');
                    const trabNome = (trabNomeData && trabNomeData.trim())
                        ? trabNomeData.trim()
                        : (labelEl ? labelEl.textContent.replace(/\s*\(.*\)\s*$/, '').trim() : null);
                    const itemCod = (itemCodData && itemCodData.trim())
                        ? itemCodData.trim()
                        : (codeEl ? codeEl.textContent.replace(/[()]/g, '').trim() : null);
                    const qty = qtyEl ? qtyEl.textContent.trim() : null;
                    if (window.atualizarQPTCacheEntrada && trabNome && (qty !== null && qty !== '')) {
                        window.atualizarQPTCacheEntrada(parseInt(ordemId, 10), '-', trabNome, itemCod, qty);
                    }
                });
            }
        } catch (eDomSeed) { console.warn('Falha ao semear QPT a partir do DOM antes do STOP:', eDomSeed); }
        // Remover classes de status
        card.classList.remove('status-setup', 'status-producao', 'status-pausado', 'status-finalizado', 'status-setup-concluido');
        // Limpar área de status
        const statusElement = card.querySelector('.status-apontamento');
        if (statusElement) {
            // Parar e ocultar timer
            if (typeof pararTimerApontamento === 'function') {
                pararTimerApontamento(ordemId);
            }
            statusElement.innerHTML = '';
        }
        // Limpar espelho do modal, se estiver aberto
        const modalStatusElement = document.getElementById(`status-modal-${ordemId}`);
        if (modalStatusElement) {
            modalStatusElement.innerHTML = '';
        }
        // Remover persistência local do status
        try {
            const statusData = JSON.parse(localStorage.getItem('apontamento_status') || '{}');
            delete statusData[ordemId];
            localStorage.setItem('apontamento_status', JSON.stringify(statusData));
        } catch (e) {
            console.error('Erro ao limpar status no localStorage:', e);
        }
        // Garantir que a QPT permaneça visível usando cache/localStorage
        try {
            const osIdNum = parseInt(ordemId, 10);
            if (window.atualizarQuantidadesPorTrabalho && !Number.isNaN(osIdNum)) {
                console.debug('[QPT] STOP -> refresh imediato', { osIdNum });
                window.atualizarQuantidadesPorTrabalho(osIdNum, []);
                try { if (window.markQptTouch) window.markQptTouch(osIdNum); } catch {}
            }
        } catch (eQPT) {
            console.warn('Falha ao refrescar QPT após STOP:', eQPT);
        }
    }
    
    function mostrarAlerta(mensagem, tipo) {
        const alertClass = tipo === 'success' ? 'alert-success' : 'alert-danger';
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        const container = document.querySelector('.container-fluid');
        container.insertAdjacentHTML('afterbegin', alertHtml);
        
        // Auto-remover após 5 segundos
        setTimeout(() => {
            const alert = container.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    }
    
    // Funções intermediárias para evitar problemas de sintaxe
    function iniciarApontamentoSetup(ordemId) {
        abrirModalApontamento('inicio_setup', ordemId);
    }
    
    function iniciarApontamentoProducao(ordemId) {
        abrirModalApontamento('inicio_producao', ordemId);
    }
    
    function pausarApontamento(ordemId) {
        abrirModalApontamento('pausa', ordemId);
    }
    
    function pararApontamento(ordemId) {
        abrirModalApontamento('stop', ordemId);
    }
    
    function finalizarSetup(ordemId) {
        abrirModalApontamento('fim_setup', ordemId);
    }
    
    function finalizarProducao(ordemId) {
        abrirModalApontamento('fim_producao', ordemId);
    }
    </script>

</body>
</html>
