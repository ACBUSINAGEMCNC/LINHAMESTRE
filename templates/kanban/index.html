<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban - ACB Usinagem CNC</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.1/Sortable.min.js"></script>
    <link rel="stylesheet" href="/static/css/kanban-sortable.css">
    <style>
        body {
            background-color: #f0f2f5;
        }
        .kanban-container {
            display: flex;
            overflow-x: auto;
            padding: 1rem 0;
            min-height: calc(100vh - 150px);
        }
        .kanban-column {
            min-width: 280px;
            max-width: 280px;
            margin-right: 1rem;
            background-color: #ebecf0;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }
        .kanban-column-header {
            padding: 0.75rem;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-column-body {
            padding: 0.75rem;
            flex-grow: 1;
            overflow-y: auto;
            max-height: calc(100vh - 220px);
        }
        .kanban-card {
            background-color: white;
            border-radius: 0.25rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            cursor: grab;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            /* Prevenir seleção de texto durante o arrasto */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            position: relative;
        }
        .kanban-card:active { cursor: grabbing; }
        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .kanban-card-header {
            font-weight: bold;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        .card-header-main { display: flex; align-items: center; gap: 8px; min-width: 0; }
        .card-header-actions { display: flex; align-items: center; gap: 6px; margin-left: auto; }
        .item-thumb { width: 48px; height: 48px; object-fit: cover; }
        /* Título da OS maior */
        .kanban-card-header .card-title { font-size: 1.2rem; line-height: 1.2; font-weight: 600; }
        /* Número nos cartões fantasma maior */
        .kanban-card.fantasma .fantasma-info strong { font-size: 1.4rem; }
        /* Nome do item (Itens da OS) maior */
        .kanban-card .os-item-name { font-size: 1.2rem; font-weight: 600; }
        /* Quantidade (badge) proporcional ao nome do item */
        .kanban-card .os-item-qty { font-size: 1.05rem; padding: 0.2rem 0.55rem; }
        /* Responsivo: reduzir um pouco em telas pequenas */
        @media (max-width: 576px) {
            .kanban-card-header .card-title { font-size: 1.1rem; }
            .kanban-card.fantasma .fantasma-info strong { font-size: 1.2rem; }
            .kanban-card .os-item-name { font-size: 1.05rem; }
            .kanban-card .os-item-qty { font-size: 0.95rem; }
        }
        .kanban-card-body {
            font-size: 0.875rem;
        }
        .kanban-card-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #6c757d;
        }
        .column-counter {
            background-color: #6c757d;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }
        .column-stats {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 5px;
        }
        .column-time {
            background-color: #17a2b8;
            color: white;
            padding: 2px 5px;
        }
        
        /* Estilos para o timer de apontamento */
        .apontamento-timer {
            font-weight: bold;
            font-size: 1em;
            color: #fff;
            background-color: #28a745;
            padding: 2px 6px;
            border-radius: 4px;
            display: none;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        /* Exibir o timer quando o status estiver ativo */
        .status-setup .status-apontamento .apontamento-timer,
        .status-producao .status-apontamento .apontamento-timer,
        .status-pausado .status-apontamento .apontamento-timer {
            display: inline-block;
        }
        
        /* Cores diferentes para cada tipo de status */
        .status-setup .apontamento-timer {
            background-color: #007bff;
        }
        
        .status-pausado .apontamento-timer {
            background-color: #ffc107;
            color: #212529;
        }
        
        /* Estilo para o campo de status */
        .status-apontamento {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        
        .status-apontamento small {
            margin-right: 5px;
        }
        /* Chips por trabalho (tipo + timer) */
        .apontamento-chip {
            display: inline-block;
            background-color: #e9ecef;
            color: #212529;
            padding: 6px 8px;
            border-radius: 6px;
            margin-right: 6px;
            margin-top: 4px;
            line-height: 1.15;
        }
        .apontamento-chip .chip-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .apontamento-chip .chip-col {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 120px;
        }
        .apontamento-chip .chip-title { font-weight: 600; }
        .apontamento-chip .chip-op { opacity: 0.9; }
        .apontamento-chip .chip-motivo { display: block; margin-top: 2px; opacity: 0.95; }
        .apontamento-chip .apontamento-timer { margin-left: auto; padding: 2px 6px; border-radius: 4px; font-weight: 700; }
        /* Cores por tipo de status no chip */
        .apontamento-chip.chip-setup {
            background-color: #0d6efd; /* azul bootstrap */
            color: #fff;
        }
        .apontamento-chip.chip-setup .apontamento-timer { background-color: rgba(255,255,255,0.2); }
        .apontamento-chip.chip-producao {
            background-color: #198754; /* verde bootstrap */
            color: #fff;
        }
        .apontamento-chip.chip-producao .apontamento-timer { background-color: rgba(255,255,255,0.2); }
        .apontamento-chip.chip-pausa {
            background-color: #ffc107; /* amarelo */
            color: #212529;
        }
        .apontamento-chip.chip-pausa .apontamento-timer { background-color: rgba(0,0,0,0.1); }
        
        /* Garantir que chips em cartões fantasma tenham mesmo tamanho e visibilidade */
        .kanban-card.fantasma .apontamento-chip {
            display: inline-block !important;
            min-width: 200px;
            width: auto;
        }
        .kanban-card.fantasma .apontamento-chip .chip-row {
            display: flex !important;
            align-items: center !important;
            gap: 10px !important;
        }
        .kanban-card.fantasma .apontamento-chip .chip-col {
            display: flex !important;
            flex-direction: column !important;
            gap: 2px !important;
            min-width: 120px !important;
            flex-grow: 1;
        }
        .kanban-card.fantasma .apontamento-timer {
            display: inline-block !important;
            margin-left: auto !important;
            padding: 2px 6px !important;
            border-radius: 4px !important;
            font-weight: 700 !important;
            min-width: 60px !important;
            text-align: center !important;
        }
        
        /* Remover o indicador de status do cabeçalho */
        .status-indicador {
            display: none;
            border-radius: 3px;
            margin-right: 5px;
        }
        .column-quantity {
            background-color: #28a745;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
        }
        /* .item-badge (DEPRECATED) substituída por .metric-badge em .card-metrics */
        .modal-xl {
            max-width: 90%;
        }
        .card-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        .card-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        .item-quantity {
            font-weight: bold;
            color: #0d6efd;
        }
        .drag-handle { display: none; }
        /* Estilos para o Sortable.js */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #c8ebfb;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .sortable-chosen {
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: scale(1.02);
            z-index: 100;
        }
        .sortable-drag {
            opacity: 0.8;
            transform: rotate(1deg);
        }
        /* .tempo-total (DEPRECATED) consolidado em .metric-badge.metric-tempo */
        /* Métricas compactas do card (itens, peças, tempo) */
        .card-metrics {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            margin-bottom: 6px;
        }
        
        /* Estilos para cartões fantasma */
        .kanban-card.fantasma {
            opacity: 0.85;
            border: 2px dashed #6f42c1;
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(111,66,193,0.05) 100%);
            position: relative;
        }
        
        .kanban-card.fantasma::before {
            content: "👻";
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 16px;
            z-index: 10;
        }
        
        .kanban-card.fantasma::after {
            content: "FANTASMA";
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 8px;
            font-weight: bold;
            color: #6f42c1;
            background: rgba(111,66,193,0.1);
            padding: 2px 4px;
            border-radius: 3px;
            z-index: 10;
        }
        
        .kanban-card.fantasma .kanban-card-header {
            margin-top: 15px; /* Espaço para os badges fantasma */
        }
        
        .fantasma-info {
            background-color: rgba(111,66,193,0.1);
            border: 1px solid rgba(111,66,193,0.3);
            border-radius: 4px;
            padding: 6px 8px;
            margin-bottom: 8px;
            font-size: 0.75rem;
        }
        
        .fantasma-posicao {
            background-color: #6f42c1;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .fantasma-actions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        
        .btn-fantasma {
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
        }
        
        /* Botão fantasma direto no cartão */
        .btn-outline-purple {
            border-color: #6f42c1;
            color: #6f42c1;
        }
        
        .btn-outline-purple:hover {
            background-color: #6f42c1;
            border-color: #6f42c1;
            color: white;
        }
        .metric-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
        }
        .metric-badge i { font-size: 0.9em; opacity: 0.85; }
        .metric-items { background-color: #0dcaf0; color: #0b2239; }
        .metric-pecas { background-color: #198754; color: #fff; }
        .metric-tempo { background-color: #f1f3f5; color: #0d6efd; border: 1px solid #dee2e6; }
        .dropdown-menu {
            max-height: 300px;
            overflow-y: auto;
        }
        /* Quantidades por trabalho (QPT) */
        .qpt-list { margin: 4px 0 0; padding: 0; }
        .qpt-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 4px 8px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
            margin-bottom: 4px;
        }
        .qpt-item:hover { background: #f1f3f5; }
        .qpt-label { font-size: 0.80rem; color: #495057; }
        .qpt-itemcode { color: #6c757d; font-weight: 500; }
        .qpt-qty { font-size: 0.75rem; background: #e2e3e5 !important; color: #343a40; }
        /* Itens da OS (nome + quantidade) */
        .os-item-list { margin: 4px 0 0; padding: 0; }
        .os-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 4px 8px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #ffffff;
            margin-bottom: 4px;
        }
        .os-item:hover { background: #f8f9fa; }
        .os-item-name { font-size: 0.85rem; color: #212529; font-weight: 500; }
        .os-item-qty { font-size: 0.75rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">ACB Usinagem CNC</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home"></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/kanban"><i class="fas fa-columns"></i> Kanban</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/apontamento/dashboard"><i class="fas fa-chart-bar"></i> Dashboard Apontamento</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/listas"><i class="fas fa-cog"></i> Listas Kanban</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/registros-mensais"><i class="fas fa-archive"></i> Registros Mensais</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-3">
        <h1 class="mb-4">Kanban ACB</h1>
        
        <div class="kanban-container">
            {% for lista in listas %}
            <div class="kanban-column" id="column-{{ lista|lower|replace(' ', '-') }}">
                <div class="kanban-column-header">
                    <span>{{ lista }}</span>
                    <span class="column-counter">{{ ordens[lista]|length }}</span>
                </div>
                <div class="column-stats">
                    {% set horas = (tempos_listas[lista] // 3600) %}
                    {% set minutos = ((tempos_listas[lista] % 3600) // 60) %}
                    {% set segundos = (tempos_listas[lista] % 60) %}
                    <span class="column-time"><i class="fas fa-clock"></i> 
                        {% if horas > 0 %}
                            {{ horas }}h {{ "%02d"|format(minutos) }}:{{ "%02d"|format(segundos) }}
                        {% else %}
                            {{ "%02d"|format(minutos) }}:{{ "%02d"|format(segundos) }}
                        {% endif %}
                    </span>
                    <span class="column-quantity"><i class="fas fa-cubes"></i> {{ quantidades_listas[lista] }}</span>
                </div>
                <div class="kanban-column-body" data-lista="{{ lista }}">
                    <!-- Cartões normais -->
                    {% for ordem in ordens[lista] %}
                    <div class="kanban-card" data-ordem-id="{{ ordem.id }}">
                        <div class="kanban-card-header">
                            <div class="card-header-main">
                                <div class="drag-handle" onclick="event.stopPropagation()">
                                    <i class="fas fa-grip-lines"></i>
                                </div>
                                {% if ordem.pedidos and ordem.pedidos[0].pedido.item and ordem.pedidos[0].pedido.item.imagem_path %}
                                    <img src="{{ ordem.pedidos[0].pedido.item.imagem_path }}" width="48" height="48" class="item-thumb rounded me-2" alt="Imagem do item">
                                {% endif %}
                                <span class="card-title" data-ordem-id="{{ ordem.id }}">{{ ordem.numero }}</span>
                            </div>
                            <div class="card-header-actions">
                                {% if lista != 'Expedição' %}
                                    <!-- Botão fantasma direto -->
                                    <button class="btn btn-sm btn-outline-purple btn-criar-fantasma-direto" 
                                            type="button" 
                                            data-ordem-id="{{ ordem.id }}" 
                                            data-lista-origem="{{ lista }}"
                                            onclick="event.stopPropagation()" 
                                            title="Criar cartão fantasma desta OS">
                                        <i class="fas fa-ghost"></i>
                                    </button>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                                id="dropdownMenuButton{{ ordem.id }}" data-bs-toggle="dropdown" 
                                                aria-expanded="false" onclick="event.stopPropagation()">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton{{ ordem.id }}">
                                            {% for lista_destino in listas %}
                                                {% if lista_destino != lista and lista_destino not in ['Entrada','Expedição'] %}
                                                    <li><a class="dropdown-item btn-mover" href="#" data-ordem-id="{{ ordem.id }}" data-lista-destino="{{ lista_destino }}">Mover para {{ lista_destino }}</a></li>
                                                {% endif %}
                                            {% endfor %}
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-purple btn-criar-fantasma-menu" href="#" data-ordem-id="{{ ordem.id }}" data-lista-origem="{{ lista }}"><i class="fas fa-ghost"></i> Criar cartão fantasma</a></li>
                                        </ul>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="kanban-card-body">
                            {% if ordem.pedidos %}
                                {% set total_items = 0 %}
                                {% set total_qty = 0 %}
                                {% set grouped_items = {} %}
                                {% set tem_desenho = false %}
                                {% set tem_programas = false %}
                                {% set pedido_primeiro = None %}
                                
                                {% for pedido_os in ordem.pedidos %}
                                    {% if loop.index == 1 %}
                                        {% set pedido_primeiro = pedido_os %}
                                    {% endif %}
                                    
                                    {% set item_key = pedido_os.pedido.item_id if pedido_os.pedido.item_id else pedido_os.pedido.nome_item %}
                                    {% set item_name = pedido_os.pedido.item.codigo_acb ~ ' - ' ~ pedido_os.pedido.item.nome if pedido_os.pedido.item_id else pedido_os.pedido.nome_item %}
                                    
                                    {% if pedido_os.pedido.item and pedido_os.pedido.item.desenho_tecnico_path %}
                                        {% set tem_desenho = true %}
                                    {% endif %}
                                    
                                    {% if pedido_os.pedido.item and pedido_os.pedido.item.arquivos_cnc %}
                                        {% set tem_programas = true %}
                                    {% endif %}
                                    
                                    {% if item_key in grouped_items %}
                                        {% set _ = grouped_items[item_key].update({
                                            'total_qty': grouped_items[item_key].total_qty 
                                                          + pedido_os.pedido.quantidade
                                        }) %}
                                    {% else %}
                                        {% set _ = grouped_items.update({
                                            item_key: {
                                                'name': item_name,
                                                'total_qty': pedido_os.pedido.quantidade,
                                                'item': pedido_os.pedido.item if pedido_os.pedido.item_id else None
                                            }
                                        }) %}
                                    {% endif %}
                                {% endfor %}

                                <div class="document-icons">
                                    {% if tem_desenho %}
                                    <span class="document-icon pdf-icon toggle-pdf" data-container-id="pdf-container-{{ ordem.id }}">
                                        <i class="fas fa-file-pdf"></i>
                                        <small class="ms-1">Desenho</small>
                                    </span>
                                    {% endif %}
                                    {% if tem_programas %}
                                    <span class="document-icon cnc-icon toggle-cnc" data-container-id="cnc-container-{{ ordem.id }}">
                                        <i class="fas fa-file-code"></i>
                                        <small class="ms-1">Programas</small>
                                    </span>
                                    {% endif %}
                                </div>
                                
                                <!-- Container de desenho (oculto por padrão) -->
                                {% if tem_desenho and pedido_primeiro and pedido_primeiro.pedido.item.desenho_tecnico_path %}
                                <div id="pdf-container-{{ ordem.id }}" class="document-container pdf-container">
                                    <div class="mb-2">
                                        <strong>Desenho do Item:</strong>
                                    </div>
                                    <a href="{{ pedido_primeiro.pedido.item.desenho_tecnico_path }}" class="file-link" target="_blank">
                                        <i class="fas fa-file-pdf pdf-icon"></i>
                                        Visualizar PDF
                                    </a>
                                </div>
                                {% endif %}
                                
                                <!-- Container de programas CNC (oculto por padrão) -->
                                {% if tem_programas %}
                                <div id="cnc-container-{{ ordem.id }}" class="document-container cnc-container">
                                    <div class="mb-2">
                                        <strong>Programas CNC:</strong>
                                    </div>
                                    {% for item_key, item_data in grouped_items.items() %}
                                        {% if item_data.item and item_data.item.arquivos_cnc %}
                                            {% for arquivo in item_data.item.arquivos_cnc %}
                                                <a href="/arquivos/cnc/{{ arquivo.arquivo_path }}" class="file-link" download>
                                                    <i class="fas fa-file-code cnc-icon"></i>
                                                    {{ arquivo.nome_original }}
                                                </a>
                                            {% endfor %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                        
                            {% else %}
                                <div class="text-muted"><small>Sem pedidos</small></div>
                             {% endif %}
                             
                            <!-- Itens da OS: nome do item + quantidade -->
                             {% if grouped_items and grouped_items|length > 0 %}
                             <div class="os-items mt-1">
                                 <div class="small text-muted">Itens da OS</div>
                                 <ul class="os-item-list list-unstyled mb-1">
                                     {% for item_key, item_data in grouped_items.items() %}
                                     <li class="os-item">
                                         <span class="os-item-name">{{ item_data.name }}</span>
                                         <span class="badge rounded-pill bg-primary os-item-qty" title="Quantidade do item">{{ item_data.total_qty }}</span>
                                     </li>
                                     {% endfor %}
                                 </ul>
                             </div>
                             {% endif %}

                             <!-- Quantidades por trabalho (sempre visível) -->
                             <div class="qtd-por-trabalho mt-1" id="qtd-por-trabalho-{{ ordem.id }}">
                                 <div class="small text-muted d-flex justify-content-between align-items-center">
                                     <span>Quantidades por trabalho</span>
                                     <span class="badge rounded-pill bg-secondary ultima-qtd" id="ultima-qtd-{{ ordem.id }}" title="Último apontamento">-</span>
                                 </div>
                                 <ul class="qpt-list list-unstyled mb-1">
                                     <li class="qpt-item">
                                         <span class="qpt-label">-</span>
                                         <span class="badge rounded-pill bg-secondary qpt-qty" title="Último apontamento">-</span>
                                     </li>
                                 </ul>
                             </div>

                             {% if acesso_kanban and lista not in ['Entrada', 'Expedição'] %}
                             <div class="apontamento-buttons mt-2 pt-2 border-top">
                                 <div class="row g-1">
                                     <!-- Grupo Setup -->
                                     <div class="col-6">
                                         <button class="btn btn-outline-primary btn-sm w-100 apontamento-btn" 
                                                 data-acao="inicio_setup"
                                                 data-ordem-id="{{ ordem.id }}"
                                                 onclick="iniciarApontamentoSetup(this.dataset.ordemId);"
                                                 title="Iniciar Setup">
                                             <i class="fas fa-play"></i> Setup
                                         </button>
                                     </div>
                                     <div class="col-6">
                                         <button class="btn btn-outline-info btn-sm w-100 apontamento-btn" 
                                                 data-acao="fim_setup"
                                                 data-ordem-id="{{ ordem.id }}"
                                                 onclick="finalizarSetup(this.dataset.ordemId);"
                                                 title="Finalizar Setup">
                                             <i class="fas fa-stop"></i> Fim Setup
                                         </button>
                                     </div>

                                     <!-- Grupo Produção -->
                                     <div class="col-6">
                                         <button class="btn btn-outline-success btn-sm w-100 apontamento-btn" 
                                                 data-acao="inicio_producao"
                                                 data-ordem-id="{{ ordem.id }}"
                                                 onclick="iniciarApontamentoProducao(this.dataset.ordemId);"
                                                 title="Iniciar Produção">
                                             <i class="fas fa-cogs"></i> Produção
                                         </button>
                                     </div>
                                     <div class="col-6">
                                         <button class="btn btn-outline-warning btn-sm w-100 apontamento-btn" 
                                                 data-acao="pausa"
                                                 data-ordem-id="{{ ordem.id }}"
                                                 onclick="pausarApontamento(this.dataset.ordemId);"
                                                 title="Pausar produção">
                                             <i class="fas fa-pause"></i> Pausa
                                         </button>
                                     </div>
                                     <div class="col-12">
                                         <button class="btn btn-outline-danger btn-sm w-100 apontamento-btn" 
                                                 data-acao="stop"
                                                 data-ordem-id="{{ ordem.id }}"
                                                 onclick="pararApontamento(this.dataset.ordemId);"
                                                 title="Stop (fim de turno / parada entre turnos)">
                                             <i class="fas fa-stop"></i> Stop
                                         </button>
                                     </div>
                                 </div>
                                
                                <!-- Botão Detalhes -->
                                <div class="row g-1 mt-1">
                                    <div class="col-12">
                                        <button class="btn btn-outline-info btn-sm w-100" 
                                                onclick="abrirDetalhesOS('{{ ordem.id }}')"
                                                title="Ver apontamentos da OS">
                                            <i class="fas fa-info-circle"></i> Apontamentos
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Status atual do apontamento -->
                                <div class="status-apontamento mt-1" id="status-{{ ordem.id }}">
                                    <small class="text-muted">Aguardando apontamento</small>
                                    <!-- Timer de apontamento será inserido aqui -->
                                    <span class="apontamento-timer" id="timer-{{ ordem.id }}">00:00:00</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    
                    <!-- Cartões fantasma -->
                    {% for cartao_fantasma in cartoes_fantasma[lista] %}
                    <div class="kanban-card fantasma" data-cartao-id="{{ cartao_fantasma.id }}" data-fantasma-ordem-id="{{ cartao_fantasma.ordem_servico.id }}">
                        <div class="kanban-card-header">
                            <div class="card-header-main">
                                <div class="drag-handle" onclick="event.stopPropagation()">
                                    <i class="fas fa-grip-lines"></i>
                                </div>
                                {% if cartao_fantasma.ordem_servico.pedidos and cartao_fantasma.ordem_servico.pedidos[0].pedido.item and cartao_fantasma.ordem_servico.pedidos[0].pedido.item.imagem_path %}
                                    <img src="{{ cartao_fantasma.ordem_servico.pedidos[0].pedido.item.imagem_path }}" width="48" height="48" class="item-thumb rounded me-2" alt="Imagem do item">
                                {% endif %}
                                <div class="fantasma-info" onclick="openCardDetails('{{ cartao_fantasma.ordem_servico.id }}'); event.stopPropagation()" style="cursor: pointer" title="Abrir detalhes da OS">
                                    <span class="fantasma-posicao">{{ cartao_fantasma.posicao_fila }}</span>
                                    <strong>{{ cartao_fantasma.ordem_servico.numero }}</strong>
                                    <small class="text-muted">(Lista origem: {{ cartao_fantasma.ordem_servico.status }})</small>
                                    {% if cartao_fantasma.trabalho %}
                                        <br><small><i class="fas fa-cog"></i> {{ cartao_fantasma.trabalho.nome }}</small>
                                    {% endif %}
                                 </div>
                            </div>
                        </div>
                        <div class="kanban-card-body">
                            {% if cartao_fantasma.ordem_servico.pedidos %}
                                {% set ordem = cartao_fantasma.ordem_servico %}
                                {% set total_items = 0 %}
                                {% set total_qty = 0 %}
                                {% set grouped_items = {} %}
                                
                                {% for pedido_os in ordem.pedidos %}
                                    {% set item_key = pedido_os.pedido.item_id if pedido_os.pedido.item_id else pedido_os.pedido.nome_item %}
                                    {% set item_name = pedido_os.pedido.item.codigo_acb ~ ' - ' ~ pedido_os.pedido.item.nome if pedido_os.pedido.item_id else pedido_os.pedido.nome_item %}
                                    
                                    {% if item_key in grouped_items %}
                                        {% set _ = grouped_items[item_key].update({
                                            'total_qty': grouped_items[item_key].total_qty + pedido_os.pedido.quantidade
                                        }) %}
                                    {% else %}
                                        {% set _ = grouped_items.update({
                                            item_key: {
                                                'name': item_name,
                                                'total_qty': pedido_os.pedido.quantidade,
                                                'item': pedido_os.pedido.item if pedido_os.pedido.item_id else None
                                            }
                                        }) %}
                                    {% endif %}
                                {% endfor %}
                            
                                <div class="os-items mt-1">
                                    <div class="small text-muted">Itens da OS</div>
                                    <ul class="os-item-list list-unstyled mb-1">
                                        {% for item_key, item_data in grouped_items.items() %}
                                        <li class="os-item">
                                            <span class="os-item-name">{{ item_data.name }}</span>
                                            <span class="badge rounded-pill bg-primary os-item-qty" title="Quantidade do item">{{ item_data.total_qty }}</span>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                            
                            {% if cartao_fantasma.observacoes %}
                            <div class="mt-2">
                                <small class="text-muted"><i class="fas fa-comment"></i> {{ cartao_fantasma.observacoes }}</small>
                            </div>
                            {% endif %}
                            
                            <!-- Botões de Apontamento (apontam para a OS real) -->
                            {% if acesso_kanban and lista not in ['Entrada', 'Expedição'] %}
                            <div class="apontamento-buttons mt-2 pt-2 border-top">
                                <div class="row g-1">
                                    <!-- Grupo Setup -->
                                    <div class="col-6">
                                        <button class="btn btn-outline-primary btn-sm w-100 apontamento-btn" 
                                                data-acao="inicio_setup"
                                                data-ordem-id="{{ cartao_fantasma.ordem_servico.id }}"
                                                onclick="iniciarApontamentoSetup(this.dataset.ordemId);"
                                                title="Iniciar Setup (OS Real)">
                                            <i class="fas fa-play"></i> Setup
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-outline-info btn-sm w-100 apontamento-btn" 
                                                data-acao="fim_setup"
                                                data-ordem-id="{{ cartao_fantasma.ordem_servico.id }}"
                                                onclick="finalizarSetup(this.dataset.ordemId);"
                                                title="Finalizar Setup (OS Real)">
                                            <i class="fas fa-stop"></i> Fim Setup
                                        </button>
                                    </div>

                                    <!-- Grupo Produção -->
                                    <div class="col-6">
                                        <button class="btn btn-outline-success btn-sm w-100 apontamento-btn" 
                                                data-acao="inicio_producao"
                                                data-ordem-id="{{ cartao_fantasma.ordem_servico.id }}"
                                                onclick="iniciarApontamentoProducao(this.dataset.ordemId);"
                                                title="Iniciar Produção (OS Real)">
                                            <i class="fas fa-cogs"></i> Produção
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-outline-warning btn-sm w-100 apontamento-btn" 
                                                data-acao="pausa"
                                                data-ordem-id="{{ cartao_fantasma.ordem_servico.id }}"
                                                onclick="pausarApontamento(this.dataset.ordemId);"
                                                title="Pausar produção (OS Real)">
                                            <i class="fas fa-pause"></i> Pausa
                                        </button>
                                    </div>
                                    <div class="col-12">
                                        <button class="btn btn-outline-danger btn-sm w-100 apontamento-btn" 
                                                data-acao="stop"
                                                data-ordem-id="{{ cartao_fantasma.ordem_servico.id }}"
                                                onclick="pararApontamento(this.dataset.ordemId);"
                                                title="Stop (fim de turno / parada entre turnos) (OS Real)">
                                            <i class="fas fa-stop"></i> Stop
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Indicadores de status (baseado na OS real) -->
                                <div class="apontamento-status mt-2" id="status-fantasma-{{ cartao_fantasma.id }}">
                                    <div class="d-flex justify-content-between align-items-center small">
                                        <span class="status-text">Aguardando</span>
                                        <span class="apontamento-timer" id="timer-fantasma-{{ cartao_fantasma.id }}">00:00:00</span>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="fantasma-actions mt-2 pt-2 border-top">
                                <button class="btn btn-outline-warning btn-fantasma btn-mover-fantasma" 
                                        data-cartao-id="{{ cartao_fantasma.id }}" 
                                        title="Alterar posição na fila">
                                    <i class="fas fa-arrows-alt-v"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-fantasma btn-remover-fantasma" 
                                        data-cartao-id="{{ cartao_fantasma.id }}" 
                                        title="Remover cartão fantasma">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button class="btn btn-outline-info btn-fantasma btn-detalhes-fantasma" 
                                        data-ordem-id="{{ cartao_fantasma.ordem_servico.id }}"
                                        onclick="abrirDetalhesOS('{{ cartao_fantasma.ordem_servico.id }}')"
                                        title="Ver apontamentos da OS original">
                                    <i class="fas fa-info-circle"></i> Apontamentos
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

    <!-- Modal para detalhes do card -->
    <div class="modal fade" id="cardDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes da Ordem de Serviço</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para criar cartão fantasma -->
    <div class="modal fade" id="criarFantasmaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-ghost text-purple"></i> Criar Cartão Fantasma</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formCriarFantasma">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Ordem de Serviço:</label>
                                <select class="form-select" id="ordemSelect" name="ordem_id" required>
                                    <option value="">Selecione uma OS...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Lista Destino:</label>
                                <select class="form-select" id="listaSelect" name="lista_destino" required>
                                    <option value="">Selecione a lista...</option>
                                    {% for lista in listas %}
                                        {% if lista not in ['Entrada', 'Expedição'] %}
                                        <option value="{{ lista }}">{{ lista }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Trabalho Específico (Opcional):</label>
                                <select class="form-select" id="trabalhoSelect" name="trabalho_id">
                                    <option value="">Selecione um trabalho...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Posição na Fila:</label>
                                <input type="number" class="form-control" name="posicao_fila" value="1" min="1" max="10">
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Observações:</label>
                            <textarea class="form-control" name="observacoes" rows="2" placeholder="Observações sobre este cartão fantasma..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnConfirmarFantasma">
                        <i class="fas fa-ghost"></i> Criar Cartão Fantasma
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para mover cartão fantasma -->
    <div class="modal fade" id="moverFantasmaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-arrows-alt-v"></i> Alterar Posição</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formMoverFantasma">
                        <input type="hidden" id="cartaoIdMover" name="cartao_id">
                        <div class="mb-3">
                            <label class="form-label">Nova Posição na Fila:</label>
                            <input type="number" class="form-control" id="novaPosicao" name="nova_posicao" value="1" min="1" max="10" required>
                            <div class="form-text">Posição 1 = primeiro da fila</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="btnConfirmarMoverFantasma">
                        <i class="fas fa-arrows-alt-v"></i> Alterar Posição
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts do Bootstrap e JavaScript customizado -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/kanban-sortable.js"></script>
    <script>
        function moverOrdem(ordemId, listaDestino) {
            fetch('/kanban/mover', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `ordem_id=${ordemId}&nova_lista=${listaDestino}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar mensagem de sucesso
                    alert(data.message);
                    // Recarregar a página para atualizar
                    window.location.reload();
                }
            });
        }
        
        function openCardDetails(ordemId) {
            const modal = new bootstrap.Modal(document.getElementById('cardDetailsModal'));
            modal.show();
            
            // Carregar os detalhes do card via AJAX
            fetch(`/kanban/detalhes/${ordemId}`)
                .then(response => response.text())
                .then(html => {
                    document.querySelector('#cardDetailsModal .modal-body').innerHTML = html;
                    
                    // Inicializar os elementos do formulário dentro do modal
                    document.querySelectorAll('#cardDetailsModal .btn-salvar-tempo').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const form = this.closest('form');
                            const formData = new FormData(form);
                            
                            fetch('/kanban/atualizar-tempo-real', {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Atualizar apenas a parte relevante do modal
                                    openCardDetails(ordemId);
                                }
                            });
                        });
                    });
                    
                    // Carregar logs de apontamento automaticamente após o modal ser carregado
                    console.log(`Carregando logs automaticamente para OS ${ordemId} após abertura do modal`);
                    
                    // Usar setTimeout para garantir que o DOM está completamente carregado
                    setTimeout(function() {
                        // Tentar carregar logs usando a função global
                        if (typeof carregarLogsManualmente === 'function') {
                            console.log(`Chamando carregarLogsManualmente para OS ${ordemId}`);
                            carregarLogsManualmente(ordemId);
                        } else {
                            console.error('Função carregarLogsManualmente não encontrada!');
                            
                            // Carregar logs diretamente via fetch se a função global não estiver disponível
                            const logsContainer = document.getElementById(`logs-apontamento-container-${ordemId}`);
                            if (logsContainer) {
                                fetch(`/apontamento/os/${ordemId}/logs`)
                                    .then(response => response.json())
                                    .then(data => {
                                        console.log(`Dados recebidos diretamente para OS ${ordemId}:`, data);
                                        
                                        if (data.logs && data.logs.length > 0) {
                                            let html = `<h5>Encontrados ${data.logs.length} registros</h5>`;
                                            html += '<ul class="list-group">';
                                            
                                            data.logs.forEach(log => {
                                                const dataHora = new Date(log.data_hora).toLocaleString();
                                                html += `<li class="list-group-item">${dataHora} - ${log.tipo_acao} - ${log.operador_nome || 'N/A'}</li>`;
                                            });
                                            
                                            html += '</ul>';
                                            logsContainer.innerHTML = html;
                                        } else {
                                            logsContainer.innerHTML = '<div class="alert alert-info">Nenhum registro encontrado.</div>';
                                        }
                                    })
                                    .catch(error => {
                                        console.error(`Erro ao carregar logs diretamente para OS ${ordemId}:`, error);
                                        logsContainer.innerHTML = `<div class="alert alert-danger">Erro ao carregar: ${error.message}</div>`;
                                    });
                            } else {
                                console.error(`Container de logs não encontrado para OS ${ordemId}`);
                            }
                        }
                    }, 500);
                });
        }
        
        // Alias para compatibilidade com elementos existentes
        function abrirDetalhesOS(ordemId) {
            return openCardDetails(ordemId);
        }

        // Função global chamada por botão dentro do modal de detalhes (conteúdo injetado)
        function scrollToApontamentos(ordemId) {
            const el = document.getElementById(`secao-apontamentos-${ordemId}`);
            if (el) {
                // Preferir rolagem no corpo do modal
                const modalBody = document.querySelector('#cardDetailsModal .modal-body');
                if (modalBody && modalBody.contains(el)) {
                    const bodyRect = modalBody.getBoundingClientRect();
                    const elRect = el.getBoundingClientRect();
                    const offsetTop = modalBody.scrollTop + (elRect.top - bodyRect.top) - 12;
                    console.debug('[Apontamentos] Rolando modal até', offsetTop);
                    modalBody.scrollTo({ top: offsetTop, behavior: 'smooth' });
                } else {
                    // Fallback para rolar a página
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                const card = el.querySelector('.card');
                if (card) {
                    card.classList.add('border', 'border-warning');
                    setTimeout(() => card.classList.remove('border', 'border-warning'), 900);
                }
            }
            try {
                if (typeof carregarLogsManualmente === 'function') {
                    carregarLogsManualmente(ordemId);
                }
            } catch (e) {
                console.warn('Falha ao recarregar logs:', e);
            }
        }
        
        function finalizarOS(ordemId) {
            if (confirm('Deseja finalizar esta Ordem de Serviço? Ela será movida para o registro mensal.')) {
                fetch('/kanban/finalizar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `ordem_id=${ordemId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Fechar o modal e recarregar a página
                        bootstrap.Modal.getInstance(document.getElementById('cardDetailsModal')).hide();
                        window.location.reload();
                    }
                });
            }
        }
        
        // Função para mostrar/ocultar contêiner de documentos (PDF/CNC)
        function toggleDocContainer(element, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Verificar se está visível ou oculto com getComputedStyle
            const computedStyle = window.getComputedStyle(container);
            const isHidden = computedStyle.display === 'none';
            
            // Alternar visibilidade
            if (isHidden) {
                // Mostrar o container
                container.style.cssText = 'display: block !important';
                element.classList.add('active');
            } else {
                // Esconder o container
                container.style.cssText = 'display: none !important';
                element.classList.remove('active');
            }
            
            // Prevenir propagação de eventos
            event.stopPropagation();
            return false;
        }
        
        // Função para inicializar todos os eventos nos cartões
        function initializeKanbanEvents() {
            console.log('=== Inicializando eventos do Kanban ===');
            
            // Eventos para abrir detalhes do card
            document.querySelectorAll('.card-title').forEach(function(element) {
                element.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const ordemId = this.dataset.ordemId;
                    openCardDetails(ordemId);
                });
            });
            
            // Event listeners para botões de criação de cartão fantasma direto
            const btnFantasma = document.querySelectorAll('.btn-criar-fantasma-direto');
            console.log('Encontrados', btnFantasma.length, 'botões fantasma direto');
            
            // Listar todos os botões encontrados
            btnFantasma.forEach(function(btn, index) {
                console.log(`Botão ${index + 1}:`, {
                    element: btn,
                    ordemId: btn.dataset.ordemId,
                    listaOrigem: btn.dataset.listaOrigem,
                    className: btn.className,
                    initialized: btn.classList.contains('events-initialized')
                });
            });
            
            // Configurar event listeners para botões de criar fantasma
            btnFantasma.forEach(function(btn) {
                if (!btn.classList.contains('events-initialized')) {
                    console.log('🔧 Configurando evento para botão OS:', btn.dataset.ordemId);
                    
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const ordemId = this.dataset.ordemId;
                        const listaOrigem = this.dataset.listaOrigem;
                        console.log('🚀 CLIQUE no botão fantasma! OS:', ordemId, 'Lista:', listaOrigem);
                        criarCartaoFantasmaRapido(ordemId, listaOrigem);
                    });
                    
                    // Teste adicional - evento de mousedown
                    btn.addEventListener('mousedown', function(e) {
                        console.log('👆 MOUSEDOWN no botão fantasma OS:', this.dataset.ordemId);
                    });
                    
                    btn.classList.add('events-initialized');
                    console.log('✅ Evento configurado para OS:', btn.dataset.ordemId);
                } else {
                    console.log('⏭️ Botão OS', btn.dataset.ordemId, 'já inicializado');
                }
            });
            
            // Configurar botões de ação dos cartões fantasma
            configurarBotoesFantasma();
            
            // Marcar os cartões como inicializados
            document.querySelectorAll('.kanban-card').forEach(function(card) {
                card.classList.add('events-initialized');
            });
            
            console.log('=== Inicialização de eventos concluída ===');
        }
        
        // Inicializar eventos após o carregamento do documento
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado - chamando initializeKanbanEvents');
            initializeKanbanEvents();
            
            // Também inicializar novamente quando o Sortable terminar uma operação de arrasto
            document.addEventListener('sortable-drop-complete', function() {
                console.log('Sortable drop complete - reinicializando eventos');
                setTimeout(initializeKanbanEvents, 100);
            });
        });
    </script>

    <!-- Modal de Apontamento -->
    <div class="modal fade" id="modalApontamento" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalApontamentoTitle">Apontamento de Produção</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formApontamento">
                        <input type="hidden" id="ordemServicoId">
                        <input type="hidden" id="tipoAcao">
                        
                        <!-- Código do Operador -->
                        <div class="mb-3">
                            <label for="codigoOperador" class="form-label">Código do Operador *</label>
                            <input type="text" class="form-control" id="codigoOperador" maxlength="4" pattern="[0-9]{4}" placeholder="0000" required>
                            <div class="form-text">Digite seu código de 4 dígitos</div>
                            <div id="operadorInfo" class="mt-1"></div>
                        </div>
                        
                        <!-- Seleção de Item -->
                        <div class="mb-3" id="divItemSelecao">
                            <label for="itemSelecao" class="form-label">Item *</label>
                            <select class="form-select" id="itemSelecao" required>
                                <option value="">Selecione o item</option>
                            </select>
                            <div class="form-text">Selecione o item específico para apontamento</div>
                        </div>
                        
                        <!-- Tipo de Trabalho -->
                        <div class="mb-3" id="divTipoTrabalho">
                            <label for="tipoTrabalho" class="form-label">Tipo de Trabalho *</label>
                            <select class="form-select" id="tipoTrabalho" required>
                                <option value="">Selecione o tipo de trabalho</option>
                            </select>
                            <div class="form-text">Tipos de trabalho do item selecionado</div>
                        </div>
                        
                        <!-- Quantidade (para início produção e pausas) -->
                        <div class="mb-3" id="divQuantidade" style="display: none;">
                            <label for="quantidade" class="form-label">Quantidade de Peças</label>
                            <input type="number" class="form-control" id="quantidade" min="0" placeholder="0">
                            <div class="form-text">Quantidade atual de peças produzidas</div>
                            <div class="form-text" id="ultimaQuantidadeInfo"></div>
                        </div>
                        
                        <!-- Motivo da Parada (apenas para pausas) -->
                        <div class="mb-3" id="divMotivoParada" style="display: none;">
                            <label for="motivoParada" class="form-label">Motivo da Parada *</label>
                            <select class="form-select" id="motivoParada">
                                <option value="">Selecione o motivo</option>
                                <option value="Parada para café">Parada para café</option>
                                <option value="Sem desenho">Sem desenho</option>
                                <option value="Sem ferramenta">Sem ferramenta</option>
                                <option value="Troca de ferramenta">Troca de ferramenta</option>
                                <option value="Sem material">Sem material</option>
                                <option value="Falha na operação">Falha na operação</option>
                                <option value="Manutenção não programada">Manutenção não programada</option>
                                <option value="Banheiro">Banheiro</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        
                        <!-- Observações -->
                        <div class="mb-3">
                            <label for="observacoes" class="form-label">Observações</label>
                            <textarea class="form-control" id="observacoes" rows="2" placeholder="Observações adicionais (opcional)"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarApontamento()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts de Apontamento -->
    <script src="/static/js/apontamento-persistence.js"></script>
    <script src="/static/js/apontamento-logs.js"></script>
    
    <!-- Função global para carregar logs manualmente -->
    <script>
        // Função global para carregar logs manualmente (para debug)
        function carregarLogsManualmente(ordemId) {
            console.log(`Carregando logs manualmente para OS ${ordemId}`);
            const logsContainer = document.getElementById(`logs-apontamento-container-${ordemId}`);
            
            if (!logsContainer) {
                alert('Container de logs não encontrado!');
                return;
            }
            
            // Mostrar mensagem de carregamento
            logsContainer.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Carregando histórico via botão manual...</p>
                </div>
            `;
            
            // Fazer a requisição diretamente
            fetch(`/apontamento/os/${ordemId}/logs`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Dados recebidos:', data);
                    
                    if (data.logs && data.logs.length > 0) {
                        // Construir HTML simples para exibição dos logs
                        let html = `<h5>Encontrados ${data.logs.length} registros</h5>`;
                        html += '<ul class="list-group">';
                        
                        data.logs.forEach(log => {
                            const data = new Date(log.data_hora).toLocaleString();
                            html += `<li class="list-group-item">${data} - ${log.tipo_acao} - ${log.operador_nome || 'N/A'}</li>`;
                        });
                        
                        html += '</ul>';
                        logsContainer.innerHTML = html;
                    } else {
                        logsContainer.innerHTML = '<div class="alert alert-info">Nenhum registro encontrado.</div>';
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    logsContainer.innerHTML = `<div class="alert alert-danger">Erro ao carregar: ${error.message}</div>`;
                });
        }
    </script>
    
    <!-- Script para Apontamentos -->
    <script>
    let ordemAtualId = null;
    let tipoAcaoAtual = null;
    
    function abrirModalApontamento(tipoAcao, ordemId) {
        // Removido o bloqueio por apontamento ativo em outra OS.
        // Agora sempre permitimos abrir o modal e iniciar um novo apontamento,
        // deixando as validações a cargo do backend apenas dentro da própria OS.
        prosseguirAbrirModal(tipoAcao, ordemId);
    }
    
    // Função auxiliar para criar um modal de alerta caso não exista
    function criarModalAlerta() {
        const modalHtml = `
            <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title" id="alertModalLabel">Aviso</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Conteúdo dinâmico aqui -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Adicionar o modal ao corpo do documento
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer.firstElementChild);
        
        return document.getElementById('alertModal');
    }
    
    // Função para prosseguir com a abertura do modal de apontamento
    function prosseguirAbrirModal(tipoAcao, ordemId) {
        ordemAtualId = ordemId;
        tipoAcaoAtual = tipoAcao;
        
        // Configurar o modal baseado no tipo de ação
        configurarModalPorTipo(tipoAcao);
        
        // Limpar formulário
        document.getElementById('formApontamento').reset();
        document.getElementById('ordemServicoId').value = ordemId;
        document.getElementById('tipoAcao').value = tipoAcao;
        document.getElementById('operadorInfo').innerHTML = '';
        
        // Carregar itens da OS primeiro
        carregarItensOS(ordemId);
        
        // Abrir modal
        new bootstrap.Modal(document.getElementById('modalApontamento')).show();
    }
    
    function configurarModalPorTipo(tipoAcao) {
        const title = document.getElementById('modalApontamentoTitle');
        const divQuantidade = document.getElementById('divQuantidade');
        const divMotivoParada = document.getElementById('divMotivoParada');
        const quantidade = document.getElementById('quantidade');
        const motivoParada = document.getElementById('motivoParada');
        
        // Reset
        divQuantidade.style.display = 'none';
        divMotivoParada.style.display = 'none';
        quantidade.required = false;
        motivoParada.required = false;
        
        switch(tipoAcao) {
            case 'inicio_setup':
                title.textContent = 'Iniciar Setup';
                break;
            case 'fim_setup':
                title.textContent = 'Finalizar Setup';
                break;
            case 'inicio_producao':
                title.textContent = 'Iniciar Produção';
                divQuantidade.style.display = 'block';
                quantidade.placeholder = 'Quantidade inicial (opcional)';
                break;
            case 'pausa':
                title.textContent = 'Pausar Produção';
                divQuantidade.style.display = 'block';
                divMotivoParada.style.display = 'block';
                // Quantidade e motivo são opcionais na pausa
                quantidade.required = false;
                motivoParada.required = false;
                quantidade.placeholder = 'Quantidade atual de peças (opcional)';
                break;
            case 'stop':
                title.textContent = 'Stop (Fim de turno / Parada entre turnos)';
                // No STOP não deve exibir motivo de parada e nada é obrigatório
                divQuantidade.style.display = 'block';
                divMotivoParada.style.display = 'none';
                // STOP: quantidade opcional, sem motivo de parada
                quantidade.required = false;
                motivoParada.required = false;
                quantidade.placeholder = 'Quantidade final no turno (opcional)';
                break;
            case 'fim_producao':
                title.textContent = 'Finalizar Produção';
                divQuantidade.style.display = 'block';
                quantidade.required = true;
                quantidade.placeholder = 'Quantidade final produzida';
                break;
        }
    }
    
    function carregarItensOS(ordemId) {
        fetch(`/apontamento/os/${ordemId}/itens`)
            .then(response => response.json())
            .then(data => {
                const selectItem = document.getElementById('itemSelecao');
                const selectTipo = document.getElementById('tipoTrabalho');
                
                // Limpar dropdowns
                selectItem.innerHTML = '<option value="">Selecione o item</option>';
                selectTipo.innerHTML = '<option value="">Selecione o tipo de trabalho</option>';
                
                if (data.success && data.itens && data.itens.length > 0) {
                    data.itens.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = `${item.codigo_acb} - ${item.nome}`;
                        selectItem.appendChild(option);
                    });
                    
                    // Se há apenas um item, selecionar automaticamente
                    if (data.itens.length === 1) {
                        selectItem.value = data.itens[0].id;
                        carregarTiposTrabalhoItem(data.itens[0].id);
                    }
                } else {
                    mostrarAlerta('Erro: Nenhum item encontrado para esta OS', 'error');
                }
            })
            .catch(error => {
                console.error('Erro ao carregar itens:', error);
                mostrarAlerta('Erro ao carregar itens da OS', 'error');
            });
    }
    
    function carregarTiposTrabalhoItem(itemId) {
        if (!itemId) {
            const select = document.getElementById('tipoTrabalho');
            select.innerHTML = '<option value="">Selecione o tipo de trabalho</option>';
            return;
        }
        
        fetch(`/apontamento/item/${itemId}/tipos-trabalho`)
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('tipoTrabalho');
                select.innerHTML = '<option value="">Selecione o tipo de trabalho</option>';
                
                if (data.success) {
                    data.tipos_trabalho.forEach(tipo => {
                        const option = document.createElement('option');
                        option.value = tipo.id;
                        option.textContent = tipo.nome;
                        if (tipo.descricao) {
                            option.title = tipo.descricao;
                        }
                        select.appendChild(option);
                    });
                } else {
                    mostrarAlerta('Erro: ' + data.message, 'warning');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                mostrarAlerta('Erro ao carregar tipos de trabalho', 'error');
            });
    }
    
    // Event listener para quando o item for selecionado
    document.getElementById('itemSelecao').addEventListener('change', function(e) {
        const itemId = e.target.value;
        carregarTiposTrabalhoItem(itemId);
        // Limpar informação de última quantidade até que o tipo de trabalho seja selecionado
        const info = document.getElementById('ultimaQuantidadeInfo');
        if (info) info.textContent = '';
    });

    // Quando o tipo de trabalho for selecionado, calcular/mostrar última quantidade
    document.getElementById('tipoTrabalho').addEventListener('change', function(e) {
        atualizarUltimaQuantidadeCampo();
    });

    // Cache simples em memória para última quantidade por OS/Item/Trabalho
    const cacheUltimaQuantidade = new Map();

    function chaveUltimaQuantidade(ordemId, itemId, trabalhoId) {
        return `${ordemId}-${itemId}-${trabalhoId}`;
    }

    async function obterUltimaQuantidade(ordemId, itemId, trabalhoId) {
        const chave = chaveUltimaQuantidade(ordemId, itemId, trabalhoId);
        if (cacheUltimaQuantidade.has(chave)) {
            return cacheUltimaQuantidade.get(chave);
        }

        // 1) Tentar via /apontamento/status-ativos (se houver status para esta OS)
        try {
            const resp = await fetch('/apontamento/status-ativos');
            if (resp.ok) {
                const data = await resp.json();
                if (data.status_ativos && Array.isArray(data.status_ativos)) {
                    const st = data.status_ativos.find(s => s.ordem_servico_id === ordemId && s.item_id === itemId && s.trabalho_id === trabalhoId);
                    if (st && typeof st.ultima_quantidade !== 'undefined' && st.ultima_quantidade !== null) {
                        cacheUltimaQuantidade.set(chave, parseInt(st.ultima_quantidade, 10));
                        return cacheUltimaQuantidade.get(chave);
                    }
                }
            }
        } catch (e) {
            console.warn('Falha ao consultar status-ativos para última quantidade:', e);
        }

        // 2) Consultar logs da OS e pegar a última quantidade para o item/trabalho
        try {
            const resp2 = await fetch(`/apontamento/os/${ordemId}/logs`);
            if (resp2.ok) {
                const data2 = await resp2.json();
                if (data2.logs && Array.isArray(data2.logs)) {
                    // logs já vêm ordenados desc por data_hora
                    const log = data2.logs.find(l => l.item_id === itemId && l.trabalho_id === trabalhoId && l.quantidade !== null && typeof l.quantidade !== 'undefined');
                    if (log) {
                        cacheUltimaQuantidade.set(chave, parseInt(log.quantidade, 10));
                        return cacheUltimaQuantidade.get(chave);
                    }
                }
            }
        } catch (e) {
            console.warn('Falha ao consultar logs para última quantidade:', e);
        }

        // 3) Fallback: 0
        cacheUltimaQuantidade.set(chave, 0);
        return 0;
    }

    async function atualizarUltimaQuantidadeCampo() {
        const ordemId = parseInt(document.getElementById('ordemServicoId').value, 10);
        const itemId = parseInt(document.getElementById('itemSelecao').value, 10);
        const trabalhoId = parseInt(document.getElementById('tipoTrabalho').value, 10);
        const info = document.getElementById('ultimaQuantidadeInfo');
        const qtdInput = document.getElementById('quantidade');
        if (!ordemId || !itemId || !trabalhoId) {
            if (info) info.textContent = '';
            return;
        }
        try {
            // Primeiro, tentar buscar do QPT atualizado no DOM
            let ultimaQ = null;
            
            // Buscar o cartão da OS no DOM
            const cartoes = document.querySelectorAll('.kanban-card');
            for (const cartao of cartoes) {
                const osIdElement = cartao.querySelector('[data-ordem-id]');
                if (osIdElement && parseInt(osIdElement.getAttribute('data-ordem-id')) === ordemId) {
                    // Encontrou o cartão da OS, agora buscar o QPT do trabalho específico
                    const qptItems = cartao.querySelectorAll('.qpt-item');
                    for (const qptItem of qptItems) {
                        const trabalhoNome = qptItem.getAttribute('data-trab-nome');
                        const qptQty = qptItem.querySelector('.qpt-qty');
                        
                        // Verificar se é o trabalho correto comparando com o select
                        const trabalhoSelect = document.getElementById('tipoTrabalho');
                        const trabalhoSelecionado = trabalhoSelect.options[trabalhoSelect.selectedIndex];
                        
                        if (trabalhoSelecionado && trabalhoSelecionado.text === trabalhoNome && qptQty) {
                            ultimaQ = parseInt(qptQty.textContent.trim());
                            console.log(`QPT encontrado no DOM: ${ultimaQ} para trabalho ${trabalhoNome}`);
                            break;
                        }
                    }
                    if (ultimaQ !== null) break;
                }
            }
            
            // Se não encontrou no QPT, buscar via backend
            if (ultimaQ === null) {
                ultimaQ = await obterUltimaQuantidade(ordemId, itemId, trabalhoId);
            } else {
                // Atualizar o cache com o valor do QPT
                const chave = chaveUltimaQuantidade(ordemId, itemId, trabalhoId);
                cacheUltimaQuantidade.set(chave, ultimaQ);
            }
            
            if (info) info.textContent = `Última quantidade apontada para este item/trabalho: ${ultimaQ}`;
            if (qtdInput) {
                qtdInput.min = Math.max(0, ultimaQ);
                if (!qtdInput.placeholder || qtdInput.placeholder === '0' || qtdInput.placeholder === 'Quantidade final produzida' || qtdInput.placeholder === 'Quantidade atual de peças') {
                    qtdInput.placeholder = `>= ${ultimaQ}`;
                }
            }
        } catch (e) {
            console.warn('Não foi possível atualizar última quantidade no campo:', e);
        }
    }
    
    // Validação do código do operador em tempo real
    document.getElementById('codigoOperador').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Apenas dígitos
        if (value.length > 4) value = value.substr(0, 4);
        e.target.value = value;
        
        if (value.length === 4) {
            validarOperador(value);
        } else {
            document.getElementById('operadorInfo').innerHTML = '';
        }
    });
    
    function validarOperador(codigo) {
        fetch('/apontamento/validar-codigo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ codigo: codigo })
        })
        .then(response => response.json())
        .then(data => {
            const infoDiv = document.getElementById('operadorInfo');
            if (data.valid) {
                infoDiv.innerHTML = `<small class="text-success"><i class="fas fa-check"></i> ${data.message}</small>`;
            } else {
                infoDiv.innerHTML = `<small class="text-danger"><i class="fas fa-times"></i> ${data.message}</small>`;
            }
        })
        .catch(error => {
            console.error('Erro:', error);
        });
    }
    
    async function salvarApontamento() {
        const form = document.getElementById('formApontamento');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Validar se item foi selecionado
        const itemId = document.getElementById('itemSelecao').value;
        if (!itemId) {
            mostrarAlerta('Por favor, selecione um item antes de continuar', 'error');
            return;
        }
        
        // Validar quantidade mínima no frontend em relação à última quantidade
        const ordemId = document.getElementById('ordemServicoId').value;
        const trabalhoId = document.getElementById('tipoTrabalho').value;
        const tipoAcao = document.getElementById('tipoAcao').value;
        const qtdStr = document.getElementById('quantidade').value;
        if (qtdStr !== '' && qtdStr !== null) {
            const qtdInformada = parseInt(qtdStr, 10);
            if (!Number.isNaN(qtdInformada)) {
                try {
                    const ultimaQ = await obterUltimaQuantidade(parseInt(ordemId, 10), parseInt(itemId, 10), parseInt(trabalhoId, 10));
                    if (typeof ultimaQ === 'number' && qtdInformada < ultimaQ) {
                        mostrarAlerta(`Quantidade informada (${qtdInformada}) menor que a última apontada (${ultimaQ}). Informe um valor maior ou igual.`, 'error');
                        return;
                    }
                } catch (e) {
                    console.warn('Falha ao obter última quantidade para validação frontend:', e);
                    // Em caso de falha, seguimos e deixamos o backend validar
                }
            }
        }

        const dados = {
            ordem_servico_id: document.getElementById('ordemServicoId').value,
            item_id: itemId,
            tipo_acao: document.getElementById('tipoAcao').value,
            codigo_operador: document.getElementById('codigoOperador').value,
            trabalho_id: document.getElementById('tipoTrabalho').value,
            quantidade: document.getElementById('quantidade').value || null,
            motivo_parada: document.getElementById('motivoParada').value || null,
            observacoes: document.getElementById('observacoes').value || null
        };
        
        fetch('/apontamento/registrar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(dados)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAlerta(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalApontamento')).hide();
                // Atualizar visual conforme a ação
                if (tipoAcao === 'stop') {
                    // No STOP, remover qualquer status visual
                    limparStatusCartao(ordemAtualId);
                    // Broadcast STOP para outras abas
                    try {
                        const osIdNum = parseInt(ordemAtualId, 10);
                        if (!Number.isNaN(osIdNum)) {
                            localStorage.setItem('apontamento_broadcast', JSON.stringify({ type: 'stop', osId: osIdNum, ts: Date.now() }));
                        }
                    } catch {}
                    // Marcar flag after-stop nesta mesma aba e limpar assinatura; a atualização ocorrerá após o seed de cache abaixo
                    try {
                        const osIdNum = parseInt(ordemAtualId, 10);
                        if (!Number.isNaN(osIdNum)) {
                            window.__qptAfterStop = window.__qptAfterStop || {};
                            window.__qptAfterStop[osIdNum] = true;
                            try { console.debug('[QPT] (same tab) flag after STOP set', osIdNum); } catch {}
                            try {
                                const c = document.getElementById(`qtd-por-trabalho-${osIdNum}`);
                                if (c && c.dataset) delete c.dataset.qptSig;
                            } catch {}
                        }
                    } catch {}
                } else {
                    // Para demais ações, atualizar status normalmente
                    atualizarStatusCartao(ordemAtualId, data.status);
                }
                // Atualizar última quantidade exibida, se fornecida pelo backend
                if (typeof window.atualizarUltimaQuantidadeNoCard === 'function' && 'ultima_quantidade' in data) {
                    window.atualizarUltimaQuantidadeNoCard(ordemAtualId, data.ultima_quantidade);
                }
                // Semear/atualizar cache da QPT imediatamente
                try {
                    const osId = ordemAtualId;
                    const trabSelect = document.getElementById('tipoTrabalho');
                    const itemSelect = document.getElementById('itemSelecao');
                    const qtdInput = document.getElementById('quantidade');
                    const trabalhoId = trabSelect ? trabSelect.value : null;
                    const trabalhoNome = trabSelect && trabSelect.selectedOptions[0] ? trabSelect.selectedOptions[0].textContent : null;
                    const itemCod = itemSelect && itemSelect.selectedOptions[0] ? itemSelect.selectedOptions[0].textContent : null;
                    // CORREÇÃO: Para STOP, priorizar quantidade informada no modal sobre a resposta do backend
                    const qtdInput_value = qtdInput ? qtdInput.value : null;
                    const qtdResp = (qtdInput_value && qtdInput_value.trim() !== '') ? qtdInput_value : 
                                   (data && 'ultima_quantidade' in data) ? data.ultima_quantidade : null;
                    if (window.atualizarQPTCacheEntrada && osId && trabalhoId) {
                        window.atualizarQPTCacheEntrada(osId, trabalhoId, trabalhoNome, itemCod, qtdResp);
                    }
                    // Forçar render imediato apenas quando houver quantidade numérica (evita sobrescrever cache com '-')
                    try {
                        const osIdNum = parseInt(osId, 10);
                        const qtdNum = Number.isFinite(Number(qtdResp)) ? Number(qtdResp) : NaN;
                        if (!Number.isNaN(osIdNum) && Number.isFinite(qtdNum) && window.atualizarQuantidadesPorTrabalho) {
                            // Normaliza o item como no seed: apenas o código base antes do traço
                            const itemLabel = (itemCod || '').toString().replace(/[()]/g, '').trim();
                            const itemCodigoBase = itemLabel.replace(/\s*[-–—]\s*.*$/, '').trim();
                            const entrada = [{
                                trabalho_id: parseInt(trabalhoId, 10),
                                trabalho_nome: trabalhoNome,
                                item_codigo: itemCodigoBase,
                                ultima_quantidade: qtdNum
                            }];
                            // Limpar assinatura para garantir render
                            try {
                                const c = document.getElementById(`qtd-por-trabalho-${osIdNum}`);
                                if (c && c.dataset) delete c.dataset.qptSig;
                            } catch {}
                            window.atualizarQuantidadesPorTrabalho(osIdNum, entrada);
                            // Fallback 200ms: reintentar com lista vazia para garantir refresh em casos de atraso no DOM
                            setTimeout(() => {
                                try { if (window.atualizarQuantidadesPorTrabalho) window.atualizarQuantidadesPorTrabalho(osIdNum, []); } catch {}
                            }, 200);
                            try { console.debug('[QPT] render imediato pós-salvar', { osIdNum, entrada }); } catch {}
                            try { if (window.markQptTouch) window.markQptTouch(osIdNum); } catch {}
                        }
                    } catch (eForce) { console.warn('Falha ao forçar render imediato da QPT:', eForce); }
                    // CORREÇÃO: Atualizar campo "Última quantidade" no modal se estiver aberto
                    try {
                        const modal = document.getElementById('apontamentoModal');
                        const modalInstance = bootstrap.Modal.getInstance(modal);
                        if (modalInstance && qtdResp && Number.isFinite(Number(qtdResp))) {
                            // Atualizar o campo de última quantidade no modal
                            setTimeout(() => {
                                const info = document.getElementById('ultimaQuantidadeInfo');
                                if (info && trabalhoNome) {
                                    info.textContent = `Última quantidade apontada para este item/trabalho: ${qtdResp}`;
                                }
                                // Atualizar placeholder do input de quantidade
                                const qtdInputModal = document.getElementById('quantidade');
                                if (qtdInputModal) {
                                    qtdInputModal.min = Math.max(0, Number(qtdResp));
                                    qtdInputModal.placeholder = `>= ${qtdResp}`;
                                }
                            }, 100);
                        }
                    } catch (eModal) { console.warn('Falha ao atualizar modal:', eModal); }
                    // Sempre recarregar estado dos apontamentos no mesmo aba (chips/botões/status)
                    setTimeout(() => {
                        try { 
                            if (window.recarregarEstadoApontamentos) {
                                window.recarregarEstadoApontamentos(); 
                            }
                        } catch (e) {
                            console.warn('Erro ao recarregar estado:', e);
                        }
                    }, 100);
                    
                    // Sempre publicar broadcast para outras abas/janelas do Kanban
                    try {
                        const osIdNum = parseInt(ordemAtualId, 10);
                        if (!Number.isNaN(osIdNum)) {
                            // Normaliza item base
                            const itemLabel = (itemCod || '').toString().replace(/[()]/g, '').trim();
                            const itemCodigoBase = itemLabel.replace(/\s*[-–—]\s*.*$/, '').trim();
                            const qtdBroadcast = Number.isFinite(Number(qtdResp)) ? Number(qtdResp) : null;
                            const payload = {
                                osId: osIdNum,
                                trabalhoId: trabalhoId ? parseInt(trabalhoId, 10) : null,
                                trabalhoNome: trabalhoNome || null,
                                itemCodigoBase,
                                quantidade: qtdBroadcast,
                                ts: Date.now()
                            };
                            localStorage.setItem('apontamento_event', JSON.stringify(payload));
                        }
                    } catch {}
                } catch (eSeed) { console.warn('Falha ao semear QPT via sucesso do apontamento:', eSeed); }
                // Forçar atualização imediata da QPT no card, usando o cache atual
                try {
                    const osIdNum = parseInt(ordemAtualId, 10);
                    if (!Number.isNaN(osIdNum)) {
                        try {
                            const c = document.getElementById(`qtd-por-trabalho-${osIdNum}`);
                            if (c && c.dataset) delete c.dataset.qptSig;
                        } catch {}
                        if (window.atualizarQuantidadesPorTrabalho) {
                            window.atualizarQuantidadesPorTrabalho(osIdNum, []);
                            // Fallback 200ms: reintentar para garantir refresh
                            setTimeout(() => {
                                try { if (window.atualizarQuantidadesPorTrabalho) window.atualizarQuantidadesPorTrabalho(osIdNum, []); } catch {}
                            }, 200);
                        }
                        try { if (window.markQptTouch) window.markQptTouch(osIdNum); } catch {}
                        // Broadcast QPT update para outras abas
                        try { localStorage.setItem('apontamento_broadcast', JSON.stringify({ type: 'qpt_update', osId: osIdNum, ts: Date.now() })); } catch {}
                }
                } catch (eQptNow) { console.warn('Falha ao forçar refresh imediato da QPT:', eQptNow); }
                // Evitar recarregar estado aqui para não duplicar QPT; já fizemos seed + refresh imediato
            } else {
                mostrarAlerta(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            mostrarAlerta('Erro ao registrar apontamento', 'error');
        });
    }
    
    function atualizarStatusCartao(ordemId, status) {
        // Buscar TODOS os cartões com essa ordem e verificar qual é o real
        const allCards = document.querySelectorAll(`[data-ordem-id="${ordemId}"]`);
        console.debug(`[STATUS] Encontrados ${allCards.length} cartões para OS ${ordemId}`);
        
        let card = null;
        for (const c of allCards) {
            if (!c.classList.contains('fantasma')) {
                card = c;
                console.debug(`[STATUS] Usando cartão real para OS ${ordemId}`);
                break;
            }
        }
        
        if (!card) {
            console.debug(`[STATUS] Nenhum cartão REAL encontrado para OS ${ordemId}`);
            return;
        }
        
        // Remover classes de status anteriores
        card.classList.remove('status-setup', 'status-producao', 'status-pausado', 'status-finalizado', 'status-setup-concluido');
        
        // Adicionar classe de status atual
        let statusClass = '';
        let isActiveStatus = false;
        let bgClass = '';
        let statusText = status;
        
        switch(status) {
            case 'Setup em andamento':
                statusClass = 'status-setup';
                bgClass = 'bg-primary';
                statusText = 'Setup em andamento';
                isActiveStatus = true;
                break;
            case 'Produção em andamento':
                statusClass = 'status-producao';
                bgClass = 'bg-success';
                statusText = 'Produção em andamento';
                isActiveStatus = true;
                break;
            case 'Pausado':
                statusClass = 'status-pausado';
                bgClass = 'bg-warning';
                statusText = 'Pausado';
                isActiveStatus = false; // Pausado não mantém timer ativo
                break;
            case 'Setup concluído':
                statusClass = 'status-setup-concluido';
                bgClass = 'bg-info';
                statusText = 'Setup concluído';
                break;
            case 'Finalizado':
                statusClass = 'status-finalizado';
                bgClass = 'bg-secondary';
                statusText = 'Finalizado';
                break;
            default:
                bgClass = 'bg-light';
                statusText = 'Aguardando apontamento';
                break;
        }
        
        // Adicionar classe de status ao card
        if (statusClass) card.classList.add(statusClass);
        
        // Atualizar o campo de status no rodapé do card
        const statusElement = card.querySelector('.status-apontamento');
        if (statusElement) {
            const statusSmall = statusElement.querySelector('small');
            if (statusSmall) {
                statusSmall.className = '';
                statusSmall.classList.add(bgClass, 'text-white', 'p-1', 'rounded');
                statusSmall.textContent = statusText;
            }
            // A partir de agora, os timers ficam nos chips por trabalho (renderizarChipsStatus)
        }
        
        // Atualizar também o status no modal de detalhes, se estiver aberto
        const modalStatusElement = document.getElementById(`status-modal-${ordemId}`);
        if (modalStatusElement) {
            modalStatusElement.innerHTML = `<small class="${bgClass} text-white p-1 rounded">${statusText}</small>`;
        }
        
        // Salvar o status atual no localStorage para persistência local
        try {
            const statusData = JSON.parse(localStorage.getItem('apontamento_status') || '{}');
            statusData[ordemId] = {
                status: status,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('apontamento_status', JSON.stringify(statusData));
        } catch (e) {
            console.error('Erro ao salvar status no localStorage:', e);
        }
    }

    // Remover completamente o status visual do card
    function limparStatusCartao(ordemId) {
        const card = document.querySelector(`.kanban-card[data-ordem-id="${ordemId}"]`);
        if (!card) return;
        // Antes de qualquer limpeza, semear cache QPT a partir do DOM atual (se ainda não persistido)
        try {
            const qptBox = card.querySelector(`#qtd-por-trabalho-${ordemId}`);
            if (qptBox) {
                const lis = qptBox.querySelectorAll('.qpt-list .qpt-item');
                lis.forEach(li => {
                    const labelEl = li.querySelector('.qpt-label');
                    const codeEl = li.querySelector('.qpt-itemcode');
                    const qtyEl = li.querySelector('.qpt-qty');
                    // Priorizar data-attributes adicionados pela renderização da QPT
                    const trabNomeData = li.getAttribute('data-trab-nome');
                    const itemCodData = li.getAttribute('data-item-cod');
                    const trabNome = (trabNomeData && trabNomeData.trim())
                        ? trabNomeData.trim()
                        : (labelEl ? labelEl.textContent.replace(/\s*\(.*\)\s*$/, '').trim() : null);
                    const itemCod = (itemCodData && itemCodData.trim())
                        ? itemCodData.trim()
                        : (codeEl ? codeEl.textContent.replace(/[()]/g, '').trim() : null);
                    const qty = qtyEl ? qtyEl.textContent.trim() : null;
                    if (window.atualizarQPTCacheEntrada && trabNome && (qty !== null && qty !== '')) {
                        window.atualizarQPTCacheEntrada(parseInt(ordemId, 10), '-', trabNome, itemCod, qty);
                    }
                });
            }
        } catch (eDomSeed) { console.warn('Falha ao semear QPT a partir do DOM antes do STOP:', eDomSeed); }
        // Remover classes de status
        card.classList.remove('status-setup', 'status-producao', 'status-pausado', 'status-finalizado', 'status-setup-concluido');
        // Limpar área de status
        const statusElement = card.querySelector('.status-apontamento');
        if (statusElement) {
            // Parar e ocultar timer
            if (typeof pararTimerApontamento === 'function') {
                pararTimerApontamento(ordemId);
            }
            statusElement.innerHTML = '';
        }
        // Limpar espelho do modal, se estiver aberto
        const modalStatusElement = document.getElementById(`status-modal-${ordemId}`);
        if (modalStatusElement) {
            modalStatusElement.innerHTML = '';
        }
        // Remover persistência local do status
        try {
            const statusData = JSON.parse(localStorage.getItem('apontamento_status') || '{}');
            delete statusData[ordemId];
            localStorage.setItem('apontamento_status', JSON.stringify(statusData));
        } catch (e) {
            console.error('Erro ao limpar status no localStorage:', e);
        }
        // Garantir que a QPT permaneça visível usando cache/localStorage
        try {
            const osIdNum = parseInt(ordemId, 10);
            if (window.atualizarQuantidadesPorTrabalho && !Number.isNaN(osIdNum)) {
                console.debug('[QPT] STOP -> refresh imediato', { osIdNum });
                window.atualizarQuantidadesPorTrabalho(osIdNum, []);
                try { if (window.markQptTouch) window.markQptTouch(osIdNum); } catch {}
            }
        } catch (eQPT) {
            console.warn('Falha ao refrescar QPT após STOP:', eQPT);
        }
    }
    
    function mostrarAlerta(mensagem, tipo) {
        const alertClass = tipo === 'success' ? 'alert-success' : 'alert-danger';
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        const container = document.querySelector('.container-fluid');
        container.insertAdjacentHTML('afterbegin', alertHtml);
        
        // Auto-remover após 5 segundos
        setTimeout(() => {
            const alert = container.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    }
    
    // Funções intermediárias para evitar problemas de sintaxe
    function iniciarApontamentoSetup(ordemId) {
        abrirModalApontamento('inicio_setup', ordemId);
    }
    
    function iniciarApontamentoProducao(ordemId) {
        abrirModalApontamento('inicio_producao', ordemId);
    }
    
    function pausarApontamento(ordemId) {
        abrirModalApontamento('pausa', ordemId);
    }
    
    function pararApontamento(ordemId) {
        abrirModalApontamento('stop', ordemId);
    }
    
    function finalizarSetup(ordemId) {
        abrirModalApontamento('fim_setup', ordemId);
    }
    
    function finalizarProducao(ordemId) {
        abrirModalApontamento('fim_producao', ordemId);
    }
    
    // Função para criar cartão fantasma rapidamente
    function criarCartaoFantasmaRapido(ordemId, listaOrigem) {
        console.log('Clicou no botão fantasma! OS:', ordemId, 'Lista:', listaOrigem);
        
        // Popular o select com todas as ordens disponíveis
        popularSelectOrdens().then(() => {
            // Mostrar modal simplificado com OS pré-selecionada
            const modalEl = document.getElementById('criarFantasmaModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            
            // Pré-selecionar a OS (usar o ID correto do select)
            const selectOS = document.getElementById('ordemSelect');
            if (selectOS) {
                selectOS.value = ordemId;
                // Disparar evento change se necessário para carregar trabalhos
                selectOS.dispatchEvent(new Event('change'));
            }
            
            // Definir lista origem no título do modal
            const modalTitle = document.querySelector('#criarFantasmaModal .modal-title');
            if (modalTitle) {
                modalTitle.innerHTML = `<i class="fas fa-ghost text-purple"></i> Criar Cartão Fantasma - OS #${ordemId}`;
            }
            
            // Configurar posição automática baseada em cartões fantasma existentes
            configurarPosicaoAutomatica();
            
            modal.show();
        });
    }
    
    // Função para configurar posição automática
    function configurarPosicaoAutomatica() {
        const selectLista = document.getElementById('listaSelect');
        const inputPosicao = document.querySelector('[name="posicao_fila"]');
        
        if (selectLista && inputPosicao) {
            // Listener para quando a lista destino mudar
            selectLista.addEventListener('change', function() {
                const listaDestino = this.value;
                if (listaDestino) {
                    // Contar cartões fantasma existentes nesta lista
                    const cartoesFantasma = document.querySelectorAll(`.kanban-card.fantasma[data-lista="${listaDestino}"]`);
                    const proximaPosicao = cartoesFantasma.length + 1;
                    
                    inputPosicao.value = proximaPosicao;
                    console.log(`Lista ${listaDestino}: ${cartoesFantasma.length} fantasmas existentes, sugerindo posição ${proximaPosicao}`);
                }
            });
            
            // Disparar evento change se já tiver lista selecionada
            if (selectLista.value) {
                selectLista.dispatchEvent(new Event('change'));
            }
        }
    }
    
    // Função para popular o select de ordens
    function popularSelectOrdens() {
        return new Promise((resolve) => {
            const selectOS = document.getElementById('ordemSelect');
            if (!selectOS) {
                resolve();
                return;
            }
            
            // Limpar select
            selectOS.innerHTML = '<option value="">Selecione uma OS...</option>';
            
            // Coletar todas as ordens da página
            const cartoes = document.querySelectorAll('.kanban-card[data-ordem-id]');
            const ordensAdicionadas = new Set();
            
            cartoes.forEach(cartao => {
                const ordemId = cartao.dataset.ordemId;
                const titulo = cartao.querySelector('.card-title');
                if (ordemId && titulo && !ordensAdicionadas.has(ordemId)) {
                    const option = document.createElement('option');
                    option.value = ordemId;
                    option.textContent = titulo.textContent.trim();
                    selectOS.appendChild(option);
                    ordensAdicionadas.add(ordemId);
                }
            });
            
            resolve();
        });
    }
    
    // Função de teste para debug
    function testarBotaoFantasma() {
        console.log('=== TESTE BOTÃO FANTASMA ===');
        const botoes = document.querySelectorAll('.btn-criar-fantasma-direto');
        console.log('Botões encontrados:', botoes.length);
        
        botoes.forEach((btn, i) => {
            console.log(`Botão ${i}:`, btn, 'OS:', btn.dataset.ordemId);
            
            // Adicionar evento de teste direto
            btn.onclick = function(e) {
                console.log('ONCLICK FUNCIONOU! OS:', this.dataset.ordemId);
                criarCartaoFantasmaRapido(this.dataset.ordemId, this.dataset.listaOrigem);
            };
        });
        
        return botoes.length;
    }
    
    // Executar teste quando carregado
    setTimeout(function() {
        console.log('Executando teste automático...');
        testarBotaoFantasma();
        configurarBotaoConfirmarFantasma();
    }, 2000);
    
    // Fail-safe: ao fechar qualquer modal, se não houver mais modais visíveis
    // limpe possíveis backdrops remanescentes e a classe modal-open no body
    document.addEventListener('hidden.bs.modal', function () {
        if (document.querySelectorAll('.modal.show').length === 0) {
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            document.body.classList.remove('modal-open');
            document.body.style.removeProperty('overflow');
            document.body.style.removeProperty('padding-right');
        }
    });
    
    // Configurar botões de ação dos cartões fantasma
    function configurarBotoesFantasma() {
        console.log('Configurando botões de ação dos cartões fantasma...');
        
        // Botões de remover fantasma
        document.querySelectorAll('.btn-remover-fantasma').forEach(function(btn) {
            if (!btn.classList.contains('events-initialized')) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const cartaoId = this.dataset.cartaoId;
                    console.log('Removendo cartão fantasma:', cartaoId);
                    removerCartaoFantasma(cartaoId);
                });
                btn.classList.add('events-initialized');
                console.log('✅ Botão remover configurado para cartão:', btn.dataset.cartaoId);
            }
        });
        
        // Botões de mover fantasma
        document.querySelectorAll('.btn-mover-fantasma').forEach(function(btn) {
            if (!btn.classList.contains('events-initialized')) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const cartaoId = this.dataset.cartaoId;
                    console.log('Movendo cartão fantasma:', cartaoId);
                    abrirModalMoverFantasma(cartaoId);
                });
                btn.classList.add('events-initialized');
                console.log('✅ Botão mover configurado para cartão:', btn.dataset.cartaoId);
            }
        });
        
        // Botões de detalhes fantasma
        document.querySelectorAll('.btn-detalhes-fantasma').forEach(function(btn) {
            if (!btn.classList.contains('events-initialized')) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const ordemId = this.dataset.ordemId;
                    console.log('Abrindo detalhes da OS:', ordemId);
                    openCardDetails(ordemId);
                });
                btn.classList.add('events-initialized');
                console.log('✅ Botão detalhes configurado para OS:', btn.dataset.ordemId);
            }
        });
    }
    
    // Função para remover cartão fantasma
    function removerCartaoFantasma(cartaoId) {
        console.log('🗑️ Tentando remover cartão fantasma ID:', cartaoId);
        // Removendo confirmação temporariamente para teste
        // if (confirm('Tem certeza que deseja remover este cartão fantasma?')) {
        if (true) {
            console.log('✅ Prosseguindo com remoção (sem confirmação para teste)');
            
            fetch(`/cartao-fantasma/remover/${cartaoId}`, {
                method: 'POST'
            })
            .then(response => {
                console.log('📡 Status da resposta:', response.status, response.statusText);
                console.log('📡 Headers da resposta:', Object.fromEntries(response.headers));
                return response.text().then(text => {
                    console.log('📡 Texto bruto da resposta:', text);
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('❌ Erro ao fazer parse JSON:', e);
                        throw new Error('Resposta não é JSON válido: ' + text);
                    }
                });
            })
            .then(data => {
                console.log('📡 Dados parseados da resposta:', data);
                if (data.success) {
                    console.log('✅ Remoção bem-sucedida no backend');
                    alert('Cartão fantasma removido com sucesso!');
                    window.location.reload();
                } else {
                    console.error('❌ Erro no backend:', data.message);
                    alert('Erro ao remover cartão fantasma: ' + data.message);
                }
            })
            .catch(error => {
                console.error('❌ Erro na requisição completa:', error);
                alert('Erro ao remover cartão fantasma: ' + error.message);
            });
        } else {
            console.log('❌ Usuário cancelou remoção');
        }
    }
    
    // Função para abrir modal de mover fantasma
    function abrirModalMoverFantasma(cartaoId) {
        const modal = new bootstrap.Modal(document.getElementById('moverFantasmaModal'));
        
        // Definir ID do cartão no campo oculto
        const inputCartaoId = document.getElementById('cartaoIdMover');
        if (inputCartaoId) {
            inputCartaoId.value = cartaoId;
        }
        
        // Resetar posição para 1
        const inputPosicao = document.getElementById('novaPosicao');
        if (inputPosicao) {
            inputPosicao.value = 1;
        }
        
        modal.show();
        
        // Configurar botão de confirmar se ainda não foi configurado
        const btnConfirmar = document.getElementById('btnConfirmarMoverFantasma');
        if (btnConfirmar && !btnConfirmar.classList.contains('events-initialized')) {
            btnConfirmar.addEventListener('click', function() {
                moverCartaoFantasma();
            });
            btnConfirmar.classList.add('events-initialized');
        }
    }
    
    // Função para mover cartão fantasma
    function moverCartaoFantasma() {
        const form = document.getElementById('formMoverFantasma');
        const formData = new FormData(form);
        
        console.log('🔄 Movendo cartão fantasma:', Object.fromEntries(formData));
        
        fetch('/cartao-fantasma/mover', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('📡 Status da resposta (mover):', response.status, response.statusText);
            console.log('📡 Headers da resposta (mover):', Object.fromEntries(response.headers));
            return response.text().then(text => {
                console.log('📡 Texto bruto da resposta (mover):', text);
                try {
                    return JSON.parse(text);
                } catch (e) {
                    console.error('❌ Erro ao fazer parse JSON (mover):', e);
                    throw new Error('Resposta não é JSON válido: ' + text);
                }
            });
        })
        .then(data => {
            console.log('📡 Dados parseados da resposta (mover):', data);
            if (data.success) {
                console.log('✅ Movimento bem-sucedido no backend');
                const modal = bootstrap.Modal.getInstance(document.getElementById('moverFantasmaModal'));
                modal.hide();
                alert('Posição do cartão fantasma alterada!');
                window.location.reload();
            } else {
                console.error('❌ Erro no backend (mover):', data.message);
                alert('Erro ao mover cartão fantasma: ' + data.message);
            }
        })
        .catch(error => {
            console.error('❌ Erro na requisição completa (mover):', error);
            alert('Erro ao mover cartão fantasma: ' + error.message);
        });
    }
    
    // Configurar botão de confirmar criação do fantasma
    function configurarBotaoConfirmarFantasma() {
        const btnConfirmar = document.getElementById('btnConfirmarFantasma');
        if (btnConfirmar) {
            console.log('Configurando botão confirmar fantasma');
            btnConfirmar.addEventListener('click', function() {
                console.log('Clicou em confirmar fantasma');
                criarCartaoFantasma();
            });
        } else {
            console.error('Botão confirmar fantasma não encontrado!');
        }
    }
    
    // Função para criar o cartão fantasma
    function criarCartaoFantasma() {
        const form = document.getElementById('formCriarFantasma');
        const formData = new FormData(form);
        
        console.log('Enviando dados do cartão fantasma:', Object.fromEntries(formData));
        
        fetch('/cartao-fantasma/criar', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('Resposta do servidor:', data);
            if (data.success) {
                // Fechar modal e recarregar página
                const modal = bootstrap.Modal.getInstance(document.getElementById('criarFantasmaModal'));
                modal.hide();
                
                // Mostrar sucesso e recarregar estado sem reload completo
                alert('Cartão fantasma criado com sucesso!');
                
                // Em vez de reload completo, recarregar apenas o estado dos apontamentos
                try {
                    if (typeof window.recarregarEstadoApontamentos === 'function') {
                        window.recarregarEstadoApontamentos();
                    }
                    // Forçar atualização do kanban recarregando a página após pequeno delay
                    // para permitir que o backend processe o novo cartão fantasma
                    setTimeout(() => {
                        window.location.reload();
                    }, 100);
                } catch (e) {
                    console.warn('Erro ao recarregar estado, fazendo reload completo:', e);
                    window.location.reload();
                }
            } else {
                alert('Erro ao criar cartão fantasma: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao criar cartão fantasma');
        });
    }
    
    // Função para abrir detalhes da OS (igual ao dashboard)
    function abrirDetalhesOS(ordemId) {
        // Criar modal dinamicamente se não existir
        let modal = document.getElementById('detalhesOSModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'detalhesOSModal';
            modal.setAttribute('tabindex', '-1');
            modal.setAttribute('aria-hidden', 'true');
            modal.innerHTML = `
                <div class="modal-dialog modal-xl modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Detalhes da OS #${ordemId}</h5>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="imprimirDetalhesKanban()">
                                    <i class="fas fa-print"></i> Imprimir Resumo
                                </button>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                        </div>
                        <div class="modal-body" id="conteudoDetalhesKanban">
                            <div class="d-flex align-items-center justify-content-center p-4">
                                <div class="spinner-border text-primary me-2" role="status"></div>
                                <span>Carregando detalhes...</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Mostrar modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Carregar dados via AJAX (mesmo código do dashboard)
        const conteudo = document.getElementById('conteudoDetalhesKanban');
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000);

        fetch(`/apontamento/detalhes/${ordemId}`, { signal: controller.signal })
            .then(async (response) => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const raw = await response.json();

                // Normalização de dados (igual ao dashboard)
                const data = (raw && typeof raw === 'object') ? raw : {};

                const trabalhos = Array.isArray(data.trabalhos) ? data.trabalhos : [];
                const normalizedTrabalhos = trabalhos.map((t) => ({
                    trabalho_id: t?.trabalho_id ?? null,
                    trabalho_nome: t?.trabalho_nome ?? (t?.trabalho_id ? `Trabalho #${t.trabalho_id}` : 'Trabalho'),
                    ultima_quantidade: Number(t?.ultima_quantidade || 0),
                    setup_total: Number(t?.setup_total || 0),
                    producao_total: Number(t?.producao_total || 0),
                    pausas_total: Number(t?.pausas_total || 0),
                    pausas_por_motivo: t?.pausas_por_motivo || {},
                    apontamentos: Array.isArray(t?.apontamentos) ? t.apontamentos : []
                }));

                const tempo_setup_total = Number(data?.analytics_gerais?.tempo_setup_total || 0);
                const tempo_producao_total = Number(data?.analytics_gerais?.tempo_producao_total || 0);
                const tempo_pausas_total = Number(data?.analytics_gerais?.tempo_pausas_total || 0);
                const total_tempo = tempo_setup_total + tempo_producao_total + tempo_pausas_total;

                const normalizedData = {
                    ...data,
                    trabalhos: normalizedTrabalhos,
                    analytics_gerais: {
                        ...data.analytics_gerais,
                        tempo_setup_total,
                        tempo_producao_total,
                        tempo_pausas_total,
                        tempo_total: total_tempo
                    }
                };

                renderizarDetalhesKanban(normalizedData);
            })
            .catch(error => {
                clearTimeout(timeoutId);
                console.error('Erro ao carregar detalhes:', error);
                conteudo.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erro ao carregar detalhes: ${error.message}
                    </div>
                `;
            });
    }
    
    // Função para renderizar detalhes (igual ao dashboard)
    function renderizarDetalhesKanban(data) {
        const conteudo = document.getElementById('conteudoDetalhesKanban');
        
        const formatarTempo = (segundos) => {
            if (!segundos) return '0h 0m';
            const horas = Math.floor(segundos / 3600);
            const minutos = Math.floor((segundos % 3600) / 60);
            return `${horas}h ${minutos}m`;
        };
        
        const formatarPercentual = (valor, total) => {
            if (!total) return '0%';
            return `${((valor / total) * 100).toFixed(1)}%`;
        };
        
        // Normalizar URL da imagem do item
        const imagemUrl = (data.item && data.item.imagem_path)
            ? (data.item.imagem_path.startsWith('supabase://')
                ? data.item.imagem_path.replace('supabase://', '/uploads/supabase:/')
                : data.item.imagem_path)
            : null;
        
        let html = `
            <!-- Filtros -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <label class="form-label">Filtrar por Operador:</label>
                    <select class="form-select" id="filtroOperadorKanban" onchange="aplicarFiltroOperadorKanban()">
                        <option value="">Todos os operadores</option>
                        ${Object.keys(data.analytics_operadores || {}).map(opId => 
                            `<option value="${opId}">${data.analytics_operadores[opId].nome}</option>`
                        ).join('')}
                    </select>
                </div>
            </div>
            
            <!-- Item Info -->
            ${data.item && data.item.nome ? `
            <div class="row mb-4">
                <div class="col-12">
                    <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-cube me-2"></i>Informações do Item</h6>
                    <div class="card">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-2 text-center mb-3 mb-md-0">
                                    ${imagemUrl ? `
                                        <img src="${imagemUrl}" alt="Imagem do Item" class="img-fluid rounded border" style="max-height: 120px; object-fit: contain;">
                                    ` : `
                                        <div class="d-inline-flex align-items-center justify-content-center bg-light border rounded" style="width: 120px; height: 120px;">
                                            <i class="fas fa-cube fa-2x text-muted"></i>
                                        </div>
                                    `}
                                </div>
                                <div class="col-md-5">
                                    <p class="mb-1"><strong>Nome:</strong> ${data.item.nome}</p>
                                    <p class="mb-1"><strong>Código:</strong> ${data.item.codigo || 'N/A'}</p>
                                    <p class="mb-0"><strong>Quantidade Total (OS):</strong> ${data.item.quantidade_total || 0}</p>
                                </div>
                                <div class="col-md-5">
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Cliente</th>
                                                    <th>Pedido Cliente</th>
                                                    <th class="text-end">Qtd</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${data.item.pedidos && data.item.pedidos.length > 0 ? data.item.pedidos.map(p => `
                                                    <tr>
                                                        <td>${p.cliente_nome || 'N/A'}</td>
                                                        <td>${p.numero_pedido_cliente || 'N/A'}</td>
                                                        <td class="text-end">${p.quantidade || 0}</td>
                                                    </tr>
                                                `).join('') : `
                                                    <tr>
                                                        <td colspan="3" class="text-muted text-center">Sem pedidos vinculados</td>
                                                    </tr>
                                                `}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            ` : ''}
        `;
        
        // Analytics por Tipo de Trabalho
        if (data.analytics_trabalhos) {
            html += `
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-chart-bar me-2"></i>Análise por Tipo de Trabalho</h6>
                    </div>
                </div>
            `;
            
            Object.values(data.analytics_trabalhos).forEach(trabalho => {
                html += `
                    <div class="row mb-3 align-items-stretch g-2">
                        <div class="col-12">
                            <h6 class="text-primary mb-2"><i class="fas fa-cog me-2"></i>${trabalho.trabalho_nome}</h6>
                        </div>
                        <div class="col-md-3 d-flex">
                            <div class="card bg-light h-100 w-100">
                                <div class="card-body text-center p-2">
                                    <h6 class="card-title mb-1">Setup</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Estimado</small>
                                            <div class="h6">${formatarTempo(trabalho.tempos_estimados.setup)}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Real</small>
                                            <div class="h6">${formatarTempo(trabalho.tempos_reais.setup)}</div>
                                        </div>
                                    </div>
                                    <small class="badge ${trabalho.eficiencias.setup >= 100 ? 'bg-success' : trabalho.eficiencias.setup >= 80 ? 'bg-warning' : 'bg-danger'}">${trabalho.eficiencias.setup}% eficiência</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 d-flex">
                            <div class="card bg-light h-100 w-100">
                                <div class="card-body text-center p-2">
                                    <h6 class="card-title mb-1">Produção</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Estimado</small>
                                            <div class="h6">${formatarTempo(trabalho.tempos_estimados.producao)}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Real</small>
                                            <div class="h6">${formatarTempo(trabalho.tempos_reais.producao)}</div>
                                        </div>
                                    </div>
                                    <small class="badge ${trabalho.eficiencias.producao >= 100 ? 'bg-success' : trabalho.eficiencias.producao >= 80 ? 'bg-warning' : 'bg-danger'}">${trabalho.eficiencias.producao}% eficiência</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 d-flex">
                            <div class="card bg-light h-100 w-100">
                                <div class="card-body text-center p-2">
                                    <h6 class="card-title mb-1">Total</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Estimado</small>
                                            <div class="h6">${formatarTempo(trabalho.tempos_estimados.total)}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Real</small>
                                            <div class="h6">${formatarTempo(trabalho.tempos_reais.total)}</div>
                                        </div>
                                    </div>
                                    <small class="badge ${trabalho.eficiencias.total >= 100 ? 'bg-success' : trabalho.eficiencias.total >= 80 ? 'bg-warning' : 'bg-danger'}">${trabalho.eficiencias.total}% eficiência</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 d-flex">
                            <div class="card ${trabalho.tempos_reais.pausas > 0 ? 'border-warning' : 'bg-light'} h-100 w-100">
                                <div class="card-body text-center p-2">
                                    <h6 class="card-title mb-1 ${trabalho.tempos_reais.pausas > 0 ? 'text-warning' : ''}">Pausas</h6>
                                    <div class="h6">${trabalho.tempos_reais.pausas > 0 ? formatarTempo(trabalho.tempos_reais.pausas) : '0h 0m'}</div>
                                    <small class="text-muted">Tempo perdido</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // Resumo Geral Comparativo
        html += `
            <div class="row mb-4">
                <div class="col-12">
                    <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-balance-scale me-2"></i>Resumo Geral</h6>
                </div>
                <div class="col-md-6">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-clock me-2"></i>Tempos Estimados</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="mb-2">
                                        <i class="fas fa-tools text-primary"></i>
                                        <div class="fw-bold">${formatarTempo(data.analytics_gerais.tempo_setup_estimado_total)}</div>
                                        <small class="text-muted">Setup</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="mb-2">
                                        <i class="fas fa-cogs text-success"></i>
                                        <div class="fw-bold">${formatarTempo(data.analytics_gerais.tempo_producao_estimado_total)}</div>
                                        <small class="text-muted">Produção</small>
                                    </div>
                                </div>
                            </div>
                            <hr class="my-2">
                            <div class="text-center">
                                <div class="fw-bold text-info">${formatarTempo(data.analytics_gerais.tempo_estimado_total)}</div>
                                <small class="text-muted">Total Estimado</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="fas fa-stopwatch me-2"></i>Tempos Reais</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="mb-2">
                                        <i class="fas fa-tools text-primary"></i>
                                        <div class="fw-bold">${formatarTempo(data.analytics_gerais.tempo_setup_total)}</div>
                                        <small class="text-muted">Setup</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="mb-2">
                                        <i class="fas fa-cogs text-success"></i>
                                        <div class="fw-bold">${formatarTempo(data.analytics_gerais.tempo_producao_total)}</div>
                                        <small class="text-muted">Produção</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="mb-2">
                                        <i class="fas fa-pause text-warning"></i>
                                        <div class="fw-bold">${formatarTempo(data.analytics_gerais.tempo_pausas_total)}</div>
                                        <small class="text-muted">Pausas</small>
                                    </div>
                                </div>
                            </div>
                            <hr class="my-2">
                            <div class="text-center">
                                <div class="fw-bold text-warning">${formatarTempo(data.analytics_gerais.tempo_setup_total + data.analytics_gerais.tempo_producao_total + data.analytics_gerais.tempo_pausas_total)}</div>
                                <small class="text-muted">Total Real</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Eficiência e Performance -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card ${data.analytics_gerais.eficiencia_percentual >= 80 ? 'bg-success' : data.analytics_gerais.eficiencia_percentual >= 60 ? 'bg-warning' : 'bg-danger'} text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-tachometer-alt fa-2x mb-2"></i>
                            <h4 class="card-title">${data.analytics_gerais.eficiencia_percentual}%</h4>
                            <p class="card-text">Eficiência Produtiva</p>
                            <small>Produção / Tempo Total</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card ${(data.analytics_gerais.tempo_producao_total <= data.analytics_gerais.tempo_producao_estimado_total) ? 'bg-success' : 'bg-danger'} text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-chart-line fa-2x mb-2"></i>
                            <h4 class="card-title">${data.analytics_gerais.tempo_producao_estimado_total > 0 ? Math.round((data.analytics_gerais.tempo_producao_total / data.analytics_gerais.tempo_producao_estimado_total) * 100) : 0}%</h4>
                            <p class="card-text">Performance Produção</p>
                            <small>Real / Estimado</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card ${(data.analytics_gerais.tempo_setup_total <= data.analytics_gerais.tempo_setup_estimado_total) ? 'bg-success' : 'bg-danger'} text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-tools fa-2x mb-2"></i>
                            <h4 class="card-title">${data.analytics_gerais.tempo_setup_estimado_total > 0 ? Math.round((data.analytics_gerais.tempo_setup_total / data.analytics_gerais.tempo_setup_estimado_total) * 100) : 0}%</h4>
                            <p class="card-text">Performance Setup</p>
                            <small>Real / Estimado</small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Análise por Tipo de Trabalho
        if (data.trabalhos && data.trabalhos.length > 0) {
            html += `
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-list me-2"></i>Análise por Tipo de Trabalho</h6>
                    </div>
                </div>
            `;
            
            data.trabalhos.forEach(trabalho => {
                const setupTotal = Number(trabalho.setup_total || 0);
                const producaoTotal = Number(trabalho.producao_total || 0);
                const pausasTotal = Number(trabalho.pausas_total || 0);
                const pausasPorMotivo = trabalho.pausas_por_motivo || {};
                const apontamentos = Array.isArray(trabalho.apontamentos) ? trabalho.apontamentos : [];
                const trabalhoNome = trabalho.trabalho_nome || (trabalho.trabalho_id ? `Trabalho #${trabalho.trabalho_id}` : 'Trabalho');
                
                html += `
                    <div class="row mb-4 trabalho-section" data-trabalho="${trabalhoNome}">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-wrench me-2"></i>${trabalhoNome}</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <small class="text-muted">Setup:</small>
                                            <div class="h5 text-primary">${formatarTempo(setupTotal)}</div>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">Produção:</small>
                                            <div class="h5 text-success">${formatarTempo(producaoTotal)}</div>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">Pausas:</small>
                                            <div class="h5 text-warning">${formatarTempo(pausasTotal)}</div>
                                        </div>
                                    </div>
                                    
                                    ${Object.keys(pausasPorMotivo).length > 0 ? `
                                    <div class="mb-3">
                                        <small class="text-muted">Pausas por Motivo:</small>
                                        <div class="row">
                                            ${Object.entries(pausasPorMotivo).map(([motivo, tempo]) => `
                                                <div class="col-md-6">
                                                    <div class="d-flex justify-content-between">
                                                        <span>${motivo}:</span>
                                                        <span class="text-warning">${formatarTempo(tempo)} (${formatarPercentual(tempo, pausasTotal)})</span>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                    ` : ''}
                                    
                                    <!-- Cronologia Detalhada -->
                                    <div class="mb-3">
                                        <small class="text-muted">Cronologia de Apontamentos:</small>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Data/Hora</th>
                                                        <th>Ação</th>
                                                        <th>Operador</th>
                                                        <th>Duração</th>
                                                        <th>Quantidade</th>
                                                        <th>Observações</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${apontamentos.map(ap => `
                                                        <tr class="apontamento-row" data-operador="${ap.operador_id || ''}">
                                                            <td>${ap.data_hora ? new Date(ap.data_hora).toLocaleString('pt-BR') : '-'}</td>
                                                            <td>
                                                                <span class="badge ${
                                                                    (ap.tipo_acao || '').includes('setup') ? 'bg-primary' :
                                                                    (ap.tipo_acao || '').includes('producao') ? 'bg-success' :
                                                                    (ap.tipo_acao || '').includes('pausa') ? 'bg-warning' : 'bg-secondary'
                                                                }">${ap.tipo_acao || '-'}</span>
                                                            </td>
                                                            <td>${ap.operador_nome || '-'}</td>
                                                            <td>${ap.duracao_segundos ? formatarTempo(ap.duracao_segundos) : '-'}</td>
                                                            <td>${(ap.quantidade ?? '-') }</td>
                                                            <td>${ap.motivo_pausa || '-'}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        // Analytics por Operador
        if (Object.keys(data.analytics_operadores || {}).length > 0) {
            html += `
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-users me-2"></i>Resumo por Operador</h6>
                    </div>
                </div>
            `;
            
            Object.entries(data.analytics_operadores).forEach(([opId, operador]) => {
                html += `
                    <div class="row mb-3 operador-section" data-operador="${opId}">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0"><i class="fas fa-user me-2"></i>${operador.nome}</h6>
                                    <span class="badge bg-secondary">Qtd total: ${operador.quantidade_total || 0}</span>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <small class="text-muted">Setup Total:</small>
                                            <div class="h6 text-primary">${formatarTempo(operador.tempo_setup)}</div>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">Produção Total:</small>
                                            <div class="h6 text-success">${formatarTempo(operador.tempo_producao)}</div>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">Pausas Total:</small>
                                            <div class="h6 text-warning">${formatarTempo(operador.tempo_pausas)}</div>
                                        </div>
                                    </div>
                                    
                                    ${Object.keys(operador.trabalhos || {}).length > 0 ? `
                                    <div>
                                        <small class="text-muted">Por Tipo de Trabalho:</small>
                                        <div class="table-responsive">
                                            <table class="table table-sm">
                                                <thead>
                                                    <tr>
                                                        <th>Trabalho</th>
                                                        <th class="text-end">Setup</th>
                                                        <th class="text-end">Produção</th>
                                                        <th class="text-end">Pausas</th>
                                                        <th class="text-end">Qtd</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${Object.entries(operador.trabalhos).map(([trabalhoNome, tempos]) => `
                                                        <tr>
                                                            <td>${trabalhoNome}</td>
                                                            <td class="text-primary text-end">${formatarTempo(tempos.tempo_setup)}</td>
                                                            <td class="text-success text-end">${formatarTempo(tempos.tempo_producao)}</td>
                                                            <td class="text-warning text-end">${formatarTempo(tempos.tempo_pausas)}</td>
                                                            <td class="text-end fw-bold">${(tempos.quantidade ?? 0)}</td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        conteudo.innerHTML = html;
    }
    
    // Função para aplicar filtro de operador no modal do Kanban
    function aplicarFiltroOperadorKanban() {
        const filtroOperador = document.getElementById('filtroOperadorKanban');
        const operadorSelecionado = filtroOperador ? filtroOperador.value : '';
        
        // Filtrar seções de operadores
        const operadorSections = document.querySelectorAll('.operador-section');
        operadorSections.forEach(section => {
            const operadorId = section.dataset.operador;
            if (!operadorSelecionado || operadorId === operadorSelecionado) {
                section.style.display = 'block';
            } else {
                section.style.display = 'none';
            }
        });
        
        // Filtrar linhas de apontamentos na tabela cronológica
        const linhasApontamento = document.querySelectorAll('.apontamento-row');
        linhasApontamento.forEach(linha => {
            const operadorLinha = linha.getAttribute('data-operador');
            if (!operadorSelecionado || operadorLinha === operadorSelecionado) {
                linha.style.display = '';
            } else {
                linha.style.display = 'none';
            }
        });
    }
    
    // Função para imprimir detalhes do modal Kanban (versão resumida)
    function imprimirDetalhesKanban() {
        const conteudo = document.getElementById('conteudoDetalhesKanban');
        if (!conteudo) {
            alert('Nenhum conteúdo para imprimir');
            return;
        }
        
        let conteudoImpressao = '';
        
        // Buscar seções usando métodos mais compatíveis
        const todasRows = conteudo.querySelectorAll('.row');
        
        // Informações do Item
        todasRows.forEach(row => {
            const h6 = row.querySelector('h6');
            if (h6 && h6.textContent.includes('Informações do Item')) {
                conteudoImpressao += row.outerHTML;
            }
        });
        
        // Analytics por Tipo de Trabalho
        todasRows.forEach(row => {
            const h6 = row.querySelector('h6');
            if (h6 && h6.textContent.includes('Análise por Tipo de Trabalho')) {
                conteudoImpressao += row.outerHTML;
                // Buscar as próximas rows que contêm os trabalhos
                let nextRow = row.nextElementSibling;
                // Incluir apenas as linhas de trabalhos até o próximo cabeçalho de seção (h6 com border-bottom)
                while (nextRow && nextRow.classList.contains('row') && !nextRow.querySelector('h6.border-bottom')) {
                    // As linhas de trabalho possuem títulos h6.text-primary
                    if (nextRow.querySelector('h6.text-primary')) {
                        conteudoImpressao += nextRow.outerHTML;
                    }
                    nextRow = nextRow.nextElementSibling;
                }
            }
        });
        
        // Resumo Geral
        todasRows.forEach(row => {
            const h6 = row.querySelector('h6');
            if (h6 && h6.textContent.includes('Resumo Geral')) {
                conteudoImpressao += row.outerHTML;
            }
        });
        
        // Métricas de Eficiência
        todasRows.forEach(row => {
            const cards = row.querySelectorAll('.card');
            cards.forEach(card => {
                if (card.textContent.includes('Eficiência') || card.textContent.includes('Performance')) {
                    if (!conteudoImpressao.includes(row.outerHTML)) {
                        conteudoImpressao += row.outerHTML;
                    }
                }
            });
        });
        
        // Resumo por Operador (sem linhas individuais de apontamentos)
        const operadorSections = conteudo.querySelectorAll('.operador-section');
        if (operadorSections.length > 0) {
            conteudoImpressao += '<div class="row mb-4"><div class="col-12"><h6 class="border-bottom pb-2 mb-3"><i class="fas fa-users me-2"></i>Resumo por Operador</h6></div></div>';
            operadorSections.forEach(section => {
                const clone = section.cloneNode(true);
                // Remover quaisquer linhas cronológicas de apontamento, se existirem
                clone.querySelectorAll('.apontamento-row').forEach(el => el.remove());
                conteudoImpressao += clone.outerHTML;
            });
        }
        
        // Se não encontrou conteúdo específico, evitar imprimir apontamentos
        if (!conteudoImpressao.trim()) {
            conteudoImpressao = '<div class="row"><div class="col-12"><p class="text-muted">Sem métricas disponíveis para impressão.</p></div></div>';
        }
        
        // Imprimir via iframe oculto (sem abrir nova janela)
        const iframe = document.createElement('iframe');
        iframe.style.position = 'fixed';
        iframe.style.right = '0';
        iframe.style.bottom = '0';
        iframe.style.width = '0';
        iframe.style.height = '0';
        iframe.style.border = '0';
        document.body.appendChild(iframe);

        const doc = iframe.contentDocument || iframe.contentWindow.document;
        doc.open();
        doc.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Resumo de Apontamentos - Impressão</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
                <style>
                    @page { size: A4; margin: 12mm; }
                    @media print {
                        html, body, * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                        .no-print, .btn { display: none !important; }
                        body { font-size: 10pt; line-height: 1.2; margin: 0; padding: 0; }
                        .card { break-inside: avoid; margin-bottom: 8px; border: 1px solid #ddd; page-break-inside: avoid; background-color: #ffffff !important; }
                        .card-body { padding: 6px; }
                        .table { font-size: 9pt; margin-bottom: 5px; color: inherit !important; }
                        .table thead th { background-color: #f8f9fa !important; color: #000 !important; }
                        .row { margin-bottom: 5px; break-inside: avoid; page-break-inside: avoid; }
                        h6 { font-size: 11pt; font-weight: bold; margin-bottom: 5px; }
                        .h6, .h5, .h4 { font-size: 10pt; margin-bottom: 3px; }
                        .print-header { margin-bottom: 10px; padding-bottom: 5px; border-bottom: 2px solid #333 !important; }
                        .print-header h2 { font-size: 16pt; margin-bottom: 3px; }
                        .print-header h4 { font-size: 12pt; margin-bottom: 3px; }
                        .print-header p { font-size: 9pt; margin-bottom: 0; }
                        /* Reaplicar cores removidas por resets */
                        .bg-primary { background-color: #0d6efd !important; color: #fff !important; }
                        .bg-secondary { background-color: #6c757d !important; color: #fff !important; }
                        .bg-success { background-color: #198754 !important; color: #fff !important; }
                        .bg-info { background-color: #0dcaf0 !important; color: #000 !important; }
                        .bg-warning { background-color: #ffc107 !important; color: #000 !important; }
                        .bg-danger { background-color: #dc3545 !important; color: #fff !important; }
                        .bg-light { background-color: #f8f9fa !important; color: #000 !important; }
                        .bg-dark { background-color: #212529 !important; color: #fff !important; }
                        .text-white { color: #fff !important; }
                        .badge.bg-primary { background-color: #0d6efd !important; color: #fff !important; }
                        .badge.bg-secondary { background-color: #6c757d !important; color: #fff !important; }
                        .badge.bg-success { background-color: #198754 !important; color: #fff !important; }
                        .badge.bg-info { background-color: #0dcaf0 !important; color: #000 !important; }
                        .badge.bg-warning { background-color: #ffc107 !important; color: #000 !important; }
                        .badge.bg-danger { background-color: #dc3545 !important; color: #fff !important; }
                        .badge.bg-light { background-color: #f8f9fa !important; color: #000 !important; }
                        .badge.bg-dark { background-color: #212529 !important; color: #fff !important; }
                        .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6 { flex: 0 0 auto; width: auto; }
                        .container-fluid { max-width: 100%; padding: 0; }
                        .border-bottom { border-bottom: 1px solid #333 !important; }
                        .text-center { text-align: center; }
                        .badge { font-size: 8pt; padding: 2px 4px; }
                        img { max-height: 40px !important; max-width: 40px !important; }
                        .operador-section { margin-bottom: 8px; }
                        .operador-section .card-body { padding: 4px; }
                        .operador-section .table { font-size: 8pt; }
                        .small, small { font-size: 8pt; }
                        [class^="col-"], [class*=" col-"] { break-inside: avoid; page-break-inside: avoid; }
                    }
                    body { font-family: Arial, sans-serif; font-size: 12px; }
                    .print-header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 8px; }
                </style>
            </head>
            <body>
                <div class="container-fluid">
                    <div class="print-header">
                        <h2>ACB Usinagem CNC</h2>
                        <h4>Resumo de Apontamentos</h4>
                        <p>Data: ${new Date().toLocaleString('pt-BR')}</p>
                    </div>
                    ${conteudoImpressao}
                </div>
            </body>
            </html>
        `);
        doc.close();

        // Aguardar renderização antes de imprimir
        setTimeout(() => {
            try {
                iframe.contentWindow.focus();
                iframe.contentWindow.print();
            } catch (e) {
                console.error('Erro ao imprimir:', e);
                alert('Erro ao imprimir. Tente novamente.');
            } finally {
                setTimeout(() => document.body.removeChild(iframe), 1200);
            }
        }, 600);
    }
    
</script>

</body>
</html>
