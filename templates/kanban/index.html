<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban - ACB Usinagem CNC</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.1/Sortable.min.js"></script>
    <link rel="stylesheet" href="/static/css/kanban-sortable.css">
    <style>
        body {
            background-color: #f0f2f5;
        }
        .kanban-container {
            display: flex;
            overflow-x: auto;
            padding: 1rem 0;
            min-height: calc(100vh - 150px);
        }
        .kanban-column {
            min-width: 280px;
            max-width: 280px;
            margin-right: 1rem;
            background-color: #ebecf0;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }
        .kanban-column-header {
            padding: 0.75rem;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .kanban-column-body {
            padding: 0.75rem;
            flex-grow: 1;
            overflow-y: auto;
            max-height: calc(100vh - 220px);
        }
        .kanban-card {
            background-color: white;
            border-radius: 0.25rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.15);
            cursor: grab;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            /* Prevenir sele√ß√£o de texto durante o arrasto */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            position: relative;
        }
        .kanban-card:active { cursor: grabbing; }
        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .kanban-card-header {
            font-weight: bold;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }
        .card-header-main { display: flex; align-items: center; gap: 8px; min-width: 0; }
        .card-header-actions { display: flex; align-items: center; gap: 6px; margin-left: auto; }
        .item-thumb { width: 48px; height: 48px; object-fit: cover; }
        /* T√≠tulo da OS maior */
        .kanban-card-header .card-title { font-size: 1.2rem; line-height: 1.2; font-weight: 600; }
        /* N√∫mero nos cart√µes fantasma maior */
        .kanban-card.fantasma .fantasma-info strong { font-size: 1.4rem; }
        /* Nome do item (Itens da OS) maior */
        .kanban-card .os-item-name { font-size: 1.2rem; font-weight: 600; }
        /* Quantidade (badge) proporcional ao nome do item */
        .kanban-card .os-item-qty { font-size: 1.05rem; padding: 0.2rem 0.55rem; }
        /* Responsivo: reduzir um pouco em telas pequenas */
        @media (max-width: 576px) {
            .kanban-card-header .card-title { font-size: 1.1rem; }
            .kanban-card.fantasma .fantasma-info strong { font-size: 1.2rem; }
            .kanban-card .os-item-name { font-size: 1.05rem; }
            .kanban-card .os-item-qty { font-size: 0.95rem; }
        }
        .kanban-card-body {
            font-size: 0.875rem;
        }
        .kanban-card-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #6c757d;
        }
        .column-counter {
            background-color: #6c757d;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }
        .column-stats {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 5px;
        }
        .column-time {
            background-color: #17a2b8;
            color: white;
            padding: 2px 5px;
        }
        
        /* Estilos para o timer de apontamento */
        .apontamento-timer {
            font-weight: bold;
            font-size: 1em;
            color: #fff;
            background-color: #28a745;
            padding: 2px 6px;
            border-radius: 4px;
            display: none;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        /* Exibir o timer quando o status estiver ativo */
        .status-setup .status-apontamento .apontamento-timer,
        .status-producao .status-apontamento .apontamento-timer,
        .status-pausado .status-apontamento .apontamento-timer {
            display: inline-block;
        }
        
        /* Cores diferentes para cada tipo de status */
        .status-setup .apontamento-timer {
            background-color: #007bff;
        }
        
        .status-pausado .apontamento-timer {
            background-color: #ffc107;
            color: #212529;
        }
        
        /* Estilo para o campo de status */
        .status-apontamento {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        
        .status-apontamento small {
            margin-right: 5px;
        }
        /* Chips por trabalho (tipo + timer) */
        .apontamento-chip {
            display: inline-block;
            background-color: #e9ecef;
            color: #212529;
            padding: 6px 8px;
            border-radius: 6px;
            margin-right: 6px;
            margin-top: 4px;
            line-height: 1.15;
        }
        .apontamento-chip .chip-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .apontamento-chip .chip-col {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 120px;
        }
        .apontamento-chip .chip-title { font-weight: 600; }
        .apontamento-chip .chip-op { opacity: 0.9; }
        .apontamento-chip .chip-motivo { display: block; margin-top: 2px; opacity: 0.95; }
        .apontamento-chip .apontamento-timer { margin-left: auto; padding: 2px 6px; border-radius: 4px; font-weight: 700; }
        /* Cores por tipo de status no chip */
        .apontamento-chip.chip-setup {
            background-color: #0d6efd; /* azul bootstrap */
            color: #fff;
        }
        .apontamento-chip.chip-setup .apontamento-timer { background-color: rgba(255,255,255,0.2); }
        .apontamento-chip.chip-producao {
            background-color: #198754; /* verde bootstrap */
            color: #fff;
        }
        .apontamento-chip.chip-producao .apontamento-timer { background-color: rgba(255,255,255,0.2); }
        .apontamento-chip.chip-pausa {
            background-color: #ffc107; /* amarelo */
            color: #212529;
        }
        .apontamento-chip.chip-pausa .apontamento-timer { background-color: rgba(0,0,0,0.1); }
        
        /* Remover o indicador de status do cabe√ßalho */
        .status-indicador {
            display: none;
            border-radius: 3px;
            margin-right: 5px;
        }
        .column-quantity {
            background-color: #28a745;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
        }
        /* .item-badge (DEPRECATED) substitu√≠da por .metric-badge em .card-metrics */
        .modal-xl {
            max-width: 90%;
        }
        .card-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        .card-actions .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
        .item-quantity {
            font-weight: bold;
            color: #0d6efd;
        }
        .drag-handle { display: none; }
        /* Estilos para o Sortable.js */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #c8ebfb;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }
        .sortable-chosen {
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: scale(1.02);
            z-index: 100;
        }
        .sortable-drag {
            opacity: 0.8;
            transform: rotate(1deg);
        }
        /* .tempo-total (DEPRECATED) consolidado em .metric-badge.metric-tempo */
        /* M√©tricas compactas do card (itens, pe√ßas, tempo) */
        .card-metrics {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
            margin-bottom: 6px;
        }
        
        /* Estilos para cart√µes fantasma */
        .kanban-card.fantasma {
            opacity: 0.85;
            border: 2px dashed #6f42c1;
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(111,66,193,0.05) 100%);
            position: relative;
        }
        
        .kanban-card.fantasma::before {
            content: "üëª";
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 16px;
            z-index: 10;
        }
        
        .kanban-card.fantasma::after {
            content: "FANTASMA";
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 8px;
            font-weight: bold;
            color: #6f42c1;
            background: rgba(111,66,193,0.1);
            padding: 2px 4px;
            border-radius: 3px;
            z-index: 10;
        }
        
        .kanban-card.fantasma .kanban-card-header {
            margin-top: 15px; /* Espa√ßo para os badges fantasma */
        }
        
        .fantasma-info {
            background-color: rgba(111,66,193,0.1);
            border: 1px solid rgba(111,66,193,0.3);
            border-radius: 4px;
            padding: 6px 8px;
            margin-bottom: 8px;
            font-size: 0.75rem;
        }
        
        .fantasma-posicao {
            background-color: #6f42c1;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            margin-right: 5px;
        }
        
        .fantasma-actions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }
        
        .btn-fantasma {
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
        }
        
        /* Bot√£o para criar cart√£o fantasma */
        .btn-criar-fantasma {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            background-color: #6f42c1;
            border-color: #6f42c1;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        
        .kanban-column:hover .btn-criar-fantasma {
            opacity: 1;
        }
        
        /* Bot√£o fantasma direto no cart√£o */
        .btn-outline-purple {
            border-color: #6f42c1;
            color: #6f42c1;
        }
        
        .btn-outline-purple:hover {
            background-color: #6f42c1;
            border-color: #6f42c1;
            color: white;
        }
        .metric-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
        }
        .metric-badge i { font-size: 0.9em; opacity: 0.85; }
        .metric-items { background-color: #0dcaf0; color: #0b2239; }
        .metric-pecas { background-color: #198754; color: #fff; }
        .metric-tempo { background-color: #f1f3f5; color: #0d6efd; border: 1px solid #dee2e6; }
        .dropdown-menu {
            max-height: 300px;
            overflow-y: auto;
        }
        /* Quantidades por trabalho (QPT) */
        .qpt-list { margin: 4px 0 0; padding: 0; }
        .qpt-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 4px 8px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
            margin-bottom: 4px;
        }
        .qpt-item:hover { background: #f1f3f5; }
        .qpt-label { font-size: 0.80rem; color: #495057; }
        .qpt-itemcode { color: #6c757d; font-weight: 500; }
        .qpt-qty { font-size: 0.75rem; background: #e2e3e5 !important; color: #343a40; }
        /* Itens da OS (nome + quantidade) */
        .os-item-list { margin: 4px 0 0; padding: 0; }
        .os-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 4px 8px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #ffffff;
            margin-bottom: 4px;
        }
        .os-item:hover { background: #f8f9fa; }
        .os-item-name { font-size: 0.85rem; color: #212529; font-weight: 500; }
        .os-item-qty { font-size: 0.75rem; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">ACB Usinagem CNC</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-home"></i> Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/kanban"><i class="fas fa-columns"></i> Kanban</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/apontamento/dashboard"><i class="fas fa-chart-bar"></i> Dashboard Apontamento</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/listas"><i class="fas fa-cog"></i> Listas Kanban</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/registros-mensais"><i class="fas fa-archive"></i> Registros Mensais</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-3">
        <h1 class="mb-4">Kanban ACB</h1>
        
        <div class="kanban-container">
            {% for lista in listas %}
            <div class="kanban-column" id="column-{{ lista|lower|replace(' ', '-') }}">
                <div class="kanban-column-header">
                    <span>{{ lista }}</span>
                    <span class="column-counter">{{ ordens[lista]|length }}</span>
                </div>
                <div class="column-stats">
                    {% set horas = (tempos_listas[lista] // 3600) %}
                    {% set minutos = ((tempos_listas[lista] % 3600) // 60) %}
                    {% set segundos = (tempos_listas[lista] % 60) %}
                    <span class="column-time"><i class="fas fa-clock"></i> 
                        {% if horas > 0 %}
                            {{ horas }}h {{ "%02d"|format(minutos) }}:{{ "%02d"|format(segundos) }}
                        {% else %}
                            {{ "%02d"|format(minutos) }}:{{ "%02d"|format(segundos) }}
                        {% endif %}
                    </span>
                    <span class="column-quantity"><i class="fas fa-cubes"></i> {{ quantidades_listas[lista] }}</span>
                </div>
                <div class="kanban-column-body" data-lista="{{ lista }}">
                    <!-- Cart√µes normais -->
                    {% for ordem in ordens[lista] %}
                    <div class="kanban-card" data-ordem-id="{{ ordem.id }}">
                        <div class="kanban-card-header">
                            <div class="card-header-main">
                                <div class="drag-handle" onclick="event.stopPropagation()">
                                    <i class="fas fa-grip-lines"></i>
                                </div>
                                {% if ordem.pedidos and ordem.pedidos[0].pedido.item and ordem.pedidos[0].pedido.item.imagem_path %}
                                    <img src="{{ ordem.pedidos[0].pedido.item.imagem_path }}" width="48" height="48" class="item-thumb rounded me-2" alt="Imagem do item">
                                {% endif %}
                                <span class="card-title" data-ordem-id="{{ ordem.id }}">{{ ordem.numero }}</span>
                            </div>
                            <div class="card-header-actions">
                                {% if lista != 'Expedi√ß√£o' %}
                                    <!-- Bot√£o fantasma direto -->
                                    <button class="btn btn-sm btn-outline-purple btn-criar-fantasma-direto" 
                                            type="button" 
                                            data-ordem-id="{{ ordem.id }}" 
                                            data-lista-origem="{{ lista }}"
                                            onclick="event.stopPropagation()" 
                                            title="Criar cart√£o fantasma desta OS">
                                        <i class="fas fa-ghost"></i>
                                    </button>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                                id="dropdownMenuButton{{ ordem.id }}" data-bs-toggle="dropdown" 
                                                aria-expanded="false" onclick="event.stopPropagation()">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton{{ ordem.id }}">
                                            {% for lista_destino in listas %}
                                                {% if lista_destino != lista and lista_destino not in ['Entrada','Expedi√ß√£o'] %}
                                                    <li><a class="dropdown-item btn-mover" href="#" data-ordem-id="{{ ordem.id }}" data-lista-destino="{{ lista_destino }}">Mover para {{ lista_destino }}</a></li>
                                                {% endif %}
                                            {% endfor %}
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item text-purple btn-criar-fantasma-menu" href="#" data-ordem-id="{{ ordem.id }}" data-lista-origem="{{ lista }}"><i class="fas fa-ghost"></i> Criar cart√£o fantasma</a></li>
                                        </ul>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="kanban-card-body">
                            {% if ordem.pedidos %}
                                {% set total_items = 0 %}
                                {% set total_qty = 0 %}
                                {% set grouped_items = {} %}
                                {% set tem_desenho = false %}
                                {% set tem_programas = false %}
                                {% set pedido_primeiro = None %}
                                
                                {% for pedido_os in ordem.pedidos %}
                                    {% if loop.index == 1 %}
                                        {% set pedido_primeiro = pedido_os %}
                                    {% endif %}
                                    
                                    {% set item_key = pedido_os.pedido.item_id if pedido_os.pedido.item_id else pedido_os.pedido.nome_item %}
                                    {% set item_name = pedido_os.pedido.item.codigo_acb ~ ' - ' ~ pedido_os.pedido.item.nome if pedido_os.pedido.item_id else pedido_os.pedido.nome_item %}
                                    
                                    {% if pedido_os.pedido.item and pedido_os.pedido.item.desenho_path %}
                                        {% set tem_desenho = true %}
                                    {% endif %}
                                    
                                    {% if pedido_os.pedido.item and pedido_os.pedido.item.arquivos_cnc %}
                                        {% set tem_programas = true %}
                                    {% endif %}
                                    
                                    {% if item_key in grouped_items %}
                                        {% set _ = grouped_items[item_key].update({
                                            'total_qty': grouped_items[item_key].total_qty 
                                                          + pedido_os.pedido.quantidade
                                        }) %}
                                    {% else %}
                                        {% set _ = grouped_items.update({
                                            item_key: {
                                                'name': item_name,
                                                'total_qty': pedido_os.pedido.quantidade,
                                                'item': pedido_os.pedido.item if pedido_os.pedido.item_id else None
                                            }
                                        }) %}
                                    {% endif %}
                                {% endfor %}

                                <div class="document-icons">
                                    {% if tem_desenho %}
                                    <span class="document-icon pdf-icon toggle-pdf" data-container-id="pdf-container-{{ ordem.id }}">
                                        <i class="fas fa-file-pdf"></i>
                                        <small class="ms-1">Desenho</small>
                                    </span>
                                    {% endif %}
                                    {% if tem_programas %}
                                    <span class="document-icon cnc-icon toggle-cnc" data-container-id="cnc-container-{{ ordem.id }}">
                                        <i class="fas fa-file-code"></i>
                                        <small class="ms-1">Programas</small>
                                    </span>
                                    {% endif %}
                                </div>
                                
                                <!-- Container de desenho (oculto por padr√£o) -->
                                {% if tem_desenho and pedido_primeiro and pedido_primeiro.pedido.item.desenho_path %}
                                <div id="pdf-container-{{ ordem.id }}" class="document-container pdf-container">
                                    <div class="mb-2">
                                        <strong>Desenho do Item:</strong>
                                    </div>
                                    <a href="{{ pedido_primeiro.pedido.item.desenho_path }}" class="file-link" target="_blank">
                                        <i class="fas fa-file-pdf pdf-icon"></i>
                                        Visualizar PDF
                                    </a>
                                </div>
                                {% endif %}
                                
                                <!-- Container de programas CNC (oculto por padr√£o) -->
                                {% if tem_programas %}
                                <div id="cnc-container-{{ ordem.id }}" class="document-container cnc-container">
                                    <div class="mb-2">
                                        <strong>Programas CNC:</strong>
                                    </div>
                                    {% for item_key, item_data in grouped_items.items() %}
                                        {% if item_data.item and item_data.item.arquivos_cnc %}
                                            {% for arquivo in item_data.item.arquivos_cnc %}
                                                <a href="/arquivos/cnc/{{ arquivo.arquivo_path }}" class="file-link" download>
                                                    <i class="fas fa-file-code cnc-icon"></i>
                                                    {{ arquivo.nome_original }}
                                                </a>
                                            {% endfor %}
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                {% endif %}
                        
                            {% else %}
                                <div class="text-muted"><small>Sem pedidos</small></div>
                             {% endif %}
                             
                            <!-- Itens da OS: nome do item + quantidade -->
                             {% if grouped_items and grouped_items|length > 0 %}
                             <div class="os-items mt-1">
                                 <div class="small text-muted">Itens da OS</div>
                                 <ul class="os-item-list list-unstyled mb-1">
                                     {% for item_key, item_data in grouped_items.items() %}
                                     <li class="os-item">
                                         <span class="os-item-name">{{ item_data.name }}</span>
                                         <span class="badge rounded-pill bg-primary os-item-qty" title="Quantidade do item">{{ item_data.total_qty }}</span>
                                     </li>
                                     {% endfor %}
                                 </ul>
                             </div>
                             {% endif %}

                             <!-- Quantidades por trabalho (sempre vis√≠vel) -->
                             <div class="qtd-por-trabalho mt-1" id="qtd-por-trabalho-{{ ordem.id }}">
                                 <div class="small text-muted d-flex justify-content-between align-items-center">
                                     <span>Quantidades por trabalho</span>
                                     <span class="badge rounded-pill bg-secondary ultima-qtd" id="ultima-qtd-{{ ordem.id }}" title="√öltimo apontamento">-</span>
                                 </div>
                                 <ul class="qpt-list list-unstyled mb-1">
                                     <li class="qpt-item">
                                         <span class="qpt-label">-</span>
                                         <span class="badge rounded-pill bg-secondary qpt-qty" title="√öltimo apontamento">-</span>
                                     </li>
                                 </ul>
                             </div>

                             {% if acesso_kanban and lista not in ['Entrada', 'Expedi√ß√£o'] %}
                             <div class="apontamento-buttons mt-2 pt-2 border-top">
                                 <div class="row g-1">
                                     <!-- Grupo Setup -->
                                     <div class="col-6">
                                         <button class="btn btn-outline-primary btn-sm w-100 apontamento-btn" 
                                                 data-acao="inicio_setup"
                                                 data-ordem-id="{{ ordem.id }}"
                                                 onclick="iniciarApontamentoSetup(this.dataset.ordemId);"
                                                 title="Iniciar Setup">
                                             <i class="fas fa-play"></i> Setup
                                         </button>
                                     </div>
                                     <div class="col-6">
                                         <button class="btn btn-outline-info btn-sm w-100 apontamento-btn" 
                                                 data-acao="fim_setup"
                                                 data-ordem-id="{{ ordem.id }}"
                                                 onclick="finalizarSetup(this.dataset.ordemId);"
                                                 title="Finalizar Setup">
                                             <i class="fas fa-stop"></i> Fim Setup
                                         </button>
                                     </div>

                                     <!-- Grupo Produ√ß√£o -->
                                     <div class="col-6">
                                         <button class="btn btn-outline-success btn-sm w-100 apontamento-btn" 
                                                 data-acao="inicio_producao"
                                                 data-ordem-id="{{ ordem.id }}"
                                                 onclick="iniciarApontamentoProducao(this.dataset.ordemId);"
                                                 title="Iniciar Produ√ß√£o">
                                             <i class="fas fa-cogs"></i> Produ√ß√£o
                                         </button>
                                     </div>
                                     <div class="col-6">
                                         <button class="btn btn-outline-warning btn-sm w-100 apontamento-btn" 
                                                 data-acao="pausa"
                                                 data-ordem-id="{{ ordem.id }}"
                                                 onclick="pausarApontamento(this.dataset.ordemId);"
                                                 title="Pausar produ√ß√£o">
                                             <i class="fas fa-pause"></i> Pausa
                                         </button>
                                     </div>
                                     <div class="col-12">
                                         <button class="btn btn-outline-danger btn-sm w-100 apontamento-btn" 
                                                 data-acao="stop"
                                                 data-ordem-id="{{ ordem.id }}"
                                                 onclick="pararApontamento(this.dataset.ordemId);"
                                                 title="Stop (fim de turno / parada entre turnos)">
                                             <i class="fas fa-stop"></i> Stop
                                         </button>
                                     </div>
                                 </div>
                                
                                <!-- Status atual do apontamento -->
                                <div class="status-apontamento mt-1" id="status-{{ ordem.id }}">
                                    <small class="text-muted">Aguardando apontamento</small>
                                    <!-- Timer de apontamento ser√° inserido aqui -->
                                    <span class="apontamento-timer" id="timer-{{ ordem.id }}">00:00:00</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                    
                    <!-- Cart√µes fantasma -->
                    {% for cartao_fantasma in cartoes_fantasma[lista] %}
                    <div class="kanban-card fantasma" data-cartao-id="{{ cartao_fantasma.id }}" data-fantasma-ordem-id="{{ cartao_fantasma.ordem_servico.id }}">
                        <div class="kanban-card-header">
                            <div class="card-header-main">
                                <div class="drag-handle" onclick="event.stopPropagation()">
                                    <i class="fas fa-grip-lines"></i>
                                </div>
                                {% if cartao_fantasma.ordem_servico.pedidos and cartao_fantasma.ordem_servico.pedidos[0].pedido.item and cartao_fantasma.ordem_servico.pedidos[0].pedido.item.imagem_path %}
                                    <img src="{{ cartao_fantasma.ordem_servico.pedidos[0].pedido.item.imagem_path }}" width="48" height="48" class="item-thumb rounded me-2" alt="Imagem do item">
                                {% endif %}
                                <div class="fantasma-info">
                                    <span class="fantasma-posicao">{{ cartao_fantasma.posicao_fila }}</span>
                                    <strong>{{ cartao_fantasma.ordem_servico.numero }}</strong>
                                    <small class="text-muted">(Lista origem: {{ cartao_fantasma.ordem_servico.status }})</small>
                                    {% if cartao_fantasma.trabalho %}
                                        <br><small><i class="fas fa-cog"></i> {{ cartao_fantasma.trabalho.nome }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="kanban-card-body">
                            {% if cartao_fantasma.ordem_servico.pedidos %}
                                {% set ordem = cartao_fantasma.ordem_servico %}
                                {% set total_items = 0 %}
                                {% set total_qty = 0 %}
                                {% set grouped_items = {} %}
                                
                                {% for pedido_os in ordem.pedidos %}
                                    {% set item_key = pedido_os.pedido.item_id if pedido_os.pedido.item_id else pedido_os.pedido.nome_item %}
                                    {% set item_name = pedido_os.pedido.item.codigo_acb ~ ' - ' ~ pedido_os.pedido.item.nome if pedido_os.pedido.item_id else pedido_os.pedido.nome_item %}
                                    
                                    {% if item_key in grouped_items %}
                                        {% set _ = grouped_items[item_key].update({
                                            'total_qty': grouped_items[item_key].total_qty + pedido_os.pedido.quantidade
                                        }) %}
                                    {% else %}
                                        {% set _ = grouped_items.update({
                                            item_key: {
                                                'name': item_name,
                                                'total_qty': pedido_os.pedido.quantidade,
                                                'item': pedido_os.pedido.item if pedido_os.pedido.item_id else None
                                            }
                                        }) %}
                                    {% endif %}
                                {% endfor %}
                            
                                <div class="os-items mt-1">
                                    <div class="small text-muted">Itens da OS</div>
                                    <ul class="os-item-list list-unstyled mb-1">
                                        {% for item_key, item_data in grouped_items.items() %}
                                        <li class="os-item">
                                            <span class="os-item-name">{{ item_data.name }}</span>
                                            <span class="badge rounded-pill bg-primary os-item-qty" title="Quantidade do item">{{ item_data.total_qty }}</span>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            {% endif %}
                            
                            {% if cartao_fantasma.observacoes %}
                            <div class="mt-2">
                                <small class="text-muted"><i class="fas fa-comment"></i> {{ cartao_fantasma.observacoes }}</small>
                            </div>
                            {% endif %}
                            
                            <!-- Bot√µes de Apontamento (apontam para a OS real) -->
                            {% if acesso_kanban and lista not in ['Entrada', 'Expedi√ß√£o'] %}
                            <div class="apontamento-buttons mt-2 pt-2 border-top">
                                <div class="row g-1">
                                    <!-- Grupo Setup -->
                                    <div class="col-6">
                                        <button class="btn btn-outline-primary btn-sm w-100 apontamento-btn" 
                                                data-acao="inicio_setup"
                                                data-ordem-id="{{ cartao_fantasma.ordem_servico.id }}"
                                                onclick="iniciarApontamentoSetup(this.dataset.ordemId);"
                                                title="Iniciar Setup (OS Real)">
                                            <i class="fas fa-play"></i> Setup
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-outline-info btn-sm w-100 apontamento-btn" 
                                                data-acao="fim_setup"
                                                data-ordem-id="{{ cartao_fantasma.ordem_servico.id }}"
                                                onclick="finalizarSetup(this.dataset.ordemId);"
                                                title="Finalizar Setup (OS Real)">
                                            <i class="fas fa-stop"></i> Fim Setup
                                        </button>
                                    </div>

                                    <!-- Grupo Produ√ß√£o -->
                                    <div class="col-6">
                                        <button class="btn btn-outline-success btn-sm w-100 apontamento-btn" 
                                                data-acao="inicio_producao"
                                                data-ordem-id="{{ cartao_fantasma.ordem_servico.id }}"
                                                onclick="iniciarApontamentoProducao(this.dataset.ordemId);"
                                                title="Iniciar Produ√ß√£o (OS Real)">
                                            <i class="fas fa-cogs"></i> Produ√ß√£o
                                        </button>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-outline-warning btn-sm w-100 apontamento-btn" 
                                                data-acao="pausa"
                                                data-ordem-id="{{ cartao_fantasma.ordem_servico.id }}"
                                                onclick="pausarApontamento(this.dataset.ordemId);"
                                                title="Pausar produ√ß√£o (OS Real)">
                                            <i class="fas fa-pause"></i> Pausa
                                        </button>
                                    </div>
                                    <div class="col-12">
                                        <button class="btn btn-outline-danger btn-sm w-100 apontamento-btn" 
                                                data-acao="stop"
                                                data-ordem-id="{{ cartao_fantasma.ordem_servico.id }}"
                                                onclick="pararApontamento(this.dataset.ordemId);"
                                                title="Stop (fim de turno / parada entre turnos) (OS Real)">
                                            <i class="fas fa-stop"></i> Stop
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Indicadores de status (baseado na OS real) -->
                                <div class="apontamento-status mt-2" id="status-fantasma-{{ cartao_fantasma.id }}">
                                    <div class="d-flex justify-content-between align-items-center small">
                                        <span class="status-text">Aguardando</span>
                                        <span class="apontamento-timer" id="timer-fantasma-{{ cartao_fantasma.id }}">00:00:00</span>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="fantasma-actions mt-2 pt-2 border-top">
                                <button class="btn btn-outline-warning btn-fantasma btn-mover-fantasma" 
                                        data-cartao-id="{{ cartao_fantasma.id }}" 
                                        title="Alterar posi√ß√£o na fila">
                                    <i class="fas fa-arrows-alt-v"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-fantasma btn-remover-fantasma" 
                                        data-cartao-id="{{ cartao_fantasma.id }}" 
                                        title="Remover cart√£o fantasma">
                                    <i class="fas fa-times"></i>
                                </button>
                                <button class="btn btn-outline-info btn-fantasma btn-detalhes-fantasma" 
                                        data-ordem-id="{{ cartao_fantasma.ordem_servico.id }}"
                                        title="Ver detalhes da OS original">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <!-- Bot√£o para criar cart√£o fantasma (apenas em listas n√£o protegidas) -->
                    {% if lista not in ['Entrada', 'Expedi√ß√£o'] %}
                    <button class="btn btn-primary btn-criar-fantasma" 
                            data-lista="{{ lista }}"
                            title="Criar cart√£o fantasma nesta lista">
                        <i class="fas fa-ghost"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

    <!-- Modal para detalhes do card -->
    <div class="modal fade" id="cardDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalhes da Ordem de Servi√ßo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para criar cart√£o fantasma -->
    <div class="modal fade" id="criarFantasmaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-ghost text-purple"></i> Criar Cart√£o Fantasma</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formCriarFantasma">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Ordem de Servi√ßo:</label>
                                <select class="form-select" id="ordemSelect" name="ordem_id" required>
                                    <option value="">Selecione uma OS...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Lista Destino:</label>
                                <select class="form-select" id="listaSelect" name="lista_destino" required>
                                    <option value="">Selecione a lista...</option>
                                    {% for lista in listas %}
                                        {% if lista not in ['Entrada', 'Expedi√ß√£o'] %}
                                        <option value="{{ lista }}">{{ lista }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Trabalho Espec√≠fico (Opcional):</label>
                                <select class="form-select" id="trabalhoSelect" name="trabalho_id">
                                    <option value="">Selecione um trabalho...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Posi√ß√£o na Fila:</label>
                                <input type="number" class="form-control" name="posicao_fila" value="1" min="1" max="10">
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="form-label">Observa√ß√µes:</label>
                            <textarea class="form-control" name="observacoes" rows="2" placeholder="Observa√ß√µes sobre este cart√£o fantasma..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnConfirmarFantasma">
                        <i class="fas fa-ghost"></i> Criar Cart√£o Fantasma
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para mover cart√£o fantasma -->
    <div class="modal fade" id="moverFantasmaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-arrows-alt-v"></i> Alterar Posi√ß√£o</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formMoverFantasma">
                        <input type="hidden" id="cartaoIdMover" name="cartao_id">
                        <div class="mb-3">
                            <label class="form-label">Nova Posi√ß√£o na Fila:</label>
                            <input type="number" class="form-control" id="novaPosicao" name="nova_posicao" value="1" min="1" max="10" required>
                            <div class="form-text">Posi√ß√£o 1 = primeiro da fila</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="btnConfirmarMoverFantasma">
                        <i class="fas fa-arrows-alt-v"></i> Alterar Posi√ß√£o
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scripts do Bootstrap e JavaScript customizado -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/kanban-sortable.js"></script>
    <script>
        function moverOrdem(ordemId, listaDestino) {
            fetch('/kanban/mover', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `ordem_id=${ordemId}&nova_lista=${listaDestino}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar mensagem de sucesso
                    alert(data.message);
                    // Recarregar a p√°gina para atualizar
                    window.location.reload();
                }
            });
        }
        
        function openCardDetails(ordemId) {
            const modal = new bootstrap.Modal(document.getElementById('cardDetailsModal'));
            modal.show();
            
            // Carregar os detalhes do card via AJAX
            fetch(`/kanban/detalhes/${ordemId}`)
                .then(response => response.text())
                .then(html => {
                    document.querySelector('#cardDetailsModal .modal-body').innerHTML = html;
                    
                    // Inicializar os elementos do formul√°rio dentro do modal
                    document.querySelectorAll('#cardDetailsModal .btn-salvar-tempo').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const form = this.closest('form');
                            const formData = new FormData(form);
                            
                            fetch('/kanban/atualizar-tempo-real', {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Atualizar apenas a parte relevante do modal
                                    openCardDetails(ordemId);
                                }
                            });
                        });
                    });
                    
                    // Carregar logs de apontamento automaticamente ap√≥s o modal ser carregado
                    console.log(`Carregando logs automaticamente para OS ${ordemId} ap√≥s abertura do modal`);
                    
                    // Usar setTimeout para garantir que o DOM est√° completamente carregado
                    setTimeout(function() {
                        // Tentar carregar logs usando a fun√ß√£o global
                        if (typeof carregarLogsManualmente === 'function') {
                            console.log(`Chamando carregarLogsManualmente para OS ${ordemId}`);
                            carregarLogsManualmente(ordemId);
                        } else {
                            console.error('Fun√ß√£o carregarLogsManualmente n√£o encontrada!');
                            
                            // Carregar logs diretamente via fetch se a fun√ß√£o global n√£o estiver dispon√≠vel
                            const logsContainer = document.getElementById(`logs-apontamento-container-${ordemId}`);
                            if (logsContainer) {
                                fetch(`/apontamento/os/${ordemId}/logs`)
                                    .then(response => response.json())
                                    .then(data => {
                                        console.log(`Dados recebidos diretamente para OS ${ordemId}:`, data);
                                        
                                        if (data.logs && data.logs.length > 0) {
                                            let html = `<h5>Encontrados ${data.logs.length} registros</h5>`;
                                            html += '<ul class="list-group">';
                                            
                                            data.logs.forEach(log => {
                                                const dataHora = new Date(log.data_hora).toLocaleString();
                                                html += `<li class="list-group-item">${dataHora} - ${log.tipo_acao} - ${log.operador_nome || 'N/A'}</li>`;
                                            });
                                            
                                            html += '</ul>';
                                            logsContainer.innerHTML = html;
                                        } else {
                                            logsContainer.innerHTML = '<div class="alert alert-info">Nenhum registro encontrado.</div>';
                                        }
                                    })
                                    .catch(error => {
                                        console.error(`Erro ao carregar logs diretamente para OS ${ordemId}:`, error);
                                        logsContainer.innerHTML = `<div class="alert alert-danger">Erro ao carregar: ${error.message}</div>`;
                                    });
                            } else {
                                console.error(`Container de logs n√£o encontrado para OS ${ordemId}`);
                            }
                        }
                    }, 500);
                });
        }
        
        function finalizarOS(ordemId) {
            if (confirm('Deseja finalizar esta Ordem de Servi√ßo? Ela ser√° movida para o registro mensal.')) {
                fetch('/kanban/finalizar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `ordem_id=${ordemId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Fechar o modal e recarregar a p√°gina
                        bootstrap.Modal.getInstance(document.getElementById('cardDetailsModal')).hide();
                        window.location.reload();
                    }
                });
            }
        }
        
        // Fun√ß√£o para mostrar/ocultar cont√™iner de documentos (PDF/CNC)
        function toggleDocContainer(element, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // Verificar se est√° vis√≠vel ou oculto com getComputedStyle
            const computedStyle = window.getComputedStyle(container);
            const isHidden = computedStyle.display === 'none';
            
            // Alternar visibilidade
            if (isHidden) {
                // Mostrar o container
                container.style.cssText = 'display: block !important';
                element.classList.add('active');
            } else {
                // Esconder o container
                container.style.cssText = 'display: none !important';
                element.classList.remove('active');
            }
            
            // Prevenir propaga√ß√£o de eventos
            event.stopPropagation();
            return false;
        }
        
        // Fun√ß√£o para inicializar todos os eventos nos cart√µes
        function initializeKanbanEvents() {
            console.log('=== Inicializando eventos do Kanban ===');
            
            // Eventos para abrir detalhes do card
            document.querySelectorAll('.card-title').forEach(function(element) {
                element.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const ordemId = this.dataset.ordemId;
                    openCardDetails(ordemId);
                });
            });
            
            // Event listeners para bot√µes de cria√ß√£o de cart√£o fantasma direto
            const btnFantasma = document.querySelectorAll('.btn-criar-fantasma-direto');
            console.log('Encontrados', btnFantasma.length, 'bot√µes fantasma direto');
            
            // Listar todos os bot√µes encontrados
            btnFantasma.forEach(function(btn, index) {
                console.log(`Bot√£o ${index + 1}:`, {
                    element: btn,
                    ordemId: btn.dataset.ordemId,
                    listaOrigem: btn.dataset.listaOrigem,
                    className: btn.className,
                    initialized: btn.classList.contains('events-initialized')
                });
            });
            
            // Configurar event listeners para bot√µes de criar fantasma
            btnFantasma.forEach(function(btn) {
                if (!btn.classList.contains('events-initialized')) {
                    console.log('üîß Configurando evento para bot√£o OS:', btn.dataset.ordemId);
                    
                    btn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        const ordemId = this.dataset.ordemId;
                        const listaOrigem = this.dataset.listaOrigem;
                        console.log('üöÄ CLIQUE no bot√£o fantasma! OS:', ordemId, 'Lista:', listaOrigem);
                        criarCartaoFantasmaRapido(ordemId, listaOrigem);
                    });
                    
                    // Teste adicional - evento de mousedown
                    btn.addEventListener('mousedown', function(e) {
                        console.log('üëÜ MOUSEDOWN no bot√£o fantasma OS:', this.dataset.ordemId);
                    });
                    
                    btn.classList.add('events-initialized');
                    console.log('‚úÖ Evento configurado para OS:', btn.dataset.ordemId);
                } else {
                    console.log('‚è≠Ô∏è Bot√£o OS', btn.dataset.ordemId, 'j√° inicializado');
                }
            });
            
            // Configurar bot√µes de a√ß√£o dos cart√µes fantasma
            configurarBotoesFantasma();
            
            // Marcar os cart√µes como inicializados
            document.querySelectorAll('.kanban-card').forEach(function(card) {
                card.classList.add('events-initialized');
            });
            
            console.log('=== Inicializa√ß√£o de eventos conclu√≠da ===');
        }
        
        // Inicializar eventos ap√≥s o carregamento do documento
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado - chamando initializeKanbanEvents');
            initializeKanbanEvents();
            
            // Tamb√©m inicializar novamente quando o Sortable terminar uma opera√ß√£o de arrasto
            document.addEventListener('sortable-drop-complete', function() {
                console.log('Sortable drop complete - reinicializando eventos');
                setTimeout(initializeKanbanEvents, 100);
            });
        });
    </script>

    <!-- Modal de Apontamento -->
    <div class="modal fade" id="modalApontamento" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalApontamentoTitle">Apontamento de Produ√ß√£o</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formApontamento">
                        <input type="hidden" id="ordemServicoId">
                        <input type="hidden" id="tipoAcao">
                        
                        <!-- C√≥digo do Operador -->
                        <div class="mb-3">
                            <label for="codigoOperador" class="form-label">C√≥digo do Operador *</label>
                            <input type="text" class="form-control" id="codigoOperador" maxlength="4" pattern="[0-9]{4}" placeholder="0000" required>
                            <div class="form-text">Digite seu c√≥digo de 4 d√≠gitos</div>
                            <div id="operadorInfo" class="mt-1"></div>
                        </div>
                        
                        <!-- Sele√ß√£o de Item -->
                        <div class="mb-3" id="divItemSelecao">
                            <label for="itemSelecao" class="form-label">Item *</label>
                            <select class="form-select" id="itemSelecao" required>
                                <option value="">Selecione o item</option>
                            </select>
                            <div class="form-text">Selecione o item espec√≠fico para apontamento</div>
                        </div>
                        
                        <!-- Tipo de Trabalho -->
                        <div class="mb-3" id="divTipoTrabalho">
                            <label for="tipoTrabalho" class="form-label">Tipo de Trabalho *</label>
                            <select class="form-select" id="tipoTrabalho" required>
                                <option value="">Selecione o tipo de trabalho</option>
                            </select>
                            <div class="form-text">Tipos de trabalho do item selecionado</div>
                        </div>
                        
                        <!-- Quantidade (para in√≠cio produ√ß√£o e pausas) -->
                        <div class="mb-3" id="divQuantidade" style="display: none;">
                            <label for="quantidade" class="form-label">Quantidade de Pe√ßas</label>
                            <input type="number" class="form-control" id="quantidade" min="0" placeholder="0">
                            <div class="form-text">Quantidade atual de pe√ßas produzidas</div>
                            <div class="form-text" id="ultimaQuantidadeInfo"></div>
                        </div>
                        
                        <!-- Motivo da Parada (apenas para pausas) -->
                        <div class="mb-3" id="divMotivoParada" style="display: none;">
                            <label for="motivoParada" class="form-label">Motivo da Parada *</label>
                            <select class="form-select" id="motivoParada">
                                <option value="">Selecione o motivo</option>
                                <option value="Parada para caf√©">Parada para caf√©</option>
                                <option value="Sem desenho">Sem desenho</option>
                                <option value="Sem ferramenta">Sem ferramenta</option>
                                <option value="Troca de ferramenta">Troca de ferramenta</option>
                                <option value="Sem material">Sem material</option>
                                <option value="Falha na opera√ß√£o">Falha na opera√ß√£o</option>
                                <option value="Manuten√ß√£o n√£o programada">Manuten√ß√£o n√£o programada</option>
                                <option value="Banheiro">Banheiro</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        
                        <!-- Observa√ß√µes -->
                        <div class="mb-3">
                            <label for="observacoes" class="form-label">Observa√ß√µes</label>
                            <textarea class="form-control" id="observacoes" rows="2" placeholder="Observa√ß√µes adicionais (opcional)"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarApontamento()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts de Apontamento -->
    <script src="/static/js/apontamento-persistence.js"></script>
    <script src="/static/js/apontamento-logs.js"></script>
    
    <!-- Fun√ß√£o global para carregar logs manualmente -->
    <script>
        // Fun√ß√£o global para carregar logs manualmente (para debug)
        function carregarLogsManualmente(ordemId) {
            console.log(`Carregando logs manualmente para OS ${ordemId}`);
            const logsContainer = document.getElementById(`logs-apontamento-container-${ordemId}`);
            
            if (!logsContainer) {
                alert('Container de logs n√£o encontrado!');
                return;
            }
            
            // Mostrar mensagem de carregamento
            logsContainer.innerHTML = `
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Carregando hist√≥rico via bot√£o manual...</p>
                </div>
            `;
            
            // Fazer a requisi√ß√£o diretamente
            fetch(`/apontamento/os/${ordemId}/logs`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erro HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Dados recebidos:', data);
                    
                    if (data.logs && data.logs.length > 0) {
                        // Construir HTML simples para exibi√ß√£o dos logs
                        let html = `<h5>Encontrados ${data.logs.length} registros</h5>`;
                        html += '<ul class="list-group">';
                        
                        data.logs.forEach(log => {
                            const data = new Date(log.data_hora).toLocaleString();
                            html += `<li class="list-group-item">${data} - ${log.tipo_acao} - ${log.operador_nome || 'N/A'}</li>`;
                        });
                        
                        html += '</ul>';
                        logsContainer.innerHTML = html;
                    } else {
                        logsContainer.innerHTML = '<div class="alert alert-info">Nenhum registro encontrado.</div>';
                    }
                })
                .catch(error => {
                    console.error('Erro:', error);
                    logsContainer.innerHTML = `<div class="alert alert-danger">Erro ao carregar: ${error.message}</div>`;
                });
        }
    </script>
    
    <!-- Script para Apontamentos -->
    <script>
    let ordemAtualId = null;
    let tipoAcaoAtual = null;
    
    function abrirModalApontamento(tipoAcao, ordemId) {
        // Removido o bloqueio por apontamento ativo em outra OS.
        // Agora sempre permitimos abrir o modal e iniciar um novo apontamento,
        // deixando as valida√ß√µes a cargo do backend apenas dentro da pr√≥pria OS.
        prosseguirAbrirModal(tipoAcao, ordemId);
    }
    
    // Fun√ß√£o auxiliar para criar um modal de alerta caso n√£o exista
    function criarModalAlerta() {
        const modalHtml = `
            <div class="modal fade" id="alertModal" tabindex="-1" aria-labelledby="alertModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title" id="alertModalLabel">Aviso</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Conte√∫do din√¢mico aqui -->
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Adicionar o modal ao corpo do documento
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer.firstElementChild);
        
        return document.getElementById('alertModal');
    }
    
    // Fun√ß√£o para prosseguir com a abertura do modal de apontamento
    function prosseguirAbrirModal(tipoAcao, ordemId) {
        ordemAtualId = ordemId;
        tipoAcaoAtual = tipoAcao;
        
        // Configurar o modal baseado no tipo de a√ß√£o
        configurarModalPorTipo(tipoAcao);
        
        // Limpar formul√°rio
        document.getElementById('formApontamento').reset();
        document.getElementById('ordemServicoId').value = ordemId;
        document.getElementById('tipoAcao').value = tipoAcao;
        document.getElementById('operadorInfo').innerHTML = '';
        
        // Carregar itens da OS primeiro
        carregarItensOS(ordemId);
        
        // Abrir modal
        new bootstrap.Modal(document.getElementById('modalApontamento')).show();
    }
    
    function configurarModalPorTipo(tipoAcao) {
        const title = document.getElementById('modalApontamentoTitle');
        const divQuantidade = document.getElementById('divQuantidade');
        const divMotivoParada = document.getElementById('divMotivoParada');
        const quantidade = document.getElementById('quantidade');
        const motivoParada = document.getElementById('motivoParada');
        
        // Reset
        divQuantidade.style.display = 'none';
        divMotivoParada.style.display = 'none';
        quantidade.required = false;
        motivoParada.required = false;
        
        switch(tipoAcao) {
            case 'inicio_setup':
                title.textContent = 'Iniciar Setup';
                break;
            case 'fim_setup':
                title.textContent = 'Finalizar Setup';
                break;
            case 'inicio_producao':
                title.textContent = 'Iniciar Produ√ß√£o';
                divQuantidade.style.display = 'block';
                quantidade.placeholder = 'Quantidade inicial (opcional)';
                break;
            case 'pausa':
                title.textContent = 'Pausar Produ√ß√£o';
                divQuantidade.style.display = 'block';
                divMotivoParada.style.display = 'block';
                // Quantidade e motivo s√£o opcionais na pausa
                quantidade.required = false;
                motivoParada.required = false;
                quantidade.placeholder = 'Quantidade atual de pe√ßas (opcional)';
                break;
            case 'stop':
                title.textContent = 'Stop (Fim de turno / Parada entre turnos)';
                // No STOP n√£o deve exibir motivo de parada e nada √© obrigat√≥rio
                divQuantidade.style.display = 'block';
                divMotivoParada.style.display = 'none';
                // STOP: quantidade opcional, sem motivo de parada
                quantidade.required = false;
                motivoParada.required = false;
                quantidade.placeholder = 'Quantidade final no turno (opcional)';
                break;
            case 'fim_producao':
                title.textContent = 'Finalizar Produ√ß√£o';
                divQuantidade.style.display = 'block';
                quantidade.required = true;
                quantidade.placeholder = 'Quantidade final produzida';
                break;
        }
    }
    
    function carregarItensOS(ordemId) {
        fetch(`/apontamento/os/${ordemId}/itens`)
            .then(response => response.json())
            .then(data => {
                const selectItem = document.getElementById('itemSelecao');
                const selectTipo = document.getElementById('tipoTrabalho');
                
                // Limpar dropdowns
                selectItem.innerHTML = '<option value="">Selecione o item</option>';
                selectTipo.innerHTML = '<option value="">Selecione o tipo de trabalho</option>';
                
                if (data.success && data.itens && data.itens.length > 0) {
                    data.itens.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = `${item.codigo_acb} - ${item.nome}`;
                        selectItem.appendChild(option);
                    });
                    
                    // Se h√° apenas um item, selecionar automaticamente
                    if (data.itens.length === 1) {
                        selectItem.value = data.itens[0].id;
                        carregarTiposTrabalhoItem(data.itens[0].id);
                    }
                } else {
                    mostrarAlerta('Erro: Nenhum item encontrado para esta OS', 'error');
                }
            })
            .catch(error => {
                console.error('Erro ao carregar itens:', error);
                mostrarAlerta('Erro ao carregar itens da OS', 'error');
            });
    }
    
    function carregarTiposTrabalhoItem(itemId) {
        if (!itemId) {
            const select = document.getElementById('tipoTrabalho');
            select.innerHTML = '<option value="">Selecione o tipo de trabalho</option>';
            return;
        }
        
        fetch(`/apontamento/item/${itemId}/tipos-trabalho`)
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('tipoTrabalho');
                select.innerHTML = '<option value="">Selecione o tipo de trabalho</option>';
                
                if (data.success) {
                    data.tipos_trabalho.forEach(tipo => {
                        const option = document.createElement('option');
                        option.value = tipo.id;
                        option.textContent = tipo.nome;
                        if (tipo.descricao) {
                            option.title = tipo.descricao;
                        }
                        select.appendChild(option);
                    });
                } else {
                    mostrarAlerta('Erro: ' + data.message, 'warning');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                mostrarAlerta('Erro ao carregar tipos de trabalho', 'error');
            });
    }
    
    // Event listener para quando o item for selecionado
    document.getElementById('itemSelecao').addEventListener('change', function(e) {
        const itemId = e.target.value;
        carregarTiposTrabalhoItem(itemId);
        // Limpar informa√ß√£o de √∫ltima quantidade at√© que o tipo de trabalho seja selecionado
        const info = document.getElementById('ultimaQuantidadeInfo');
        if (info) info.textContent = '';
    });

    // Quando o tipo de trabalho for selecionado, calcular/mostrar √∫ltima quantidade
    document.getElementById('tipoTrabalho').addEventListener('change', function(e) {
        atualizarUltimaQuantidadeCampo();
    });

    // Cache simples em mem√≥ria para √∫ltima quantidade por OS/Item/Trabalho
    const cacheUltimaQuantidade = new Map();

    function chaveUltimaQuantidade(ordemId, itemId, trabalhoId) {
        return `${ordemId}-${itemId}-${trabalhoId}`;
    }

    async function obterUltimaQuantidade(ordemId, itemId, trabalhoId) {
        const chave = chaveUltimaQuantidade(ordemId, itemId, trabalhoId);
        if (cacheUltimaQuantidade.has(chave)) {
            return cacheUltimaQuantidade.get(chave);
        }

        // 1) Tentar via /apontamento/status-ativos (se houver status para esta OS)
        try {
            const resp = await fetch('/apontamento/status-ativos');
            if (resp.ok) {
                const data = await resp.json();
                if (data.status_ativos && Array.isArray(data.status_ativos)) {
                    const st = data.status_ativos.find(s => s.ordem_servico_id === ordemId && s.item_id === itemId && s.trabalho_id === trabalhoId);
                    if (st && typeof st.ultima_quantidade !== 'undefined' && st.ultima_quantidade !== null) {
                        cacheUltimaQuantidade.set(chave, parseInt(st.ultima_quantidade, 10));
                        return cacheUltimaQuantidade.get(chave);
                    }
                }
            }
        } catch (e) {
            console.warn('Falha ao consultar status-ativos para √∫ltima quantidade:', e);
        }

        // 2) Consultar logs da OS e pegar a √∫ltima quantidade para o item/trabalho
        try {
            const resp2 = await fetch(`/apontamento/os/${ordemId}/logs`);
            if (resp2.ok) {
                const data2 = await resp2.json();
                if (data2.logs && Array.isArray(data2.logs)) {
                    // logs j√° v√™m ordenados desc por data_hora
                    const log = data2.logs.find(l => l.item_id === itemId && l.trabalho_id === trabalhoId && l.quantidade !== null && typeof l.quantidade !== 'undefined');
                    if (log) {
                        cacheUltimaQuantidade.set(chave, parseInt(log.quantidade, 10));
                        return cacheUltimaQuantidade.get(chave);
                    }
                }
            }
        } catch (e) {
            console.warn('Falha ao consultar logs para √∫ltima quantidade:', e);
        }

        // 3) Fallback: 0
        cacheUltimaQuantidade.set(chave, 0);
        return 0;
    }

    async function atualizarUltimaQuantidadeCampo() {
        const ordemId = parseInt(document.getElementById('ordemServicoId').value, 10);
        const itemId = parseInt(document.getElementById('itemSelecao').value, 10);
        const trabalhoId = parseInt(document.getElementById('tipoTrabalho').value, 10);
        const info = document.getElementById('ultimaQuantidadeInfo');
        const qtdInput = document.getElementById('quantidade');
        if (!ordemId || !itemId || !trabalhoId) {
            if (info) info.textContent = '';
            return;
        }
        try {
            // Primeiro, tentar buscar do QPT atualizado no DOM
            let ultimaQ = null;
            
            // Buscar o cart√£o da OS no DOM
            const cartoes = document.querySelectorAll('.kanban-card');
            for (const cartao of cartoes) {
                const osIdElement = cartao.querySelector('[data-ordem-id]');
                if (osIdElement && parseInt(osIdElement.getAttribute('data-ordem-id')) === ordemId) {
                    // Encontrou o cart√£o da OS, agora buscar o QPT do trabalho espec√≠fico
                    const qptItems = cartao.querySelectorAll('.qpt-item');
                    for (const qptItem of qptItems) {
                        const trabalhoNome = qptItem.getAttribute('data-trab-nome');
                        const qptQty = qptItem.querySelector('.qpt-qty');
                        
                        // Verificar se √© o trabalho correto comparando com o select
                        const trabalhoSelect = document.getElementById('tipoTrabalho');
                        const trabalhoSelecionado = trabalhoSelect.options[trabalhoSelect.selectedIndex];
                        
                        if (trabalhoSelecionado && trabalhoSelecionado.text === trabalhoNome && qptQty) {
                            ultimaQ = parseInt(qptQty.textContent.trim());
                            console.log(`QPT encontrado no DOM: ${ultimaQ} para trabalho ${trabalhoNome}`);
                            break;
                        }
                    }
                    if (ultimaQ !== null) break;
                }
            }
            
            // Se n√£o encontrou no QPT, buscar via backend
            if (ultimaQ === null) {
                ultimaQ = await obterUltimaQuantidade(ordemId, itemId, trabalhoId);
            } else {
                // Atualizar o cache com o valor do QPT
                const chave = chaveUltimaQuantidade(ordemId, itemId, trabalhoId);
                cacheUltimaQuantidade.set(chave, ultimaQ);
            }
            
            if (info) info.textContent = `√öltima quantidade apontada para este item/trabalho: ${ultimaQ}`;
            if (qtdInput) {
                qtdInput.min = Math.max(0, ultimaQ);
                if (!qtdInput.placeholder || qtdInput.placeholder === '0' || qtdInput.placeholder === 'Quantidade final produzida' || qtdInput.placeholder === 'Quantidade atual de pe√ßas') {
                    qtdInput.placeholder = `>= ${ultimaQ}`;
                }
            }
        } catch (e) {
            console.warn('N√£o foi poss√≠vel atualizar √∫ltima quantidade no campo:', e);
        }
    }
    
    // Valida√ß√£o do c√≥digo do operador em tempo real
    document.getElementById('codigoOperador').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, ''); // Apenas d√≠gitos
        if (value.length > 4) value = value.substr(0, 4);
        e.target.value = value;
        
        if (value.length === 4) {
            validarOperador(value);
        } else {
            document.getElementById('operadorInfo').innerHTML = '';
        }
    });
    
    function validarOperador(codigo) {
        fetch('/apontamento/validar-codigo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ codigo: codigo })
        })
        .then(response => response.json())
        .then(data => {
            const infoDiv = document.getElementById('operadorInfo');
            if (data.valid) {
                infoDiv.innerHTML = `<small class="text-success"><i class="fas fa-check"></i> ${data.message}</small>`;
            } else {
                infoDiv.innerHTML = `<small class="text-danger"><i class="fas fa-times"></i> ${data.message}</small>`;
            }
        })
        .catch(error => {
            console.error('Erro:', error);
        });
    }
    
    async function salvarApontamento() {
        const form = document.getElementById('formApontamento');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Validar se item foi selecionado
        const itemId = document.getElementById('itemSelecao').value;
        if (!itemId) {
            mostrarAlerta('Por favor, selecione um item antes de continuar', 'error');
            return;
        }
        
        // Validar quantidade m√≠nima no frontend em rela√ß√£o √† √∫ltima quantidade
        const ordemId = document.getElementById('ordemServicoId').value;
        const trabalhoId = document.getElementById('tipoTrabalho').value;
        const tipoAcao = document.getElementById('tipoAcao').value;
        const qtdStr = document.getElementById('quantidade').value;
        if (qtdStr !== '' && qtdStr !== null) {
            const qtdInformada = parseInt(qtdStr, 10);
            if (!Number.isNaN(qtdInformada)) {
                try {
                    const ultimaQ = await obterUltimaQuantidade(parseInt(ordemId, 10), parseInt(itemId, 10), parseInt(trabalhoId, 10));
                    if (typeof ultimaQ === 'number' && qtdInformada < ultimaQ) {
                        mostrarAlerta(`Quantidade informada (${qtdInformada}) menor que a √∫ltima apontada (${ultimaQ}). Informe um valor maior ou igual.`, 'error');
                        return;
                    }
                } catch (e) {
                    console.warn('Falha ao obter √∫ltima quantidade para valida√ß√£o frontend:', e);
                    // Em caso de falha, seguimos e deixamos o backend validar
                }
            }
        }

        const dados = {
            ordem_servico_id: document.getElementById('ordemServicoId').value,
            item_id: itemId,
            tipo_acao: document.getElementById('tipoAcao').value,
            codigo_operador: document.getElementById('codigoOperador').value,
            trabalho_id: document.getElementById('tipoTrabalho').value,
            quantidade: document.getElementById('quantidade').value || null,
            motivo_parada: document.getElementById('motivoParada').value || null,
            observacoes: document.getElementById('observacoes').value || null
        };
        
        fetch('/apontamento/registrar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(dados)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAlerta(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('modalApontamento')).hide();
                // Atualizar visual conforme a a√ß√£o
                if (tipoAcao === 'stop') {
                    // No STOP, remover qualquer status visual
                    limparStatusCartao(ordemAtualId);
                    // Broadcast STOP para outras abas
                    try {
                        const osIdNum = parseInt(ordemAtualId, 10);
                        if (!Number.isNaN(osIdNum)) {
                            localStorage.setItem('apontamento_broadcast', JSON.stringify({ type: 'stop', osId: osIdNum, ts: Date.now() }));
                        }
                    } catch {}
                    // Marcar flag after-stop nesta mesma aba e limpar assinatura; a atualiza√ß√£o ocorrer√° ap√≥s o seed de cache abaixo
                    try {
                        const osIdNum = parseInt(ordemAtualId, 10);
                        if (!Number.isNaN(osIdNum)) {
                            window.__qptAfterStop = window.__qptAfterStop || {};
                            window.__qptAfterStop[osIdNum] = true;
                            try { console.debug('[QPT] (same tab) flag after STOP set', osIdNum); } catch {}
                            try {
                                const c = document.getElementById(`qtd-por-trabalho-${osIdNum}`);
                                if (c && c.dataset) delete c.dataset.qptSig;
                            } catch {}
                        }
                    } catch {}
                } else {
                    // Para demais a√ß√µes, atualizar status normalmente
                    atualizarStatusCartao(ordemAtualId, data.status);
                }
                // Atualizar √∫ltima quantidade exibida, se fornecida pelo backend
                if (typeof window.atualizarUltimaQuantidadeNoCard === 'function' && 'ultima_quantidade' in data) {
                    window.atualizarUltimaQuantidadeNoCard(ordemAtualId, data.ultima_quantidade);
                }
                // Semear/atualizar cache da QPT imediatamente
                try {
                    const osId = ordemAtualId;
                    const trabSelect = document.getElementById('tipoTrabalho');
                    const itemSelect = document.getElementById('itemSelecao');
                    const qtdInput = document.getElementById('quantidade');
                    const trabalhoId = trabSelect ? trabSelect.value : null;
                    const trabalhoNome = trabSelect && trabSelect.selectedOptions[0] ? trabSelect.selectedOptions[0].textContent : null;
                    const itemCod = itemSelect && itemSelect.selectedOptions[0] ? itemSelect.selectedOptions[0].textContent : null;
                    // CORRE√á√ÉO: Para STOP, priorizar quantidade informada no modal sobre a resposta do backend
                    const qtdInput_value = qtdInput ? qtdInput.value : null;
                    const qtdResp = (qtdInput_value && qtdInput_value.trim() !== '') ? qtdInput_value : 
                                   (data && 'ultima_quantidade' in data) ? data.ultima_quantidade : null;
                    if (window.atualizarQPTCacheEntrada && osId && trabalhoId) {
                        window.atualizarQPTCacheEntrada(osId, trabalhoId, trabalhoNome, itemCod, qtdResp);
                    }
                    // For√ßar render imediato apenas quando houver quantidade num√©rica (evita sobrescrever cache com '-')
                    try {
                        const osIdNum = parseInt(osId, 10);
                        const qtdNum = Number.isFinite(Number(qtdResp)) ? Number(qtdResp) : NaN;
                        if (!Number.isNaN(osIdNum) && Number.isFinite(qtdNum) && window.atualizarQuantidadesPorTrabalho) {
                            // Normaliza o item como no seed: apenas o c√≥digo base antes do tra√ßo
                            const itemLabel = (itemCod || '').toString().replace(/[()]/g, '').trim();
                            const itemCodigoBase = itemLabel.replace(/\s*[-‚Äì‚Äî]\s*.*$/, '').trim();
                            const entrada = [{
                                trabalho_id: parseInt(trabalhoId, 10),
                                trabalho_nome: trabalhoNome,
                                item_codigo: itemCodigoBase,
                                ultima_quantidade: qtdNum
                            }];
                            // Limpar assinatura para garantir render
                            try {
                                const c = document.getElementById(`qtd-por-trabalho-${osIdNum}`);
                                if (c && c.dataset) delete c.dataset.qptSig;
                            } catch {}
                            window.atualizarQuantidadesPorTrabalho(osIdNum, entrada);
                            // Fallback 200ms: reintentar com lista vazia para garantir refresh em casos de atraso no DOM
                            setTimeout(() => {
                                try { if (window.atualizarQuantidadesPorTrabalho) window.atualizarQuantidadesPorTrabalho(osIdNum, []); } catch {}
                            }, 200);
                            try { console.debug('[QPT] render imediato p√≥s-salvar', { osIdNum, entrada }); } catch {}
                            try { if (window.markQptTouch) window.markQptTouch(osIdNum); } catch {}
                        }
                    } catch (eForce) { console.warn('Falha ao for√ßar render imediato da QPT:', eForce); }
                    // CORRE√á√ÉO: Atualizar campo "√öltima quantidade" no modal se estiver aberto
                    try {
                        const modal = document.getElementById('apontamentoModal');
                        const modalInstance = bootstrap.Modal.getInstance(modal);
                        if (modalInstance && qtdResp && Number.isFinite(Number(qtdResp))) {
                            // Atualizar o campo de √∫ltima quantidade no modal
                            setTimeout(() => {
                                const info = document.getElementById('ultimaQuantidadeInfo');
                                if (info && trabalhoNome) {
                                    info.textContent = `√öltima quantidade apontada para este item/trabalho: ${qtdResp}`;
                                }
                                // Atualizar placeholder do input de quantidade
                                const qtdInputModal = document.getElementById('quantidade');
                                if (qtdInputModal) {
                                    qtdInputModal.min = Math.max(0, Number(qtdResp));
                                    qtdInputModal.placeholder = `>= ${qtdResp}`;
                                }
                            }, 100);
                        }
                    } catch (eModal) { console.warn('Falha ao atualizar modal:', eModal); }
                    // Sempre recarregar estado dos apontamentos no mesmo aba (chips/bot√µes/status)
                    setTimeout(() => {
                        try { 
                            if (window.recarregarEstadoApontamentos) {
                                window.recarregarEstadoApontamentos(); 
                            }
                        } catch (e) {
                            console.warn('Erro ao recarregar estado:', e);
                        }
                    }, 100);
                    
                    // Sempre publicar broadcast para outras abas/janelas do Kanban
                    try {
                        const osIdNum = parseInt(ordemAtualId, 10);
                        if (!Number.isNaN(osIdNum)) {
                            // Normaliza item base
                            const itemLabel = (itemCod || '').toString().replace(/[()]/g, '').trim();
                            const itemCodigoBase = itemLabel.replace(/\s*[-‚Äì‚Äî]\s*.*$/, '').trim();
                            const qtdBroadcast = Number.isFinite(Number(qtdResp)) ? Number(qtdResp) : null;
                            const payload = {
                                osId: osIdNum,
                                trabalhoId: trabalhoId ? parseInt(trabalhoId, 10) : null,
                                trabalhoNome: trabalhoNome || null,
                                itemCodigoBase,
                                quantidade: qtdBroadcast,
                                ts: Date.now()
                            };
                            localStorage.setItem('apontamento_event', JSON.stringify(payload));
                        }
                    } catch {}
                } catch (eSeed) { console.warn('Falha ao semear QPT via sucesso do apontamento:', eSeed); }
                // For√ßar atualiza√ß√£o imediata da QPT no card, usando o cache atual
                try {
                    const osIdNum = parseInt(ordemAtualId, 10);
                    if (!Number.isNaN(osIdNum)) {
                        try {
                            const c = document.getElementById(`qtd-por-trabalho-${osIdNum}`);
                            if (c && c.dataset) delete c.dataset.qptSig;
                        } catch {}
                        if (window.atualizarQuantidadesPorTrabalho) {
                            window.atualizarQuantidadesPorTrabalho(osIdNum, []);
                            // Fallback 200ms: reintentar para garantir refresh
                            setTimeout(() => {
                                try { if (window.atualizarQuantidadesPorTrabalho) window.atualizarQuantidadesPorTrabalho(osIdNum, []); } catch {}
                            }, 200);
                        }
                        try { if (window.markQptTouch) window.markQptTouch(osIdNum); } catch {}
                        // Broadcast QPT update para outras abas
                        try { localStorage.setItem('apontamento_broadcast', JSON.stringify({ type: 'qpt_update', osId: osIdNum, ts: Date.now() })); } catch {}
                }
                } catch (eQptNow) { console.warn('Falha ao for√ßar refresh imediato da QPT:', eQptNow); }
                // Evitar recarregar estado aqui para n√£o duplicar QPT; j√° fizemos seed + refresh imediato
            } else {
                mostrarAlerta(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            mostrarAlerta('Erro ao registrar apontamento', 'error');
        });
    }
    
    function atualizarStatusCartao(ordemId, status) {
        // Buscar TODOS os cart√µes com essa ordem e verificar qual √© o real
        const allCards = document.querySelectorAll(`[data-ordem-id="${ordemId}"]`);
        console.debug(`[STATUS] Encontrados ${allCards.length} cart√µes para OS ${ordemId}`);
        
        let card = null;
        for (const c of allCards) {
            if (!c.classList.contains('fantasma')) {
                card = c;
                console.debug(`[STATUS] Usando cart√£o real para OS ${ordemId}`);
                break;
            }
        }
        
        if (!card) {
            console.debug(`[STATUS] Nenhum cart√£o REAL encontrado para OS ${ordemId}`);
            return;
        }
        
        // Remover classes de status anteriores
        card.classList.remove('status-setup', 'status-producao', 'status-pausado', 'status-finalizado', 'status-setup-concluido');
        
        // Adicionar classe de status atual
        let statusClass = '';
        let isActiveStatus = false;
        let bgClass = '';
        let statusText = status;
        
        switch(status) {
            case 'Setup em andamento':
                statusClass = 'status-setup';
                bgClass = 'bg-primary';
                statusText = 'Setup em andamento';
                isActiveStatus = true;
                break;
            case 'Produ√ß√£o em andamento':
                statusClass = 'status-producao';
                bgClass = 'bg-success';
                statusText = 'Produ√ß√£o em andamento';
                isActiveStatus = true;
                break;
            case 'Pausado':
                statusClass = 'status-pausado';
                bgClass = 'bg-warning';
                statusText = 'Pausado';
                isActiveStatus = false; // Pausado n√£o mant√©m timer ativo
                break;
            case 'Setup conclu√≠do':
                statusClass = 'status-setup-concluido';
                bgClass = 'bg-info';
                statusText = 'Setup conclu√≠do';
                break;
            case 'Finalizado':
                statusClass = 'status-finalizado';
                bgClass = 'bg-secondary';
                statusText = 'Finalizado';
                break;
            default:
                bgClass = 'bg-light';
                statusText = 'Aguardando apontamento';
                break;
        }
        
        // Adicionar classe de status ao card
        if (statusClass) card.classList.add(statusClass);
        
        // Atualizar o campo de status no rodap√© do card
        const statusElement = card.querySelector('.status-apontamento');
        if (statusElement) {
            const statusSmall = statusElement.querySelector('small');
            if (statusSmall) {
                statusSmall.className = '';
                statusSmall.classList.add(bgClass, 'text-white', 'p-1', 'rounded');
                statusSmall.textContent = statusText;
            }
            // A partir de agora, os timers ficam nos chips por trabalho (renderizarChipsStatus)
        }
        
        // Atualizar tamb√©m o status no modal de detalhes, se estiver aberto
        const modalStatusElement = document.getElementById(`status-modal-${ordemId}`);
        if (modalStatusElement) {
            modalStatusElement.innerHTML = `<small class="${bgClass} text-white p-1 rounded">${statusText}</small>`;
        }
        
        // Salvar o status atual no localStorage para persist√™ncia local
        try {
            const statusData = JSON.parse(localStorage.getItem('apontamento_status') || '{}');
            statusData[ordemId] = {
                status: status,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('apontamento_status', JSON.stringify(statusData));
        } catch (e) {
            console.error('Erro ao salvar status no localStorage:', e);
        }
    }

    // Remover completamente o status visual do card
    function limparStatusCartao(ordemId) {
        const card = document.querySelector(`.kanban-card[data-ordem-id="${ordemId}"]`);
        if (!card) return;
        // Antes de qualquer limpeza, semear cache QPT a partir do DOM atual (se ainda n√£o persistido)
        try {
            const qptBox = card.querySelector(`#qtd-por-trabalho-${ordemId}`);
            if (qptBox) {
                const lis = qptBox.querySelectorAll('.qpt-list .qpt-item');
                lis.forEach(li => {
                    const labelEl = li.querySelector('.qpt-label');
                    const codeEl = li.querySelector('.qpt-itemcode');
                    const qtyEl = li.querySelector('.qpt-qty');
                    // Priorizar data-attributes adicionados pela renderiza√ß√£o da QPT
                    const trabNomeData = li.getAttribute('data-trab-nome');
                    const itemCodData = li.getAttribute('data-item-cod');
                    const trabNome = (trabNomeData && trabNomeData.trim())
                        ? trabNomeData.trim()
                        : (labelEl ? labelEl.textContent.replace(/\s*\(.*\)\s*$/, '').trim() : null);
                    const itemCod = (itemCodData && itemCodData.trim())
                        ? itemCodData.trim()
                        : (codeEl ? codeEl.textContent.replace(/[()]/g, '').trim() : null);
                    const qty = qtyEl ? qtyEl.textContent.trim() : null;
                    if (window.atualizarQPTCacheEntrada && trabNome && (qty !== null && qty !== '')) {
                        window.atualizarQPTCacheEntrada(parseInt(ordemId, 10), '-', trabNome, itemCod, qty);
                    }
                });
            }
        } catch (eDomSeed) { console.warn('Falha ao semear QPT a partir do DOM antes do STOP:', eDomSeed); }
        // Remover classes de status
        card.classList.remove('status-setup', 'status-producao', 'status-pausado', 'status-finalizado', 'status-setup-concluido');
        // Limpar √°rea de status
        const statusElement = card.querySelector('.status-apontamento');
        if (statusElement) {
            // Parar e ocultar timer
            if (typeof pararTimerApontamento === 'function') {
                pararTimerApontamento(ordemId);
            }
            statusElement.innerHTML = '';
        }
        // Limpar espelho do modal, se estiver aberto
        const modalStatusElement = document.getElementById(`status-modal-${ordemId}`);
        if (modalStatusElement) {
            modalStatusElement.innerHTML = '';
        }
        // Remover persist√™ncia local do status
        try {
            const statusData = JSON.parse(localStorage.getItem('apontamento_status') || '{}');
            delete statusData[ordemId];
            localStorage.setItem('apontamento_status', JSON.stringify(statusData));
        } catch (e) {
            console.error('Erro ao limpar status no localStorage:', e);
        }
        // Garantir que a QPT permane√ßa vis√≠vel usando cache/localStorage
        try {
            const osIdNum = parseInt(ordemId, 10);
            if (window.atualizarQuantidadesPorTrabalho && !Number.isNaN(osIdNum)) {
                console.debug('[QPT] STOP -> refresh imediato', { osIdNum });
                window.atualizarQuantidadesPorTrabalho(osIdNum, []);
                try { if (window.markQptTouch) window.markQptTouch(osIdNum); } catch {}
            }
        } catch (eQPT) {
            console.warn('Falha ao refrescar QPT ap√≥s STOP:', eQPT);
        }
    }
    
    function mostrarAlerta(mensagem, tipo) {
        const alertClass = tipo === 'success' ? 'alert-success' : 'alert-danger';
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        const container = document.querySelector('.container-fluid');
        container.insertAdjacentHTML('afterbegin', alertHtml);
        
        // Auto-remover ap√≥s 5 segundos
        setTimeout(() => {
            const alert = container.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    }
    
    // Fun√ß√µes intermedi√°rias para evitar problemas de sintaxe
    function iniciarApontamentoSetup(ordemId) {
        abrirModalApontamento('inicio_setup', ordemId);
    }
    
    function iniciarApontamentoProducao(ordemId) {
        abrirModalApontamento('inicio_producao', ordemId);
    }
    
    function pausarApontamento(ordemId) {
        abrirModalApontamento('pausa', ordemId);
    }
    
    function pararApontamento(ordemId) {
        abrirModalApontamento('stop', ordemId);
    }
    
    function finalizarSetup(ordemId) {
        abrirModalApontamento('fim_setup', ordemId);
    }
    
    function finalizarProducao(ordemId) {
        abrirModalApontamento('fim_producao', ordemId);
    }
    
    // Fun√ß√£o para criar cart√£o fantasma rapidamente
    function criarCartaoFantasmaRapido(ordemId, listaOrigem) {
        console.log('Clicou no bot√£o fantasma! OS:', ordemId, 'Lista:', listaOrigem);
        
        // Popular o select com todas as ordens dispon√≠veis
        popularSelectOrdens().then(() => {
            // Mostrar modal simplificado com OS pr√©-selecionada
            const modal = new bootstrap.Modal(document.getElementById('criarFantasmaModal'));
            
            // Pr√©-selecionar a OS (usar o ID correto do select)
            const selectOS = document.getElementById('ordemSelect');
            if (selectOS) {
                selectOS.value = ordemId;
                // Disparar evento change se necess√°rio para carregar trabalhos
                selectOS.dispatchEvent(new Event('change'));
            }
            
            // Definir lista origem no t√≠tulo do modal
            const modalTitle = document.querySelector('#criarFantasmaModal .modal-title');
            if (modalTitle) {
                modalTitle.innerHTML = `<i class="fas fa-ghost text-purple"></i> Criar Cart√£o Fantasma - OS #${ordemId}`;
            }
            
            // Configurar posi√ß√£o autom√°tica baseada em cart√µes fantasma existentes
            configurarPosicaoAutomatica();
            
            modal.show();
        });
    }
    
    // Fun√ß√£o para configurar posi√ß√£o autom√°tica
    function configurarPosicaoAutomatica() {
        const selectLista = document.getElementById('listaSelect');
        const inputPosicao = document.querySelector('[name="posicao_fila"]');
        
        if (selectLista && inputPosicao) {
            // Listener para quando a lista destino mudar
            selectLista.addEventListener('change', function() {
                const listaDestino = this.value;
                if (listaDestino) {
                    // Contar cart√µes fantasma existentes nesta lista
                    const cartoesFantasma = document.querySelectorAll(`.kanban-card.fantasma[data-lista="${listaDestino}"]`);
                    const proximaPosicao = cartoesFantasma.length + 1;
                    
                    inputPosicao.value = proximaPosicao;
                    console.log(`Lista ${listaDestino}: ${cartoesFantasma.length} fantasmas existentes, sugerindo posi√ß√£o ${proximaPosicao}`);
                }
            });
            
            // Disparar evento change se j√° tiver lista selecionada
            if (selectLista.value) {
                selectLista.dispatchEvent(new Event('change'));
            }
        }
    }
    
    // Fun√ß√£o para popular o select de ordens
    function popularSelectOrdens() {
        return new Promise((resolve) => {
            const selectOS = document.getElementById('ordemSelect');
            if (!selectOS) {
                resolve();
                return;
            }
            
            // Limpar select
            selectOS.innerHTML = '<option value="">Selecione uma OS...</option>';
            
            // Coletar todas as ordens da p√°gina
            const cartoes = document.querySelectorAll('.kanban-card[data-ordem-id]');
            const ordensAdicionadas = new Set();
            
            cartoes.forEach(cartao => {
                const ordemId = cartao.dataset.ordemId;
                const titulo = cartao.querySelector('.card-title');
                if (ordemId && titulo && !ordensAdicionadas.has(ordemId)) {
                    const option = document.createElement('option');
                    option.value = ordemId;
                    option.textContent = titulo.textContent.trim();
                    selectOS.appendChild(option);
                    ordensAdicionadas.add(ordemId);
                }
            });
            
            resolve();
        });
    }
    
    // Fun√ß√£o de teste para debug
    function testarBotaoFantasma() {
        console.log('=== TESTE BOT√ÉO FANTASMA ===');
        const botoes = document.querySelectorAll('.btn-criar-fantasma-direto');
        console.log('Bot√µes encontrados:', botoes.length);
        
        botoes.forEach((btn, i) => {
            console.log(`Bot√£o ${i}:`, btn, 'OS:', btn.dataset.ordemId);
            
            // Adicionar evento de teste direto
            btn.onclick = function(e) {
                console.log('ONCLICK FUNCIONOU! OS:', this.dataset.ordemId);
                criarCartaoFantasmaRapido(this.dataset.ordemId, this.dataset.listaOrigem);
            };
        });
        
        return botoes.length;
    }
    
    // Executar teste quando carregado
    setTimeout(function() {
        console.log('Executando teste autom√°tico...');
        testarBotaoFantasma();
        configurarBotaoConfirmarFantasma();
    }, 2000);
    
    // Configurar bot√µes de a√ß√£o dos cart√µes fantasma
    function configurarBotoesFantasma() {
        console.log('Configurando bot√µes de a√ß√£o dos cart√µes fantasma...');
        
        // Bot√µes de remover fantasma
        document.querySelectorAll('.btn-remover-fantasma').forEach(function(btn) {
            if (!btn.classList.contains('events-initialized')) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const cartaoId = this.dataset.cartaoId;
                    console.log('Removendo cart√£o fantasma:', cartaoId);
                    removerCartaoFantasma(cartaoId);
                });
                btn.classList.add('events-initialized');
                console.log('‚úÖ Bot√£o remover configurado para cart√£o:', btn.dataset.cartaoId);
            }
        });
        
        // Bot√µes de mover fantasma
        document.querySelectorAll('.btn-mover-fantasma').forEach(function(btn) {
            if (!btn.classList.contains('events-initialized')) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const cartaoId = this.dataset.cartaoId;
                    console.log('Movendo cart√£o fantasma:', cartaoId);
                    abrirModalMoverFantasma(cartaoId);
                });
                btn.classList.add('events-initialized');
                console.log('‚úÖ Bot√£o mover configurado para cart√£o:', btn.dataset.cartaoId);
            }
        });
        
        // Bot√µes de detalhes fantasma
        document.querySelectorAll('.btn-detalhes-fantasma').forEach(function(btn) {
            if (!btn.classList.contains('events-initialized')) {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const ordemId = this.dataset.ordemId;
                    console.log('Abrindo detalhes da OS:', ordemId);
                    openCardDetails(ordemId);
                });
                btn.classList.add('events-initialized');
                console.log('‚úÖ Bot√£o detalhes configurado para OS:', btn.dataset.ordemId);
            }
        });
    }
    
    // Fun√ß√£o para remover cart√£o fantasma
    function removerCartaoFantasma(cartaoId) {
        console.log('üóëÔ∏è Tentando remover cart√£o fantasma ID:', cartaoId);
        // Removendo confirma√ß√£o temporariamente para teste
        // if (confirm('Tem certeza que deseja remover este cart√£o fantasma?')) {
        if (true) {
            console.log('‚úÖ Prosseguindo com remo√ß√£o (sem confirma√ß√£o para teste)');
            
            fetch(`/cartao-fantasma/remover/${cartaoId}`, {
                method: 'POST'
            })
            .then(response => {
                console.log('üì° Status da resposta:', response.status, response.statusText);
                console.log('üì° Headers da resposta:', Object.fromEntries(response.headers));
                return response.text().then(text => {
                    console.log('üì° Texto bruto da resposta:', text);
                    try {
                        return JSON.parse(text);
                    } catch (e) {
                        console.error('‚ùå Erro ao fazer parse JSON:', e);
                        throw new Error('Resposta n√£o √© JSON v√°lido: ' + text);
                    }
                });
            })
            .then(data => {
                console.log('üì° Dados parseados da resposta:', data);
                if (data.success) {
                    console.log('‚úÖ Remo√ß√£o bem-sucedida no backend');
                    alert('Cart√£o fantasma removido com sucesso!');
                    window.location.reload();
                } else {
                    console.error('‚ùå Erro no backend:', data.message);
                    alert('Erro ao remover cart√£o fantasma: ' + data.message);
                }
            })
            .catch(error => {
                console.error('‚ùå Erro na requisi√ß√£o completa:', error);
                alert('Erro ao remover cart√£o fantasma: ' + error.message);
            });
        } else {
            console.log('‚ùå Usu√°rio cancelou remo√ß√£o');
        }
    }
    
    // Fun√ß√£o para abrir modal de mover fantasma
    function abrirModalMoverFantasma(cartaoId) {
        const modal = new bootstrap.Modal(document.getElementById('moverFantasmaModal'));
        
        // Definir ID do cart√£o no campo oculto
        const inputCartaoId = document.getElementById('cartaoIdMover');
        if (inputCartaoId) {
            inputCartaoId.value = cartaoId;
        }
        
        // Resetar posi√ß√£o para 1
        const inputPosicao = document.getElementById('novaPosicao');
        if (inputPosicao) {
            inputPosicao.value = 1;
        }
        
        modal.show();
        
        // Configurar bot√£o de confirmar se ainda n√£o foi configurado
        const btnConfirmar = document.getElementById('btnConfirmarMoverFantasma');
        if (btnConfirmar && !btnConfirmar.classList.contains('events-initialized')) {
            btnConfirmar.addEventListener('click', function() {
                moverCartaoFantasma();
            });
            btnConfirmar.classList.add('events-initialized');
        }
    }
    
    // Fun√ß√£o para mover cart√£o fantasma
    function moverCartaoFantasma() {
        const form = document.getElementById('formMoverFantasma');
        const formData = new FormData(form);
        
        console.log('üîÑ Movendo cart√£o fantasma:', Object.fromEntries(formData));
        
        fetch('/cartao-fantasma/mover', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('üì° Status da resposta (mover):', response.status, response.statusText);
            console.log('üì° Headers da resposta (mover):', Object.fromEntries(response.headers));
            return response.text().then(text => {
                console.log('üì° Texto bruto da resposta (mover):', text);
                try {
                    return JSON.parse(text);
                } catch (e) {
                    console.error('‚ùå Erro ao fazer parse JSON (mover):', e);
                    throw new Error('Resposta n√£o √© JSON v√°lido: ' + text);
                }
            });
        })
        .then(data => {
            console.log('üì° Dados parseados da resposta (mover):', data);
            if (data.success) {
                console.log('‚úÖ Movimento bem-sucedido no backend');
                const modal = bootstrap.Modal.getInstance(document.getElementById('moverFantasmaModal'));
                modal.hide();
                alert('Posi√ß√£o do cart√£o fantasma alterada!');
                window.location.reload();
            } else {
                console.error('‚ùå Erro no backend (mover):', data.message);
                alert('Erro ao mover cart√£o fantasma: ' + data.message);
            }
        })
        .catch(error => {
            console.error('‚ùå Erro na requisi√ß√£o completa (mover):', error);
            alert('Erro ao mover cart√£o fantasma: ' + error.message);
        });
    }
    
    // Configurar bot√£o de confirmar cria√ß√£o do fantasma
    function configurarBotaoConfirmarFantasma() {
        const btnConfirmar = document.getElementById('btnConfirmarFantasma');
        if (btnConfirmar) {
            console.log('Configurando bot√£o confirmar fantasma');
            btnConfirmar.addEventListener('click', function() {
                console.log('Clicou em confirmar fantasma');
                criarCartaoFantasma();
            });
        } else {
            console.error('Bot√£o confirmar fantasma n√£o encontrado!');
        }
    }
    
    // Fun√ß√£o para criar o cart√£o fantasma
    function criarCartaoFantasma() {
        const form = document.getElementById('formCriarFantasma');
        const formData = new FormData(form);
        
        console.log('Enviando dados do cart√£o fantasma:', Object.fromEntries(formData));
        
        fetch('/cartao-fantasma/criar', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('Resposta do servidor:', data);
            if (data.success) {
                // Fechar modal e recarregar p√°gina
                const modal = bootstrap.Modal.getInstance(document.getElementById('criarFantasmaModal'));
                modal.hide();
                
                // Mostrar sucesso e recarregar estado sem reload completo
                alert('Cart√£o fantasma criado com sucesso!');
                
                // Em vez de reload completo, recarregar apenas o estado dos apontamentos
                try {
                    if (typeof window.recarregarEstadoApontamentos === 'function') {
                        window.recarregarEstadoApontamentos();
                    }
                    // For√ßar atualiza√ß√£o do kanban recarregando a p√°gina ap√≥s pequeno delay
                    // para permitir que o backend processe o novo cart√£o fantasma
                    setTimeout(() => {
                        window.location.reload();
                    }, 100);
                } catch (e) {
                    console.warn('Erro ao recarregar estado, fazendo reload completo:', e);
                    window.location.reload();
                }
            } else {
                alert('Erro ao criar cart√£o fantasma: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('Erro ao criar cart√£o fantasma');
        });
    }
    </script>

</body>
</html>
